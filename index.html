<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FOG - Friends of Golf</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --pink-hot: #ff3da7;
    --pink-bright: #ff6fbf;
    --pink-light: #ff77c4;
    --pink-pale: #ffb8e0;
    --pink-deep: #e6007e;
    --dark: #0f0a10;
    --dark-card: #1a0e18;
    --dark-mid: #2d1228;
    --white: #ffffff;
    --white-soft: #fff0f7;
    --gray: #c090ad;
    --green-good: #00e676;
    --red-bad: #ff5252;
    --gold: #ffd700;
    --silver: #c0c0c0;
    --bronze: #cd7f32;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Space Grotesk', sans-serif;
    background: var(--dark);
    min-height: 100vh;
    color: var(--white);
    background-image:
      radial-gradient(ellipse at 15% 5%, rgba(255,61,167,0.25) 0%, transparent 50%),
      radial-gradient(ellipse at 85% 95%, rgba(255,61,167,0.18) 0%, transparent 50%),
      radial-gradient(ellipse at 50% 50%, rgba(230,0,126,0.1) 0%, transparent 60%);
  }

  /* HEADER */
  .header {
    text-align: center;
    padding: 40px 20px 10px;
    position: relative;
  }
  .header h1 {
    font-family: 'Outfit', sans-serif;
    font-size: clamp(3rem, 10vw, 5.5rem);
    font-weight: 900;
    background: linear-gradient(135deg, var(--pink-hot), var(--pink-light), var(--pink-hot));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: 0.15em;
    line-height: 1;
    text-shadow: none;
    filter: drop-shadow(0 0 40px rgba(255,61,167,0.6)) drop-shadow(0 0 80px rgba(255,61,167,0.3));
  }
  .header .subtitle {
    font-size: 0.9rem;
    color: var(--pink-light);
    letter-spacing: 0.35em;
    text-transform: uppercase;
    margin-top: 6px;
    font-weight: 400;
  }
  .header .golf-icon {
    font-size: 2rem;
    margin-bottom: 6px;
  }

  /* NAV */
  .nav-tabs {
    display: flex;
    justify-content: center;
    gap: 4px;
    padding: 20px 20px 24px;
    flex-wrap: wrap;
  }
  .nav-tab {
    padding: 10px 22px;
    border: 2px solid rgba(255,61,167,0.3);
    background: transparent;
    color: var(--pink-light);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 0.82rem;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 50px;
    transition: all 0.25s;
  }
  .nav-tab:hover {
    border-color: var(--pink-hot);
    color: var(--white);
    background: rgba(255,61,167,0.1);
  }
  .nav-tab.active {
    background: var(--pink-hot);
    color: var(--white);
    border-color: var(--pink-hot);
    box-shadow: 0 0 25px rgba(255,61,167,0.5), 0 0 50px rgba(255,61,167,0.2);
  }
  .nav-tab.editor-only { display: none; }
  body.editor-mode .nav-tab.editor-only { display: inline-block; }

  /* MODE BAR */
  .mode-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    padding: 6px 20px 4px;
  }
  .mode-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 14px;
    border-radius: 20px;
    font-size: 0.72rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-weight: 700;
  }
  .mode-viewer { background: rgba(255,255,255,0.08); color: var(--gray); border: 1px solid rgba(255,255,255,0.15); }
  .mode-editor { background: rgba(255,61,167,0.2); color: var(--pink-light); border: 1px solid rgba(255,61,167,0.5); }
  .mode-dot { width: 7px; height: 7px; border-radius: 50%; }
  .mode-viewer .mode-dot { background: var(--gray); }
  .mode-editor .mode-dot { background: var(--pink-hot); box-shadow: 0 0 6px var(--pink-hot); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
  .lock-btn {
    padding: 5px 14px;
    border: 1px solid rgba(255,61,167,0.3);
    background: transparent;
    color: var(--gray);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 20px;
    transition: all 0.2s;
    font-weight: 600;
  }
  .lock-btn:hover { border-color: var(--pink-hot); color: var(--pink-light); }

  /* CONTAINER */
  .container { max-width: 1100px; margin: 0 auto; padding: 0 20px 60px; }
  .panel { display: none; }
  .panel.active { display: block; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

  /* CARDS */
  .card {
    background: linear-gradient(135deg, rgba(255,61,167,0.06), rgba(255,61,167,0.02));
    border: 1px solid rgba(255,61,167,0.2);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 22px;
    backdrop-filter: blur(8px);
  }
  .card-title {
    font-family: 'Outfit', sans-serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--pink-hot);
    margin-bottom: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .card-title::before {
    content: '';
    display: inline-block;
    width: 4px;
    height: 22px;
    background: linear-gradient(180deg, var(--pink-hot), var(--pink-deep));
    border-radius: 2px;
  }

  /* VENMO BANNER */
  .venmo-banner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 14px;
    padding: 16px 24px;
    background: linear-gradient(135deg, rgba(255,61,167,0.15), rgba(230,0,126,0.1));
    border: 1px solid rgba(255,61,167,0.3);
    border-radius: 50px;
    margin: 0 auto 10px;
    max-width: 500px;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    color: var(--white);
  }
  .venmo-banner:hover {
    background: linear-gradient(135deg, rgba(255,61,167,0.3), rgba(230,0,126,0.25));
    border-color: var(--pink-hot);
    box-shadow: 0 0 30px rgba(255,61,167,0.4), 0 0 60px rgba(255,61,167,0.15);
    transform: translateY(-2px);
  }
  .venmo-banner .venmo-text {
    font-weight: 700;
    font-size: 0.95rem;
    letter-spacing: 0.05em;
  }
  .venmo-banner .venmo-sub {
    font-size: 0.75rem;
    color: var(--pink-light);
  }

  /* THIS WEEK HERO */
  .this-week-hero {
    background: linear-gradient(135deg, rgba(255,61,167,0.12), rgba(230,0,126,0.08));
    border: 1px solid rgba(255,61,167,0.3);
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 22px;
    text-align: center;
  }
  .this-week-hero h2 {
    font-family: 'Outfit', sans-serif;
    font-size: 1.6rem;
    font-weight: 800;
    color: var(--pink-hot);
    margin-bottom: 6px;
  }
  .this-week-hero .course-name {
    font-size: 1.2rem;
    color: var(--white);
    margin-bottom: 4px;
    font-weight: 600;
  }
  .this-week-hero .course-details {
    font-size: 0.88rem;
    color: var(--pink-light);
    margin-bottom: 14px;
  }
  .this-week-hero .course-details span {
    margin: 0 8px;
  }
  .rsvp-count-display {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 20px;
    background: rgba(255,61,167,0.15);
    border-radius: 50px;
    font-size: 0.88rem;
    color: var(--pink-light);
    font-weight: 600;
    margin-top: 8px;
  }
  .rsvp-count-display .count-num {
    font-size: 1.3rem;
    color: var(--pink-hot);
    font-weight: 800;
    font-family: 'Outfit', sans-serif;
  }

  /* RSVP */
  .rsvp-section { margin-top: 18px; }
  .rsvp-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 14px;
  }
  .rsvp-chip {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,61,167,0.15);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 0.88rem;
    transition: all 0.2s;
  }
  .rsvp-chip.rsvp-yes {
    border-color: rgba(0,230,118,0.4);
    background: rgba(0,230,118,0.08);
  }
  .rsvp-chip.rsvp-no {
    border-color: rgba(255,82,82,0.3);
    background: rgba(255,82,82,0.05);
    opacity: 0.6;
  }
  .rsvp-status {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 3px 10px;
    border-radius: 20px;
    cursor: pointer;
    border: none;
    font-family: 'Space Grotesk', sans-serif;
  }
  .rsvp-in { background: var(--green-good); color: var(--dark); }
  .rsvp-out { background: rgba(255,82,82,0.3); color: #ff8a8a; }
  .rsvp-pending { background: rgba(255,255,255,0.15); color: var(--gray); }
  .rsvp-paid { background: var(--green-good); color: var(--dark); font-size: 0.62rem; }
  .rsvp-unpaid { background: rgba(255,82,82,0.3); color: #ff8a8a; font-size: 0.62rem; }
  .rsvp-chip .chip-actions { display: flex; align-items: center; gap: 4px; }
  .rsvp-chip .paid-badge { font-size: 0.6rem; color: var(--green-good); font-weight: 700; letter-spacing: 0.08em; }

  /* DEADLINE COUNTDOWN */
  .deadline-pill {
    display: inline-flex; align-items: center; gap: 8px;
    margin-top: 10px; padding: 8px 20px;
    background: rgba(255,61,167,0.1); border: 1px solid rgba(255,61,167,0.3);
    border-radius: 50px;
  }
  .deadline-pill .dl-label {
    font-size: 0.72rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--pink-light);
  }
  .deadline-pill .dl-time {
    font-family: 'Outfit', sans-serif; font-size: 1.1rem; color: var(--pink-hot); font-weight: 700;
  }
  .deadline-locked {
    display: inline-flex; align-items: center; gap: 6px;
    margin-top: 10px; padding: 8px 20px;
    background: rgba(255,82,82,0.12); border: 1px solid rgba(255,82,82,0.4);
    border-radius: 50px; color: var(--red-bad); font-weight: 700; font-size: 0.85rem;
  }

  /* ADMIN SUMMARY */
  .editor-only-card { display: none !important; }
  body.editor-mode .editor-only-card { display: block !important; }
  .summary-col-header { font-weight: 700; margin-bottom: 8px; font-size: 0.85rem; }
  .summary-player { display: flex; align-items: center; gap: 6px; padding: 3px 0; font-size: 0.85rem; }
  .summary-badge { font-size: 0.6rem; font-weight: 700; letter-spacing: 0.05em; padding: 1px 6px; border-radius: 8px; }
  .summary-badge-paid { background: rgba(0,230,118,0.15); color: var(--green-good); }
  .summary-badge-unpaid { background: rgba(255,82,82,0.15); color: #ff8a8a; }

  /* FORMS */
  .form-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 10px; }
  label {
    display: block;
    font-size: 0.72rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--pink-light);
    margin-bottom: 5px;
    font-weight: 600;
  }
  input, select, textarea {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,61,167,0.25);
    color: var(--white);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 0.88rem;
    padding: 10px 14px;
    border-radius: 10px;
    outline: none;
    transition: all 0.2s;
    width: 100%;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--pink-hot);
    background: rgba(255,61,167,0.08);
    box-shadow: 0 0 12px rgba(255,61,167,0.15);
  }
  select option { background: var(--dark); color: var(--white); }
  input::placeholder, textarea::placeholder { color: rgba(255,255,255,0.25); }
  input:disabled, select:disabled, textarea:disabled { opacity: 0.5; cursor: not-allowed; }
  .form-group { flex: 1; min-width: 130px; }
  .form-group.wide { min-width: 200px; flex: 2; }

  /* BUTTONS */
  .btn {
    padding: 10px 24px;
    border: none;
    border-radius: 50px;
    font-family: 'Space Grotesk', sans-serif;
    font-size: 0.82rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.25s;
    white-space: nowrap;
  }
  .btn-pink {
    background: linear-gradient(135deg, var(--pink-hot), var(--pink-deep));
    color: var(--white);
    box-shadow: 0 4px 18px rgba(255,61,167,0.4), 0 0 40px rgba(255,61,167,0.15);
  }
  .btn-pink:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px rgba(255,61,167,0.6), 0 0 60px rgba(255,61,167,0.25);
  }
  .btn-pink:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
  .btn-outline {
    background: transparent;
    border: 2px solid rgba(255,61,167,0.4);
    color: var(--pink-light);
  }
  .btn-outline:hover { border-color: var(--pink-hot); background: rgba(255,61,167,0.1); }
  .btn-danger {
    background: transparent;
    border: 1px solid rgba(255,82,82,0.4);
    color: #ff8a8a;
    font-size: 0.7rem;
    padding: 5px 10px;
    border-radius: 50px;
  }
  .btn-danger:hover { background: rgba(255,82,82,0.15); border-color: #ff5252; }

  /* TABLES */
  .score-table-wrap { overflow-x: auto; border-radius: 12px; }
  table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
  th {
    background: rgba(255,61,167,0.12);
    color: var(--pink-hot);
    font-family: 'Outfit', sans-serif;
    font-weight: 700;
    padding: 12px 14px;
    text-align: left;
    border-bottom: 1px solid rgba(255,61,167,0.2);
    white-space: nowrap;
    font-size: 0.8rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  td { padding: 11px 14px; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--white); vertical-align: middle; }
  tr:hover td { background: rgba(255,61,167,0.04); }
  tr.leader td { background: rgba(255,61,167,0.08); }

  /* RANK BADGES */
  .rank-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-weight: 800;
    font-size: 0.75rem;
    font-family: 'Outfit', sans-serif;
  }
  .rank-1 { background: var(--gold); color: var(--dark); }
  .rank-2 { background: var(--silver); color: var(--dark); }
  .rank-3 { background: var(--bronze); color: var(--white); }
  .rank-other { background: rgba(255,255,255,0.1); color: var(--gray); }

  /* SCORE PILLS */
  .score-pill { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.78rem; font-weight: 700; }
  .score-under { background: rgba(0,230,118,0.15); color: var(--green-good); }
  .score-even  { background: rgba(255,215,0,0.15); color: var(--gold); }
  .score-over  { background: rgba(255,82,82,0.15); color: var(--red-bad); }

  /* STANDINGS META */
  .standings-meta { display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 20px; }
  .meta-stat {
    background: linear-gradient(135deg, rgba(255,61,167,0.08), rgba(255,61,167,0.03));
    border: 1px solid rgba(255,61,167,0.2);
    border-radius: 12px;
    padding: 14px 20px;
    text-align: center;
    flex: 1;
    min-width: 110px;
  }
  .meta-stat .val {
    font-family: 'Outfit', sans-serif;
    font-size: 1.8rem;
    color: var(--pink-hot);
    font-weight: 800;
    line-height: 1;
  }
  .meta-stat .lbl {
    font-size: 0.68rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--pink-light);
    margin-top: 4px;
    font-weight: 600;
  }

  /* WEEK PILLS */
  .week-pills { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 18px; }
  .week-pill {
    padding: 7px 16px;
    border: 1px solid rgba(255,61,167,0.25);
    background: transparent;
    color: var(--gray);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 0.78rem;
    font-weight: 600;
    cursor: pointer;
    border-radius: 50px;
    transition: all 0.2s;
  }
  .week-pill:hover { border-color: var(--pink-hot); color: var(--pink-light); }
  .week-pill.active { background: var(--pink-hot); color: var(--white); border-color: var(--pink-hot); }

  /* PLAYERS */
  .player-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 14px; }
  .player-chip {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,61,167,0.15);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 0.88rem;
    transition: all 0.2s;
  }
  .player-chip:hover { border-color: rgba(255,61,167,0.4); }
  .player-num { font-size: 0.7rem; color: var(--pink-hot); font-weight: 700; margin-right: 6px; min-width: 18px; }

  /* SCORE ENTRY */
  .score-input-cell input {
    width: 70px;
    padding: 6px 8px;
    font-size: 0.85rem;
    text-align: center;
    border-radius: 8px;
  }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 36px;
    color: rgba(255,255,255,0.25);
    font-style: italic;
    font-size: 0.9rem;
  }
  .flag { font-size: 0.7rem; color: var(--pink-hot); letter-spacing: 0.1em; font-weight: 600; }

  /* SCHEDULE CARD */
  .schedule-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,61,167,0.12);
    border-radius: 12px;
    margin-bottom: 10px;
    transition: all 0.2s;
  }
  .schedule-item:hover { border-color: rgba(255,61,167,0.3); }
  .schedule-week-num {
    font-family: 'Outfit', sans-serif;
    font-size: 1.4rem;
    font-weight: 800;
    color: var(--pink-hot);
    min-width: 50px;
    text-align: center;
  }
  .schedule-info { flex: 1; }
  .schedule-info .course { font-weight: 600; font-size: 0.95rem; }
  .schedule-info .details { font-size: 0.78rem; color: var(--gray); margin-top: 2px; }
  .schedule-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .badge-upcoming { background: rgba(255,61,167,0.2); color: var(--pink-hot); }
  .badge-completed { background: rgba(0,230,118,0.15); color: var(--green-good); }
  .badge-current { background: var(--pink-hot); color: var(--white); animation: pulse 2s infinite; }

  /* MODAL */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(26,10,18,0.9);
    backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center;
    z-index: 200;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--dark-card);
    border: 1px solid rgba(255,61,167,0.4);
    border-radius: 20px;
    padding: 38px;
    width: 100%;
    max-width: 400px;
    text-align: center;
    transform: translateY(20px);
    transition: transform 0.25s;
    box-shadow: 0 20px 60px rgba(255,61,167,0.3), 0 0 100px rgba(255,61,167,0.1);
  }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal h2 { font-family: 'Outfit', sans-serif; color: var(--pink-hot); font-size: 1.5rem; font-weight: 800; margin-bottom: 8px; }
  .modal p { font-size: 0.85rem; color: var(--gray); margin-bottom: 22px; line-height: 1.6; }
  .modal input { text-align: center; letter-spacing: 0.2em; font-size: 1rem; margin-bottom: 12px; }
  .modal-actions { display: flex; gap: 10px; justify-content: center; }
  .modal-error { color: var(--red-bad); font-size: 0.78rem; margin-bottom: 10px; min-height: 18px; }

  /* LOADING & TOAST */
  .loading-bar {
    position: fixed; top: 0; left: 0; right: 0; height: 3px;
    background: linear-gradient(90deg, var(--dark), var(--pink-hot), var(--pink-light), var(--pink-hot), var(--dark));
    background-size: 200%;
    animation: shimmer 1.5s infinite;
    z-index: 300;
    display: none;
  }
  .loading-bar.show { display: block; }
  @keyframes shimmer { 0%{background-position:100%} 100%{background-position:-100%} }
  .toast {
    position: fixed; bottom: 24px; right: 24px;
    background: var(--dark-card);
    border: 1px solid var(--pink-hot);
    color: var(--white);
    padding: 14px 22px;
    border-radius: 12px;
    font-size: 0.85rem;
    box-shadow: 0 8px 30px rgba(255,61,167,0.3);
    z-index: 100;
    transform: translateY(80px); opacity: 0;
    transition: all 0.3s;
    font-weight: 600;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* RESPONSIVE */
  @media (max-width: 600px) {
    .card { padding: 18px; border-radius: 12px; }
    th, td { padding: 8px 10px; }
    .this-week-hero { padding: 20px; }
    .header h1 { font-size: clamp(2.5rem, 10vw, 5.5rem); }
    .venmo-banner { flex-direction: column; gap: 6px; text-align: center; padding: 14px 20px; }
    .schedule-item { flex-direction: column; text-align: center; gap: 8px; }
  }
</style>
</head>
<body>

<div class="loading-bar" id="loading-bar"></div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <h2>Editor Access</h2>
    <p>Enter the league admin password to manage players, scores, and schedule.</p>
    <input type="password" id="modal-pw" placeholder="Password" onkeydown="if(event.key==='Enter')submitPassword()">
    <div class="modal-error" id="modal-error"></div>
    <div class="modal-actions">
      <button class="btn btn-pink" onclick="submitPassword()">Unlock</button>
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="header">
  <div class="golf-icon">&#9971;</div>
  <h1>FOG</h1>
  <div class="subtitle">Friends of Golf</div>
</div>

<div style="padding: 8px 20px;">
  <a class="venmo-banner" id="venmo-link" href="https://venmo.com/Jami-Andregg" target="_blank" rel="noopener">
    <span style="font-size:1.4rem">&#128176;</span>
    <div>
      <div class="venmo-text">Pay League Dues via Venmo</div>
      <div class="venmo-sub">Tap to open Venmo</div>
    </div>
    <span style="font-size:1.1rem">&#8594;</span>
  </a>
</div>

<div class="mode-bar">
  <div class="mode-badge mode-viewer" id="mode-badge">
    <span class="mode-dot"></span>
    <span id="mode-label">View Only</span>
  </div>
  <button class="lock-btn" id="lock-btn" onclick="handleLockBtn()">Admin Login</button>
</div>

<div class="nav-tabs">
  <button class="nav-tab active"       onclick="showPanel('home',this)">This Week</button>
  <button class="nav-tab"              onclick="showPanel('standings',this)">Standings</button>
  <button class="nav-tab"              onclick="showPanel('history',this)">Scores</button>
  <button class="nav-tab"              onclick="showPanel('schedule',this)">Schedule</button>
  <button class="nav-tab"              onclick="showPanel('past-seasons',this)">Past Seasons</button>
  <button class="nav-tab editor-only"  onclick="showPanel('scores',this)">Enter Scores</button>
  <button class="nav-tab editor-only"  onclick="showPanel('players',this)">Players</button>
  <button class="nav-tab editor-only"  onclick="showPanel('manage-week',this)">Manage Week</button>
</div>

<div class="container">

  <!-- THIS WEEK / RSVP PANEL -->
  <div id="panel-home" class="panel active">
    <div class="this-week-hero" id="this-week-hero">
      <h2>This Week's Round</h2>
      <div class="course-name" id="tw-course">No course set yet</div>
      <div class="course-details" id="tw-details"></div>
      <div class="rsvp-count-display" id="tw-rsvp-count"></div>
      <div id="rsvp-deadline-display"></div>
    </div>

    <div class="card">
      <div class="card-title">RSVP for This Week</div>
      <p style="font-size:0.85rem;color:var(--gray);margin-bottom:16px">Tap your name to toggle your RSVP status.</p>
      <div class="rsvp-grid" id="rsvp-list">
        <div class="empty-state" style="grid-column:1/-1">No players yet. Admin must add players first.</div>
      </div>
    </div>

    <!-- Admin RSVP Summary (visible only in editor mode) -->
    <div class="card editor-only-card" id="admin-rsvp-summary">
      <div class="card-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
        <span>RSVP Summary</span>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-outline" style="font-size:0.7rem;padding:6px 14px" onclick="sendRSVPEmail()">Email Summary</button>
        </div>
      </div>
      <div id="admin-summary-content"></div>
    </div>
  </div>

  <!-- STANDINGS PANEL -->
  <div id="panel-standings" class="panel">
    <div id="standings-meta" class="standings-meta"></div>
    <div class="card">
      <div class="card-title">Season Standings</div>
      <div class="score-table-wrap">
        <table>
          <thead><tr><th>#</th><th>Player</th><th>Rounds</th><th>Total</th><th>Avg</th><th>Best</th><th>vs Par</th></tr></thead>
          <tbody id="standings-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- HISTORY PANEL -->
  <div id="panel-history" class="panel">
    <div class="card">
      <div class="card-title">Week-by-Week Scores</div>
      <div class="week-pills" id="week-pills"></div>
      <div id="history-content"><div class="empty-state">No scores saved yet.</div></div>
    </div>
  </div>

  <!-- SCHEDULE PANEL -->
  <div id="panel-schedule" class="panel">
    <div class="card">
      <div class="card-title">Season Schedule</div>
      <div id="schedule-list">
        <div class="empty-state">No schedule set yet. Admin can add course info each week.</div>
      </div>
    </div>
  </div>

  <!-- PAST SEASONS PANEL -->
  <div id="panel-past-seasons" class="panel">
    <div class="card">
      <div class="card-title">Past Seasons</div>
      <div class="week-pills" id="season-pills"></div>
      <div id="past-season-content"><div class="empty-state">Select a season above.</div></div>
    </div>
  </div>

  <!-- ENTER SCORES PANEL (editor) -->
  <div id="panel-scores" class="panel">
    <div class="card">
      <div class="card-title">Select Week &amp; Course</div>
      <div class="form-row">
        <div class="form-group">
          <label>Week</label>
          <select id="week-select" onchange="renderScoreEntry()"></select>
        </div>
        <div class="form-group">
          <label>Par</label>
          <input type="number" id="par-input" value="72" min="60" max="80" style="width:90px">
        </div>
        <div class="form-group wide">
          <label>Course Name</label>
          <input type="text" id="course-input" placeholder="e.g. Pebble Beach...">
        </div>
        <div style="padding-bottom:1px">
          <button class="btn btn-pink" id="save-scores-btn" onclick="saveScores()">Save Scores</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Score Entry</div>
      <div id="score-entry-area"><div class="empty-state">Add players first, then enter scores here.</div></div>
    </div>
  </div>

  <!-- PLAYERS PANEL (editor) -->
  <div id="panel-players" class="panel">
    <div class="card">
      <div class="card-title">Add Players</div>
      <div class="form-row">
        <div class="form-group wide">
          <label>Player Name</label>
          <input type="text" id="player-name-input" placeholder="Enter name..." onkeydown="if(event.key==='Enter')addPlayer()">
        </div>
        <div class="form-group">
          <label>Handicap</label>
          <input type="number" id="player-handicap-input" placeholder="0" min="0" max="54" style="width:100px" onkeydown="if(event.key==='Enter')addPlayer()">
        </div>
        <div style="padding-bottom:1px">
          <button class="btn btn-pink" onclick="addPlayer()">+ Add Player</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Roster <span id="roster-count" style="font-size:0.85rem;color:var(--gray);font-family:'Space Grotesk',sans-serif;"></span></div>
      <div class="player-grid" id="player-list">
        <div class="empty-state" style="grid-column:1/-1">No players yet.</div>
      </div>
    </div>
  </div>

  <!-- MANAGE WEEK PANEL (editor) -->
  <div id="panel-manage-week" class="panel">
    <div class="card">
      <div class="card-title">Set This Week's Info</div>
      <p style="font-size:0.85rem;color:var(--gray);margin-bottom:16px">This info shows on the "This Week" tab for all players.</p>
      <div class="form-row">
        <div class="form-group">
          <label>Current Week #</label>
          <select id="current-week-select"></select>
        </div>
        <div class="form-group wide">
          <label>Course Name</label>
          <input type="text" id="tw-course-input" placeholder="e.g. Torrey Pines...">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="tw-date-input">
        </div>
        <div class="form-group">
          <label>Tee Time</label>
          <input type="time" id="tw-time-input">
        </div>
        <div class="form-group">
          <label>Par</label>
          <input type="number" id="tw-par-input" value="72" min="60" max="80" style="width:90px">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group wide">
          <label>Notes (optional)</label>
          <textarea id="tw-notes-input" rows="2" placeholder="e.g. Bring cash for skins..."></textarea>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-pink" onclick="saveThisWeek()">Save This Week</button>
        <button class="btn btn-outline" onclick="markAllPaid()">Mark All In as Paid</button>
        <button class="btn btn-outline" onclick="resetPayments()">Reset Payments</button>
      </div>
      <p style="font-size:0.72rem;color:var(--gray);margin-top:10px">Auto-emails send if this page is open at Sunday 2 PM & Monday 8 AM. Use the manual button in the RSVP Summary as backup.</p>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script>
const ADMIN_PASSWORD = 'golf2025';
const TOTAL_WEEKS    = 20;
const STORAGE_KEY    = 'fog-league-v2';

/* ─── Firebase Init ─── */
const firebaseConfig = {
  apiKey: "AIzaSyD8swdfrbrzGsvP--QYL0fuWE_cp7zk7HE",
  authDomain: "fog-golf.firebaseapp.com",
  projectId: "fog-golf",
  storageBucket: "fog-golf.firebasestorage.app",
  messagingSenderId: "865532832027",
  appId: "1:865532832027:web:389127ab5a9f01d2e28bbe",
  databaseURL: "https://fog-golf-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let isEditor = false;
let state = {
  players: [],
  weeks: {},
  thisWeek: { weekNum: 1, course: '', date: '', time: '', par: 72, notes: '' }
};
let rsvpData = {};       // Populated by Firebase listener: { weekNum: { playerId: status } }
let rsvpListener = null; // Track current Firebase listener
let paymentData = {};       // Populated by Firebase: { weekNum: { playerId: true/false } }
let paymentListener = null;
let curHistoryWeek = null;
let countdownInterval = null;
let emailCheckCounter = 0;
let emailSentFlags = {};

/* ─── EmailJS Config (update after setting up emailjs.com) ─── */
const EMAILJS_PUBLIC_KEY  = '';  // Fill after EmailJS setup
const EMAILJS_SERVICE_ID  = '';  // Fill after EmailJS setup
const EMAILJS_TEMPLATE_ID = '';  // Fill after EmailJS setup
const ADMIN_EMAIL = 'jamirandregg@gmail.com';

/* ─── Helpers ─── */
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function setLoading(v) { document.getElementById('loading-bar').classList.toggle('show', v); }
let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

/* ─── RSVP Deadline ─── */
function getRSVPDeadline() {
  const tw = state.thisWeek;
  if (!tw.date) return null;
  // Tee time is always 2:00 PM MDT (hardcoded per league rules)
  // Deadline is 24 hours before = Sunday 2:00 PM MDT
  const teeTimeLocal = new Date(tw.date + 'T14:00:00');
  // Convert to proper Denver time
  const denverNow = new Date().toLocaleString('en-US', { timeZone: 'America/Denver' });
  const nowDenver = new Date(denverNow);
  // Build tee time as Denver time
  const year = teeTimeLocal.getFullYear();
  const month = String(teeTimeLocal.getMonth() + 1).padStart(2, '0');
  const day = String(teeTimeLocal.getDate()).padStart(2, '0');
  const teeStr = `${year}-${month}-${day}T14:00:00`;
  // Get the UTC offset for Denver on that date
  const testDate = new Date(teeStr);
  const utcStr = testDate.toLocaleString('en-US', { timeZone: 'UTC' });
  const denStr = testDate.toLocaleString('en-US', { timeZone: 'America/Denver' });
  const utcDate = new Date(utcStr);
  const denDate = new Date(denStr);
  const offsetMs = utcDate.getTime() - denDate.getTime();
  // Tee time in UTC
  const teeUTC = new Date(testDate.getTime() + offsetMs);
  // Deadline is 24 hours before tee time
  return new Date(teeUTC.getTime() - 24 * 60 * 60 * 1000);
}

function isRSVPLocked() {
  const deadline = getRSVPDeadline();
  if (!deadline) return false;
  return new Date() >= deadline;
}

function updateDeadlineDisplay() {
  const el = document.getElementById('rsvp-deadline-display');
  if (!el) return;
  const deadline = getRSVPDeadline();
  if (!deadline) { el.innerHTML = ''; return; }
  const now = new Date();
  const diff = deadline.getTime() - now.getTime();
  if (diff <= 0) {
    el.innerHTML = '<div class="deadline-locked">RSVPs ARE LOCKED</div>';
    return;
  }
  const days = Math.floor(diff / (1000*60*60*24));
  const hours = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
  const minutes = Math.floor((diff % (1000*60*60)) / (1000*60));
  const seconds = Math.floor((diff % (1000*60)) / 1000);
  let timeStr = '';
  if (days > 0) timeStr += days + 'd ';
  timeStr += hours + 'h ' + minutes + 'm ' + seconds + 's';
  el.innerHTML = `<div class="deadline-pill"><span class="dl-label">RSVP Closes In:</span><span class="dl-time">${timeStr}</span></div>`;
}

/* ─── Storage ─── */
async function saveState() {
  setLoading(true);
  try {
    if (window.storage && window.storage.set) {
      await window.storage.set(STORAGE_KEY, JSON.stringify(state), true);
    } else {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
  } catch(e) { toast('Save failed - try again.'); console.warn(e); }
  setLoading(false);
}

async function loadState() {
  setLoading(true);
  try {
    let raw = null;
    if (window.storage && window.storage.get) {
      const res = await window.storage.get(STORAGE_KEY, true);
      if (res && res.value) raw = res.value;
    } else {
      raw = localStorage.getItem(STORAGE_KEY);
    }
    if (raw) {
      const loaded = JSON.parse(raw);
      state.players = loaded.players || [];
      state.weeks = loaded.weeks || {};
      state.thisWeek = loaded.thisWeek || { weekNum: 1, course: '', date: '', time: '', par: 72, notes: '' };
    }
  } catch(e) { console.warn('No saved data yet.'); }
  setLoading(false);
  renderAll();
}

/* ─── Auth ─── */
function handleLockBtn() { isEditor ? logout() : openModal(); }
function openModal() {
  document.getElementById('modal-overlay').classList.add('open');
  document.getElementById('modal-pw').value = '';
  document.getElementById('modal-error').textContent = '';
  setTimeout(() => document.getElementById('modal-pw').focus(), 200);
}
function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); }
function submitPassword() {
  const pw = document.getElementById('modal-pw').value;
  if (pw === ADMIN_PASSWORD) {
    isEditor = true;
    closeModal();
    applyMode();
    toast('Editor mode unlocked!');
  } else {
    document.getElementById('modal-error').textContent = 'Incorrect password. Try again.';
    document.getElementById('modal-pw').value = '';
    document.getElementById('modal-pw').focus();
  }
}
function logout() {
  if (!confirm('Log out of editor mode?')) return;
  isEditor = false;
  applyMode();
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-home').classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelector('.nav-tab').classList.add('active');
  toast('Logged out.');
}
function applyMode() {
  const badge = document.getElementById('mode-badge');
  const label = document.getElementById('mode-label');
  const lockBtn = document.getElementById('lock-btn');
  if (isEditor) {
    badge.className = 'mode-badge mode-editor';
    label.textContent = 'Editor';
    lockBtn.textContent = 'Logout';
    document.body.classList.add('editor-mode');
  } else {
    badge.className = 'mode-badge mode-viewer';
    label.textContent = 'View Only';
    lockBtn.textContent = 'Admin Login';
    document.body.classList.remove('editor-mode');
  }
  ['player-name-input','player-handicap-input','week-select','par-input','course-input','save-scores-btn',
   'tw-course-input','tw-date-input','tw-time-input','tw-par-input','tw-notes-input','current-week-select']
    .forEach(id => { const el = document.getElementById(id); if (el) el.disabled = !isEditor; });
  renderScoreEntry();
}

/* ─── Navigation ─── */
function showPanel(name, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'home')        renderThisWeek();
  if (name === 'scores')      { populateWeekSelect(); renderScoreEntry(); }
  if (name === 'standings')   renderStandings();
  if (name === 'history')     renderHistory(curHistoryWeek);
  if (name === 'players')     renderPlayers();
  if (name === 'schedule')       renderSchedule();
  if (name === 'past-seasons')   renderPastSeasons();
  if (name === 'manage-week')    renderManageWeek();
}

/* ─── Firebase RSVP Listener ─── */
function listenToRSVPs() {
  const wn = state.thisWeek.weekNum || 1;
  const rsvpRef = db.ref('rsvps/' + wn);

  if (rsvpListener) rsvpListener.off();
  rsvpListener = rsvpRef;

  rsvpRef.on('value', (snapshot) => {
    rsvpData[wn] = snapshot.val() || {};
    renderThisWeek();
    if (isEditor) renderAdminSummary();
  });
}

/* ─── Firebase Payment Listener ─── */
function listenToPayments() {
  const wn = state.thisWeek.weekNum || 1;
  const payRef = db.ref('payments/' + wn);

  if (paymentListener) paymentListener.off();
  paymentListener = payRef;

  payRef.on('value', (snapshot) => {
    paymentData[wn] = snapshot.val() || {};
    renderRSVP();
    if (isEditor) renderAdminSummary();
  });
}

/* ─── This Week / RSVP ─── */
function renderThisWeek() {
  const tw = state.thisWeek;
  const courseEl = document.getElementById('tw-course');
  const detailsEl = document.getElementById('tw-details');
  const rsvpCountEl = document.getElementById('tw-rsvp-count');

  if (tw.course) {
    courseEl.textContent = tw.course;
    let details = [];
    if (tw.date) {
      const d = new Date(tw.date + 'T00:00:00');
      details.push(d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }));
    }
    if (tw.time) {
      const [h, m] = tw.time.split(':');
      const hr = parseInt(h);
      details.push((hr > 12 ? hr - 12 : hr) + ':' + m + (hr >= 12 ? ' PM' : ' AM'));
    }
    if (tw.par) details.push('Par ' + tw.par);
    detailsEl.innerHTML = details.map(d => '<span>' + escHtml(d) + '</span>').join(' &middot; ');
    if (tw.notes) {
      detailsEl.innerHTML += '<br><span style="font-size:0.8rem;color:var(--gray);margin-top:4px;display:inline-block">' + escHtml(tw.notes) + '</span>';
    }
  } else {
    courseEl.textContent = 'No course set yet';
    detailsEl.innerHTML = '<span style="color:var(--gray)">Admin will post this week\'s details soon</span>';
  }

  // RSVP count (from Firebase data)
  const wn = tw.weekNum || 1;
  const rsvps = rsvpData[wn] || {};
  const yesCount = Object.values(rsvps).filter(v => v === 'yes').length;
  rsvpCountEl.innerHTML = '<span class="count-num">' + yesCount + '</span> player' + (yesCount !== 1 ? 's' : '') + ' confirmed';

  updateDeadlineDisplay();
  renderRSVP();
}

function renderRSVP() {
  const list = document.getElementById('rsvp-list');
  if (!state.players.length) {
    list.innerHTML = '<div class="empty-state" style="grid-column:1/-1">No players yet. Admin must add players first.</div>';
    return;
  }
  const wn = state.thisWeek.weekNum || 1;
  const rsvps = rsvpData[wn] || {};
  const payments = paymentData[wn] || {};
  const locked = isRSVPLocked() && !isEditor;

  list.innerHTML = state.players.map(p => {
    const status = rsvps[p.id] || 'pending';
    const paid = payments[p.id] === true;
    const chipClass = status === 'yes' ? 'rsvp-yes' : status === 'no' ? 'rsvp-no' : '';
    const btnClass = status === 'yes' ? 'rsvp-in' : status === 'no' ? 'rsvp-out' : 'rsvp-pending';
    const btnText = status === 'yes' ? 'I\'m In' : status === 'no' ? 'Out' : 'Pending';
    const disabledAttr = locked ? 'disabled style="opacity:0.5;cursor:not-allowed"' : '';

    // Payment indicator
    let payHtml = '';
    if (isEditor) {
      payHtml = `<button class="rsvp-status ${paid ? 'rsvp-paid' : 'rsvp-unpaid'}" onclick="togglePayment('${p.id}')">${paid ? 'PAID' : 'UNPAID'}</button>`;
    } else if (paid) {
      payHtml = '<span class="paid-badge">PAID</span>';
    }

    return `
      <div class="rsvp-chip ${chipClass}">
        <span style="font-weight:600">${escHtml(p.name)}</span>
        <span class="chip-actions">
          ${payHtml}
          <button class="rsvp-status ${btnClass}" onclick="toggleRSVP('${p.id}')" ${disabledAttr}>${btnText}</button>
        </span>
      </div>
    `;
  }).join('');
}

async function toggleRSVP(playerId) {
  if (isRSVPLocked() && !isEditor) {
    toast('RSVPs are locked! Deadline has passed.');
    return;
  }
  const wn = state.thisWeek.weekNum || 1;
  const cur = (rsvpData[wn] && rsvpData[wn][playerId]) || 'pending';
  const next = cur === 'pending' ? 'yes' : cur === 'yes' ? 'no' : 'pending';

  try {
    await db.ref('rsvps/' + wn + '/' + playerId).set(next);
  } catch (e) {
    toast('RSVP update failed - try again.');
    console.warn(e);
  }
}

/* ─── Payment Tracking ─── */
async function togglePayment(playerId) {
  if (!isEditor) return;
  const wn = state.thisWeek.weekNum || 1;
  const cur = (paymentData[wn] && paymentData[wn][playerId]) === true;
  try {
    await db.ref('payments/' + wn + '/' + playerId).set(!cur);
    toast(cur ? 'Marked as unpaid' : 'Marked as paid');
  } catch (e) {
    toast('Payment update failed');
    console.warn(e);
  }
}

async function markAllPaid() {
  if (!isEditor) return;
  const wn = state.thisWeek.weekNum || 1;
  const rsvps = rsvpData[wn] || {};
  const updates = {};
  Object.entries(rsvps).forEach(([pid, status]) => {
    if (status === 'yes') updates[pid] = true;
  });
  if (Object.keys(updates).length === 0) { toast('No confirmed players to mark'); return; }
  await db.ref('payments/' + wn).update(updates);
  toast('All confirmed players marked as paid');
}

async function resetPayments() {
  if (!isEditor) return;
  if (!confirm('Reset all payment statuses for this week?')) return;
  const wn = state.thisWeek.weekNum || 1;
  await db.ref('payments/' + wn).remove();
  await db.ref('paymentEnforced/' + wn).remove();
  toast('Payments reset');
}

async function enforcePaymentCutoff() {
  if (!isRSVPLocked() || !isEditor) return;
  const wn = state.thisWeek.weekNum || 1;
  try {
    const enforcedSnap = await db.ref('paymentEnforced/' + wn).once('value');
    if (enforcedSnap.val() === true) return;
    const rsvps = rsvpData[wn] || {};
    const payments = paymentData[wn] || {};
    const updates = {};
    let changed = false;
    Object.entries(rsvps).forEach(([playerId, status]) => {
      if (status === 'yes' && !payments[playerId]) {
        updates['rsvps/' + wn + '/' + playerId] = 'no';
        changed = true;
      }
    });
    if (changed) {
      updates['paymentEnforced/' + wn] = true;
      await db.ref().update(updates);
      toast('Unpaid players marked as Out (deadline passed)');
    } else {
      await db.ref('paymentEnforced/' + wn).set(true);
    }
  } catch (e) { console.warn('Payment enforcement error:', e); }
}

/* ─── Admin RSVP Summary ─── */
function renderAdminSummary() {
  const el = document.getElementById('admin-summary-content');
  if (!el || !isEditor) return;
  const wn = state.thisWeek.weekNum || 1;
  const rsvps = rsvpData[wn] || {};
  const payments = paymentData[wn] || {};
  const inList = [], outList = [], pendingList = [];

  state.players.forEach(p => {
    const status = rsvps[p.id] || 'pending';
    const paid = payments[p.id] === true;
    const entry = { name: p.name, paid };
    if (status === 'yes') inList.push(entry);
    else if (status === 'no') outList.push(entry);
    else pendingList.push(entry);
  });

  const renderList = (items, showPay) => {
    if (!items.length) return '<div style="color:var(--gray);font-size:0.8rem;padding:4px 0">None</div>';
    return items.map(item => `
      <div class="summary-player">
        <span>${escHtml(item.name)}</span>
        ${showPay ? (item.paid
          ? '<span class="summary-badge summary-badge-paid">PAID</span>'
          : '<span class="summary-badge summary-badge-unpaid">UNPAID</span>') : ''}
      </div>
    `).join('');
  };

  const total = state.players.length;
  const responded = inList.length + outList.length;
  el.innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-top:10px">
      <div>
        <div class="summary-col-header" style="color:var(--green-good)">IN (${inList.length})</div>
        ${renderList(inList, true)}
      </div>
      <div>
        <div class="summary-col-header" style="color:var(--red-bad)">OUT (${outList.length})</div>
        ${renderList(outList, false)}
      </div>
      <div>
        <div class="summary-col-header" style="color:var(--gray)">NO RESPONSE (${pendingList.length})</div>
        ${renderList(pendingList, false)}
      </div>
    </div>
    <div style="margin-top:14px;padding-top:10px;border-top:1px solid rgba(255,61,167,0.15);font-size:0.8rem;color:var(--gray)">
      Total: ${total} players &middot; Response rate: ${total ? Math.round((responded / total) * 100) : 0}%
    </div>
  `;
}

/* ─── Email Notifications (EmailJS) ─── */
function buildRSVPSummaryText() {
  const wn = state.thisWeek.weekNum || 1;
  const rsvps = rsvpData[wn] || {};
  const payments = paymentData[wn] || {};
  const inPlayers = [], outPlayers = [], pendingPlayers = [];

  state.players.forEach(p => {
    const status = rsvps[p.id] || 'pending';
    const paid = payments[p.id] === true;
    if (status === 'yes') inPlayers.push(p.name + (paid ? ' (Paid)' : ' (UNPAID)'));
    else if (status === 'no') outPlayers.push(p.name);
    else pendingPlayers.push(p.name);
  });

  let text = 'FOG Golf League - Week ' + wn + ' RSVP Summary\n';
  text += 'Course: ' + (state.thisWeek.course || 'TBD') + '\n';
  text += 'Date: ' + (state.thisWeek.date || 'TBD') + '\n';
  text += 'Tee Time: 2:00 PM MDT\n\n';
  text += '--- IN (' + inPlayers.length + ') ---\n' + (inPlayers.join('\n') || 'None') + '\n\n';
  text += '--- OUT (' + outPlayers.length + ') ---\n' + (outPlayers.join('\n') || 'None') + '\n\n';
  text += '--- NO RESPONSE (' + pendingPlayers.length + ') ---\n' + (pendingPlayers.join('\n') || 'None') + '\n';
  return text;
}

async function sendRSVPEmail(subject) {
  if (!EMAILJS_PUBLIC_KEY || !EMAILJS_SERVICE_ID || !EMAILJS_TEMPLATE_ID) {
    toast('EmailJS not configured yet - check settings');
    console.warn('EmailJS keys not set. Set EMAILJS_PUBLIC_KEY, EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID in the code.');
    return false;
  }
  try {
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
      to_email: ADMIN_EMAIL,
      subject: subject || 'FOG RSVP Summary - Week ' + (state.thisWeek.weekNum || 1),
      rsvp_summary: buildRSVPSummaryText()
    }, EMAILJS_PUBLIC_KEY);
    toast('RSVP summary email sent!');
    return true;
  } catch(e) {
    toast('Email failed to send');
    console.warn('EmailJS error:', e);
    return false;
  }
}

function loadEmailSentFlags() {
  const wn = state.thisWeek.weekNum || 1;
  ['deadline-', 'morning-'].forEach(prefix => {
    const key = prefix + wn;
    if (localStorage.getItem('emailSent_' + key) === 'true') {
      emailSentFlags[key] = true;
    }
  });
}

function checkAutoEmailTriggers() {
  if (!isEditor || !EMAILJS_PUBLIC_KEY) return;
  const wn = state.thisWeek.weekNum || 1;
  const deadline = getRSVPDeadline();
  if (!deadline || !state.thisWeek.date) return;
  const now = new Date();

  // Trigger 1: At deadline (Sunday 2 PM MDT)
  const deadlineKey = 'deadline-' + wn;
  if (!emailSentFlags[deadlineKey]) {
    const diffMs = now.getTime() - deadline.getTime();
    if (diffMs >= 0 && diffMs < 120000) {
      emailSentFlags[deadlineKey] = true;
      localStorage.setItem('emailSent_' + deadlineKey, 'true');
      sendRSVPEmail('FOG RSVPs CLOSED - Week ' + wn);
    }
  }

  // Trigger 2: Monday 8 AM MDT (18 hours after Sunday 2 PM)
  const mondayMorning = new Date(deadline.getTime() + 18 * 60 * 60 * 1000);
  const morningKey = 'morning-' + wn;
  if (!emailSentFlags[morningKey]) {
    const diffMs2 = now.getTime() - mondayMorning.getTime();
    if (diffMs2 >= 0 && diffMs2 < 120000) {
      emailSentFlags[morningKey] = true;
      localStorage.setItem('emailSent_' + morningKey, 'true');
      sendRSVPEmail('FOG Game Day Reminder - Week ' + wn);
    }
  }
}

/* ─── Manage Week (editor) ─── */
function renderManageWeek() {
  const sel = document.getElementById('current-week-select');
  if (!sel) return;
  sel.innerHTML = '';
  for (let w = 1; w <= TOTAL_WEEKS; w++) {
    const opt = document.createElement('option');
    opt.value = w;
    opt.textContent = 'Week ' + w;
    sel.appendChild(opt);
  }
  sel.value = state.thisWeek.weekNum || 1;
  document.getElementById('tw-course-input').value = state.thisWeek.course || '';
  document.getElementById('tw-date-input').value = state.thisWeek.date || '';
  document.getElementById('tw-time-input').value = state.thisWeek.time || '';
  document.getElementById('tw-par-input').value = state.thisWeek.par || 72;
  document.getElementById('tw-notes-input').value = state.thisWeek.notes || '';
}

async function saveThisWeek() {
  if (!isEditor) return;
  state.thisWeek = {
    weekNum: parseInt(document.getElementById('current-week-select').value),
    course: document.getElementById('tw-course-input').value.trim(),
    date: document.getElementById('tw-date-input').value,
    time: document.getElementById('tw-time-input').value,
    par: parseInt(document.getElementById('tw-par-input').value) || 72,
    notes: document.getElementById('tw-notes-input').value.trim()
  };
  await saveState();
  listenToRSVPs();
  listenToPayments();
  toast('This week updated!');
  renderThisWeek();
}

/* ─── Schedule ─── */
function renderSchedule() {
  const el = document.getElementById('schedule-list');
  const weekNums = Object.keys(state.weeks).filter(w => {
    const wd = state.weeks[w];
    return wd && (wd.course || Object.keys(wd.scores || {}).length > 0);
  }).sort((a, b) => +a - +b);

  const currentWn = state.thisWeek.weekNum || 1;

  if (!weekNums.length && !state.thisWeek.course) {
    el.innerHTML = '<div class="empty-state">No schedule set yet. Admin can add course info each week.</div>';
    return;
  }

  let items = [];

  // Show current week at top if it has info
  if (state.thisWeek.course) {
    let details = [];
    if (state.thisWeek.date) {
      const d = new Date(state.thisWeek.date + 'T00:00:00');
      details.push(d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
    }
    if (state.thisWeek.time) {
      const [h, m] = state.thisWeek.time.split(':');
      const hr = parseInt(h);
      details.push((hr > 12 ? hr - 12 : hr) + ':' + m + (hr >= 12 ? ' PM' : ' AM'));
    }
    items.push(`
      <div class="schedule-item" style="border-color:rgba(255,61,167,0.5)">
        <div class="schedule-week-num">W${currentWn}</div>
        <div class="schedule-info">
          <div class="course">${escHtml(state.thisWeek.course)}</div>
          <div class="details">${details.length ? details.join(' &middot; ') : ''} ${state.thisWeek.par ? '&middot; Par ' + state.thisWeek.par : ''}</div>
        </div>
        <span class="schedule-badge badge-current">This Week</span>
      </div>
    `);
  }

  // Past weeks with scores
  weekNums.forEach(w => {
    if (+w === currentWn && state.thisWeek.course) return; // skip if already shown as current
    const wd = state.weeks[w];
    const hasScores = Object.keys(wd.scores || {}).length > 0;
    const badge = +w < currentWn ? 'badge-completed' : 'badge-upcoming';
    const badgeText = +w < currentWn ? 'Completed' : 'Upcoming';
    items.push(`
      <div class="schedule-item">
        <div class="schedule-week-num">W${w}</div>
        <div class="schedule-info">
          <div class="course">${wd.course ? escHtml(wd.course) : 'Course TBD'}</div>
          <div class="details">Par ${wd.par || 72} ${hasScores ? '&middot; ' + Object.keys(wd.scores).length + ' players' : ''}</div>
        </div>
        <span class="schedule-badge ${badge}">${badgeText}</span>
      </div>
    `);
  });

  el.innerHTML = items.join('');
}

/* ─── Players ─── */
async function addPlayer() {
  if (!isEditor) return;
  const nameEl = document.getElementById('player-name-input');
  const hcpEl = document.getElementById('player-handicap-input');
  const name = nameEl.value.trim();
  if (!name) return toast('Enter a player name.');
  if (state.players.length >= 30) return toast('Maximum 30 players reached.');
  if (state.players.find(p => p.name.toLowerCase() === name.toLowerCase())) return toast('Player already exists.');
  state.players.push({ id: Date.now().toString(), name, handicap: parseInt(hcpEl.value) || 0 });
  nameEl.value = ''; hcpEl.value = '';
  await saveState();
  renderPlayers(); renderScoreEntry(); renderRSVP();
  toast(name + ' added!');
  nameEl.focus();
}

async function removePlayer(id) {
  if (!isEditor) return;
  const p = state.players.find(p => p.id === id);
  if (!confirm('Remove ' + (p?.name) + '? Their scores will also be removed.')) return;
  state.players = state.players.filter(p => p.id !== id);
  Object.values(state.weeks).forEach(w => { delete w.scores[id]; });
  await saveState();
  renderPlayers(); renderScoreEntry(); renderStandings();
  toast('Player removed.');
}

function renderPlayers() {
  const list = document.getElementById('player-list');
  const count = document.getElementById('roster-count');
  if (count) count.textContent = '(' + state.players.length + '/30)';
  if (!list) return;
  if (!state.players.length) {
    list.innerHTML = '<div class="empty-state" style="grid-column:1/-1">No players yet.</div>';
    return;
  }
  list.innerHTML = state.players.map((p, i) => `
    <div class="player-chip">
      <span>
        <span class="player-num">${i + 1}.</span>
        <span>${escHtml(p.name)}</span>
        ${p.handicap ? `<span style="font-size:0.7rem;color:var(--gray);margin-left:4px">(HCP ${p.handicap})</span>` : ''}
      </span>
      ${isEditor ? `<button class="btn btn-danger" onclick="removePlayer('${p.id}')">✕</button>` : ''}
    </div>
  `).join('');
}

/* ─── Scores ─── */
function populateWeekSelect() {
  const sel = document.getElementById('week-select');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '';
  for (let w = 1; w <= TOTAL_WEEKS; w++) {
    const opt = document.createElement('option');
    opt.value = w;
    const has = state.weeks[w] && Object.keys(state.weeks[w].scores || {}).length > 0;
    opt.textContent = 'Week ' + w + (has ? ' ✓' : '');
    sel.appendChild(opt);
  }
  if (cur) sel.value = cur;
}

function renderScoreEntry() {
  const area = document.getElementById('score-entry-area');
  if (!area) return;
  if (!state.players.length) {
    area.innerHTML = '<div class="empty-state">Add players first, then enter scores here.</div>';
    return;
  }
  const week = document.getElementById('week-select')?.value || '1';
  const weekData = state.weeks[week] || { par: 72, course: '', scores: {} };
  const parEl = document.getElementById('par-input');
  const crsEl = document.getElementById('course-input');
  if (parEl) parEl.value = weekData.par || 72;
  if (crsEl) crsEl.value = weekData.course || '';
  area.innerHTML = `
    <div class="score-table-wrap">
      <table>
        <thead><tr><th>#</th><th>Player</th><th>HCP</th><th>Gross Score</th><th>Net Score</th></tr></thead>
        <tbody>
          ${state.players.map((p, i) => {
            const gross = weekData.scores[p.id] ?? '';
            const net = gross !== '' ? gross - p.handicap : '';
            return `<tr>
              <td style="color:var(--gray);font-size:0.78rem">${i + 1}</td>
              <td><strong>${escHtml(p.name)}</strong></td>
              <td style="color:var(--pink-light)">${p.handicap || '—'}</td>
              <td class="score-input-cell">
                <input type="number" id="score-${p.id}" value="${gross}" min="50" max="150" placeholder="—"
                  ${!isEditor ? 'disabled' : ''}
                  oninput="updateNet('${p.id}',${p.handicap})"
                  onkeydown="if(event.key==='Enter'){event.preventDefault();focusNext(this)}">
              </td>
              <td id="net-${p.id}" style="color:var(--pink-hot);font-weight:700">${net !== '' ? net : '—'}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function updateNet(id, hcp) {
  const gross = parseInt(document.getElementById('score-' + id)?.value);
  const el = document.getElementById('net-' + id);
  if (el) el.textContent = isNaN(gross) ? '—' : gross - hcp;
}

function focusNext(el) {
  const inputs = [...document.querySelectorAll('.score-input-cell input:not(:disabled)')];
  const idx = inputs.indexOf(el);
  if (idx < inputs.length - 1) inputs[idx + 1].focus();
  else saveScores();
}

async function saveScores() {
  if (!isEditor) return;
  if (!state.players.length) return toast('Add players first.');
  const week = document.getElementById('week-select').value;
  const par = parseInt(document.getElementById('par-input').value) || 72;
  const course = document.getElementById('course-input').value.trim();
  const scores = {};
  state.players.forEach(p => {
    const v = document.getElementById('score-' + p.id)?.value;
    if (v !== '' && v !== undefined && !isNaN(parseInt(v))) scores[p.id] = parseInt(v);
  });
  state.weeks[week] = { par, course, scores };
  await saveState();
  populateWeekSelect();
  renderStandings();
  renderHistory(curHistoryWeek);
  toast('Week ' + week + ' scores saved!');
}

/* ─── Standings ─── */
function renderStandings() {
  const body = document.getElementById('standings-body');
  const meta = document.getElementById('standings-meta');
  if (!state.players.length) {
    body.innerHTML = '<tr><td colspan="7" class="empty-state">No players added yet.</td></tr>';
    meta.innerHTML = ''; return;
  }
  const weeksPlayed = Object.keys(state.weeks).filter(w => Object.keys(state.weeks[w].scores || {}).length > 0).length;
  const stats = state.players.map(p => {
    let total = 0, rounds = 0, best = Infinity, totalPar = 0;
    Object.values(state.weeks).forEach(w => {
      const s = w.scores[p.id];
      if (s !== undefined) { total += s; rounds++; if (s < best) best = s; totalPar += (w.par || 72); }
    });
    return { ...p, total: rounds ? total : null, rounds, avg: rounds ? (total / rounds).toFixed(1) : null, best: rounds ? best : null, vsPar: rounds ? total - totalPar : null };
  });
  stats.sort((a, b) => { if (!a.rounds && !b.rounds) return 0; if (!a.rounds) return 1; if (!b.rounds) return -1; return a.total - b.total; });
  const allScores = Object.values(state.weeks).flatMap(w => Object.values(w.scores || {}));
  const lowestEver = allScores.length ? Math.min(...allScores) : null;
  let lowestPlayerName = '';
  if (lowestEver !== null) {
    outer: for (const w of Object.values(state.weeks)) {
      for (const [pid, sc] of Object.entries(w.scores || {})) {
        if (sc === lowestEver) { const pl = state.players.find(p => p.id === pid); if (pl) lowestPlayerName = pl.name; break outer; }
      }
    }
  }
  const totalRounds = stats.reduce((s, p) => s + p.rounds, 0);
  meta.innerHTML = `
    <div class="meta-stat"><div class="val">${state.players.length}</div><div class="lbl">Players</div></div>
    <div class="meta-stat"><div class="val">${weeksPlayed}</div><div class="lbl">Weeks Played</div></div>
    <div class="meta-stat"><div class="val">${totalRounds}</div><div class="lbl">Total Rounds</div></div>
    <div class="meta-stat"><div class="val">${lowestEver ?? '—'}</div>
      <div class="lbl">Course Record${lowestPlayerName ? '<br><span style="font-size:0.63rem;color:var(--pink-light)">' + escHtml(lowestPlayerName) + '</span>' : ''}</div>
    </div>
  `;
  body.innerHTML = stats.map((p, i) => {
    const rc = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other';
    const lc = i === 0 && p.rounds > 0 ? 'leader' : '';
    let vph = '—';
    if (p.vsPar !== null) {
      const cls = p.vsPar < 0 ? 'score-under' : p.vsPar === 0 ? 'score-even' : 'score-over';
      vph = `<span class="score-pill ${cls}">${p.vsPar > 0 ? '+' : ''}${p.vsPar}</span>`;
    }
    return `<tr class="${lc}">
      <td><span class="rank-badge ${rc}">${i + 1}</span></td>
      <td><strong>${escHtml(p.name)}</strong>${p.handicap ? `<span class="flag"> HCP ${p.handicap}</span>` : ''}</td>
      <td>${p.rounds}</td><td>${p.total ?? '—'}</td><td>${p.avg ?? '—'}</td><td>${p.best ?? '—'}</td><td>${vph}</td>
    </tr>`;
  }).join('');
}

/* ─── History ─── */
function renderHistory(sel) {
  const pillsEl = document.getElementById('week-pills');
  const contentEl = document.getElementById('history-content');
  const weeks = Object.keys(state.weeks).filter(w => Object.keys(state.weeks[w].scores || {}).length > 0).sort((a, b) => +a - +b);
  if (!weeks.length) { pillsEl.innerHTML = ''; contentEl.innerHTML = '<div class="empty-state">No scores saved yet.</div>'; return; }
  if (!sel || !weeks.includes(String(sel))) sel = weeks[weeks.length - 1];
  curHistoryWeek = sel;
  pillsEl.innerHTML = weeks.map(w => `
    <button class="week-pill ${String(w) === String(sel) ? 'active' : ''}" onclick="renderHistory('${w}')">Week ${w}</button>
  `).join('');
  const wd = state.weeks[sel];
  const par = wd.par || 72, course = wd.course || '';
  const entries = Object.entries(wd.scores)
    .map(([id, score]) => { const pl = state.players.find(p => p.id === id); return pl ? { pl, gross: score, net: score - pl.handicap, vp: score - par } : null; })
    .filter(Boolean).sort((a, b) => a.gross - b.gross);
  contentEl.innerHTML = `
    <div style="margin-bottom:16px;display:flex;gap:20px;flex-wrap:wrap;align-items:center">
      <span style="font-family:'Outfit',sans-serif;font-size:1.15rem;color:var(--pink-hot);font-weight:700">
        Week ${sel}${course ? ' — ' + escHtml(course) : ''}
      </span>
      <span style="font-size:0.78rem;color:var(--gray)">Par ${par} &middot; ${entries.length} players</span>
    </div>
    <div class="score-table-wrap">
      <table>
        <thead><tr><th>#</th><th>Player</th><th>Course</th><th>Gross</th><th>vs Par</th><th>HCP</th><th>Net</th></tr></thead>
        <tbody>
          ${entries.map((e, i) => {
            const rc = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other';
            const vpc = e.vp < 0 ? 'score-under' : e.vp === 0 ? 'score-even' : 'score-over';
            return `<tr ${i === 0 ? 'class="leader"' : ''}>
              <td><span class="rank-badge ${rc}">${i + 1}</span></td>
              <td><strong>${escHtml(e.pl.name)}</strong></td>
              <td style="color:var(--gray);font-size:0.8rem">${course ? escHtml(course) : '—'}</td>
              <td style="font-weight:700;font-size:1rem">${e.gross}</td>
              <td><span class="score-pill ${vpc}">${e.vp > 0 ? '+' : ''}${e.vp}</span></td>
              <td style="color:var(--pink-light)">${e.pl.handicap || '—'}</td>
              <td style="color:var(--pink-hot);font-weight:700">${e.net}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

/* ─── Render All ─── */
function renderAll() {
  renderPlayers();
  populateWeekSelect();
  renderScoreEntry();
  renderStandings();
  renderHistory(null);
  renderThisWeek();
  renderSchedule();
  applyMode();
}

/* ─── Past Seasons Data ─── */
const PAST_SEASONS = {
  '2024': {
    weeks: [
      { date:'4/16/2024', course:'Broken Tee', par:36, scores:{
        'Chris Hemp':42,'Gamal Kader':45,'Jami Andregg':51,'Ken Walton':47,'Matthew Walton':49,'Gregory Walton':50,'Dave Stokes':49,'James Fouther':53,'Jim Ortega':47,'Robert Perkowski':46,'Tim Marchbank':46,'Zach Spratt':56,'Walter Jackson':45,'Mike Mensendick':46,'Ken Carbello':48,'Mike Bryant':52,'Dallas Walton':47,'Roland Jones':50,'Reggie Gamlin':42,'Logan J':42,'Rob Sanchez':52,'Daniel Nunez':43,'Preston Bryant':49,'Les Perry':45,'William Perkowski':51,'Ryan Marchbank':49,'Rob Hoffschneider':46,'Kim F':43,'Phillip Jackson':51,'Lonnie Dixon':47,'Victoria Braucher':53
      }},
      { date:'4/23/2024', course:'Aurora Hills', par:36, scores:{
        'Chris Hemp':39,'Gamal Kader':41,'Jami Andregg':48,'Ken Walton':43,'Matthew Walton':50,'James Fouther':48,'Jim Ortega':42,'Robert Perkowski':44
      }},
      { date:'5/7/2024', course:'Overland', par:36, scores:{
        'Chris Hemp':43,'Gamal Kader':42,'Jami Andregg':50,'Ken Walton':53,'Matthew Walton':50,'Gregory Walton':50,'Dave Stokes':50,'James Fouther':52,'Jim Ortega':46,'Robert Perkowski':51,'Tim Marchbank':44,'Mike Mensendick':46,'Ken Carbello':50,'Mike Bryant':51,'Roland Jones':53
      }},
      { date:'5/14/2024', course:'Broken Tee', par:36, scores:{
        'Chris Hemp':42,'Gamal Kader':45,'Jami Andregg':53,'Ken Walton':49,'Gregory Walton':52,'Dave Stokes':53,'Dwayne Crussell':44,'James Fouther':50,'Jim Ortega':50,'Robert Perkowski':52,'Zach Spratt':53,'Walter Jackson':44
      }},
      { date:'5/28/2024', course:'Kennedy', par:36, scores:{
        'Chris Hemp':41,'Gamal Kader':43,'Jami Andregg':52,'Ken Walton':49,'Matthew Walton':43,'Gregory Walton':49,'Darin Wayne':49,'Dave Stokes':53,'James Fouther':54,'Jim Ortega':52,'Robert Perkowski':52,'Tim Marchbank':44,'Walter Jackson':41,'Mike Mensendick':48,'Ken Carbello':50,'Mike Bryant':51,'Roland Jones':53
      }},
      { date:'6/4/2024', course:'Foothills', par:36, scores:{
        'Chris Hemp':46,'Gamal Kader':49,'Jami Andregg':49,'Ken Walton':44,'Matthew Walton':52,'Gregory Walton':47,'Dave Stokes':47,'James Fouther':55,'Jim Ortega':49,'Robert Perkowski':49,'Tim Marchbank':49,'Walter Jackson':49,'Mike Mensendick':44,'Reggie Gamlin':46,'Logan J':42,'Rob Sanchez':52,'Daniel Nunez':47,'Les Perry':49,'William Perkowski':52,'Rob Hoffschneider':46
      }},
      { date:'6/11/2024', course:'Overland', par:36, scores:{
        'Chris Hemp':38,'Gamal Kader':47,'Jami Andregg':49,'Ken Walton':44,'Matthew Walton':52,'Gregory Walton':45,'Darin Wayne':52,'Dave Stokes':50,'James Fouther':52,'Jim Ortega':48,'Robert Perkowski':41,'Tim Marchbank':47,'Walter Jackson':41,'Mike Mensendick':49,'Roland Jones':50,'Reggie Gamlin':42,'Daniel Nunez':44,'Les Perry':49,'William Perkowski':46,'Kim F':43
      }},
      { date:'6/18/2024', course:'Murphy Creek', par:36, scores:{
        'Chris Hemp':42,'Gamal Kader':50,'Jami Andregg':53,'Ken Walton':47,'Matthew Walton':52,'Gregory Walton':52,'Darin Wayne':49,'James Fouther':57,'Jim Ortega':47,'Robert Perkowski':48,'Tim Marchbank':49,'Walter Jackson':54,'Daniel Nunez':42,'Preston Bryant':49
      }},
      { date:'6/25/2024', course:'Meadows', par:36, scores:{
        'Chris Hemp':53,'Jim Ortega':48,'Robert Perkowski':48,'Tim Marchbank':49,'Ken Walton':51,'Matthew Walton':52,'Gregory Walton':57,'Dave Stokes':45,'James Fouther':53,'Dwayne Crussell':55
      }},
      { date:'7/9/2024', course:'Overland', par:36, scores:{
        'Chris Hemp':44,'Gamal Kader':45,'Jami Andregg':51,'Ken Walton':51,'Matthew Walton':43,'James Fouther':52,'Jim Ortega':46,'Robert Perkowski':45,'Tim Marchbank':45,'Zach Spratt':56,'Walter Jackson':40,'Ken Carbello':50,'Dallas Walton':47,'Daniel Nunez':44,'William Perkowski':51,'Ryan Marchbank':49,'Ken Walton':43
      }},
      { date:'7/16/2024', course:'Indian Tree', par:36, scores:{
        'Chris Hemp':40,'Gamal Kader':42,'Jami Andregg':50,'Ken Walton':51,'Matthew Walton':51,'Dwayne Crussell':55,'James Fouther':53,'Jim Ortega':46,'Tim Marchbank':51,'Zach Spratt':59,'Walter Jackson':43,'Mike Mensendick':45,'Ken Carbello':50,'Mike Bryant':51,'Roland Jones':53,'Reggie Gamlin':37,'Daniel Nunez':41,'Les Perry':41,'William Perkowski':46,'Ryan Marchbank':44,'Phillip Jackson':51,'Lonnie Dixon':47
      }},
      { date:'7/23/2024', course:'Kennedy', par:36, scores:{
        'Chris Hemp':43,'Jami Andregg':56,'Ken Walton':39,'Matthew Walton':55,'Dave Stokes':48,'James Fouther':55,'Jim Ortega':44,'Robert Perkowski':46,'Tim Marchbank':49,'Walter Jackson':49,'Reggie Gamlin':44,'Roland Jones':49,'Daniel Nunez':47,'William Perkowski':52,'Les Perry':41
      }},
      { date:'7/30/2024', course:'Riverdale', par:36, scores:{
        'Chris Hemp':41,'Gamal Kader':43,'Jami Andregg':53,'Ken Walton':46,'Matthew Walton':51,'Gregory Walton':48,'Dave Stokes':48,'Dwayne Crussell':59,'James Fouther':49,'Jim Ortega':44,'Robert Perkowski':39,'Tim Marchbank':42,'Zach Spratt':53,'Walter Jackson':42,'Ken Carbello':43,'Roland Jones':50,'Daniel Nunez':40
      }},
      { date:'8/6/2024', course:'Willis Case', par:36, scores:{
        'Chris Hemp':46,'Gamal Kader':46,'Jami Andregg':41,'Ken Walton':42,'Matthew Walton':46,'Gregory Walton':48,'Dave Stokes':43,'James Fouther':51,'Jim Ortega':45,'Robert Perkowski':47,'Tim Marchbank':43,'Walter Jackson':43,'Mike Mensendick':45,'Les Perry':41,'Reggie Gamlin':37,'Daniel Nunez':42,'William Perkowski':96
      }},
      { date:'8/13/2024', course:'Murphy Creek', par:36, scores:{
        'Chris Hemp':41,'Jami Andregg':53,'Ken Walton':50,'Matthew Walton':45,'Gregory Walton':49,'Dave Stokes':52,'James Fouther':57,'Robert Perkowski':45,'Tim Marchbank':41,'Walter Jackson':45,'Ken Carbello':45,'Ryan Marchbank':49,'Roland Jones':48,'Reggie Gamlin':44,'Victoria Braucher':53
      }},
      { date:'8/20/2024', course:'Common Ground', par:36, scores:{
        'Chris Hemp':41,'Gamal Kader':45,'Jami Andregg':59,'Ken Walton':45,'Matthew Walton':46,'Gregory Walton':53,'Dave Stokes':53,'James Fouther':60,'Jim Ortega':53,'Robert Perkowski':50,'Tim Marchbank':48,'Walter Jackson':45,'Mike Bryant':56,'William Perkowski':53
      }},
      { date:'8/27/2024', course:'City Park', par:70, scores:{
        'Chris Hemp':85,'Gamal Kader':87,'Jami Andregg':98,'Ken Walton':96,'Gregory Walton':95,'Dave Stokes':86,'James Fouther':98,'Robert Perkowski':87,'Walter Jackson':91,'Ken Carbello':45,'Ryan Marchbank':49,'Roland Jones':88,'Reggie Gamlin':89,'William Perkowski':96
      }},
      { date:'9/3/2024', course:'Westwoods', par:36, scores:{
        'Chris Hemp':43,'Matthew Walton':46,'James Fouther':50,'Jim Ortega':47,'Tim Marchbank':48,'Walter Jackson':43,'Ken Carbello':50,'Ryan Marchbank':47,'Lonnie Dixon':47
      }}
    ]
  },
  '2025': {
    weeks: [
      { date:'4/15/2025', course:'Kennedy', par:36, scores:{
        'Chris Hemp':38,'Dallas Walton':50,'Walter Jackson':51,'Jami Andregg':50,'Matthew Walton':47,'Ken Walton':44,'Robert Perkowski':45,'Gamal Kader':47,'Lonnie Dixon':49,'Ken Carbello':45,'Gregory Walton':45
      }},
      { date:'4/22/2025', course:'City Park', par:35, scores:{
        'Gamal Kader':40,'Ken Carbello':47,'Lonnie Dixon':42,'Robert Perkowski':44,'Walter Jackson':48,'Dallas Walton':51,'Jami Andregg':46,'Matthew Walton':46,'Ken Walton':42,'Jim Ortega':44,'Ryan Marchbank':39,'James Fouther':46,'Tim Marchbank':44,'William Perkowski':51,'Chris Hemp':43,'Gregory Walton':41
      }},
      { date:'4/29/2025', course:'Willis Case', par:36, scores:{
        'Jami Andregg':54,'Robert Perkowski':49,'Gamal Kader':48,'Ken Carbello':57,'Tim Marchbank':43,'Jim Ortega':50,'William Perkowski':50,'James Fouther':55,'Chris Hemp':45,'Ken Walton':48,'Robert Newell':23,'Ryan Marchbank':26
      }},
      { date:'5/13/2025', course:'Overland', par:36, scores:{
        'Matthew Walton':51,'Ken Walton':45,'Roland Jones':50,'Chris Hemp':45,'Jami Andregg':52,'Dallas Walton':55,'Ryan Marchbank':46,'Dwayne Crussell':51,'Lonnie Dixon':43,'Jim Ortega':47,'Gamal Kader':41,'Walter Jackson':45
      }},
      { date:'5/20/2025', course:'City Park', par:35, scores:{
        'Tim Marchbank':44,'Gamal Kader':48,'Lonnie Dixon':44,'Ken Walton':45,'Jim Ortega':42,'Matthew Walton':41,'Dallas Walton':45,'Jami Andregg':52,'Chris Hemp':40,'Roland Jones':47,'Dave Stokes':47,'Walter Jackson':44,'Robert Perkowski':48
      }},
      { date:'5/27/2025', course:'Overland', par:36, scores:{
        'Tim Marchbank':41,'Matthew Walton':45,'Lonnie Dixon':44,'James Fouther':49,'Rob Hoffschneider':42,'Jami Andregg':48,'Dallas Walton':45,'Chris Hemp':41,'Ken Walton':49,'Robert Perkowski':52,'Gamal Kader':45,'Ken Carbello':45,'Reggie Gamlin':43,'Jim Ortega':57,'Walter Jackson':48
      }},
      { date:'6/10/2025', course:'Willis Case', par:36, scores:{
        'Chris Hemp':43,'Dallas Walton':54,'Walter Jackson':42,'Phillip Jackson':55,'Jami Andregg':44,'Ken Walton':45,'Reggie Gamlin':48,'Dwayne Crussell':54,'Robert Perkowski':51,'Gamal Kader':47
      }},
      { date:'6/26/2025', course:'Westwoods', par:36, scores:{
        'Tim Marchbank':42,'Robert Perkowski':53,'Phillip Jackson':53,'Walter Jackson':49,'Gamal Kader':42,'Ken Walton':47,'Jerry Montoya':50,'William Perkowski':49,'Chris Hemp':49,'Lonnie Dixon':47,'James Fouther':51,'Jim Ortega':52,'Matthew Walton':53,'Jami Andregg':56,'Dallas Walton':54,'William Wittman':44,'Ben Pemble':54,'Evan Battey':66
      }},
      { date:'7/1/2025', course:'Kennedy', par:36, scores:{
        'Tim Marchbank':50,'Ryan Marchbank':54,'Micheal Bryant':50,'Lonnie Dixon':46,'Dave Stokes':51,'Carlos Bossy':49,'Denny Sharkey':44,'Ken Walton':46,'Walter Jackson':46,'Ben Pemble':54,'James Fouther':51,'Matthew Walton':52,'Chris Hemp':47,'Jami Andregg':54,'Gamal Kader':46,'Jim Ortega':50
      }},
      { date:'7/8/2025', course:'Walnut Creek', par:36, scores:{
        'Tim Marchbank':46,'Walter Jackson':41,'Robert Perkowski':47,'Lonnie Dixon':45,'Ben Pemble':58,'Gamal Kader':44,'Dallas Walton':47,'Denny Sharkey':43,'Ken Walton':46,'Chris Hemp':43,'Jim Ortega':46,'Carlos Bossy':44,'William Perkowski':50
      }},
      { date:'7/15/2025', course:'Kennedy', par:36, scores:{
        'Dallas Walton':53,'Ben Pemble':54,'Victoria':55,'Jami Andregg':52,'Chris Hemp':46,'Denny Sharkey':48,'Reggie Gamlin':48,'Walter Jackson':49,'Tim Marchbank':48,'Ken Walton':52,'Lonnie Dixon':46
      }},
      { date:'7/22/2025', course:'Westwoods', par:36, scores:{
        'Tim Marchbank':48,'Jim Ortega':48,'Matthew Walton':54,'Dallas Walton':50,'Ben Pemble':53,'Chris Hemp':51,'Lonnie Dixon':48,'Jami Andregg':50,'James Fouther':50,'Walter Jackson':48,'Ken Walton':50
      }},
      { date:'7/29/2025', course:'Foothills', par:36, scores:{
        'Matthew Walton':50,'Ken Walton':46,'Lonnie Dixon':52,'Phillip Jackson':59,'Walter Jackson':58,'Dallas Walton':47,'Ben Pemble':56,'Jim Ortega':49
      }},
      { date:'8/5/2025', course:'Willis Case', par:36, scores:{
        'William Wittman':44,'Ryan Marchbank':44,'Dallas Walton':50,'Matthew Walton':48,'Tim Marchbank':43,'Dave Stokes':53,'Ken Carbello':45,'Robert Perkowski':49,'Carlos Bossy':48,'Jim Ortega':49,'Lonnie Dixon':42
      }},
      { date:'8/12/2025', course:'Willis Case', par:36, scores:{
        'Gamal Kader':45,'Ken Carbello':48,'Denny Sharkey':47,'Lonnie Dixon':53,'James Fouther':52,'Gregory Walton':49,'Robert Perkowski':51,'Jami Andregg':49,'Brett':53,'Chris Hemp':44,'Tim Marchbank':45
      }},
      { date:'8/18/2025', course:'Indian Tree', par:36, scores:{
        'Ben Pemble':54,'Dallas Walton':42,'Matthew Walton':47,'Ryan Marchbank':46,'James Fouther':48,'Gregory Walton':42,'Ken Walton':46,'Lonnie Dixon':43,'Chris Hemp':40,'Jami Andregg':49,'Reggie Gamlin':40,'Robert Perkowski':45,'Denny Sharkey':43,'Gamal Kader':45,'Ken Carbello':40
      }},
      { date:'8/27/2025', course:'Overland', par:36, scores:{
        'Ryan Marchbank':46,'Lonnie Dixon':46,'Matthew Walton':55,'Jami Andregg':50,'Reggie Gamlin':43,'Ben Pemble':51,'Ryan Sims':48,'Chris Hemp':43,'Dave Stokes':48,'Ken Walton':40,'Gregory Walton':52,'Robert Perkowski':52,'Denny Sharkey':51
      }}
    ]
  }
};

let curPastSeason = '2025';
let curPastWeek = null;

function renderPastSeasons() {
  const pillsEl = document.getElementById('season-pills');
  const contentEl = document.getElementById('past-season-content');
  const seasons = Object.keys(PAST_SEASONS).sort();

  pillsEl.innerHTML = seasons.map(s => `
    <button class="week-pill ${s === curPastSeason ? 'active' : ''}" onclick="selectPastSeason('${s}')">${s} Season</button>
  `).join('');

  const season = PAST_SEASONS[curPastSeason];
  if (!season) { contentEl.innerHTML = '<div class="empty-state">No data for this season.</div>'; return; }

  const weeks = season.weeks;
  if (curPastWeek === null || curPastWeek >= weeks.length) curPastWeek = weeks.length - 1;

  // Week sub-pills
  let weekPills = '<div class="week-pills" style="margin-top:14px">' + weeks.map((w, i) => `
    <button class="week-pill ${i === curPastWeek ? 'active' : ''}" onclick="selectPastWeek(${i})">${w.date.split('/').slice(0,2).join('/')}</button>
  `).join('') + '</div>';

  const w = weeks[curPastWeek];
  const entries = Object.entries(w.scores).map(([name, score]) => ({ name, score, vsPar: score - w.par }))
    .sort((a, b) => a.score - b.score);

  // Season summary stats
  const allPlayers = {};
  weeks.forEach(wk => {
    Object.entries(wk.scores).forEach(([name, score]) => {
      if (!allPlayers[name]) allPlayers[name] = { rounds: 0, total: 0, best: Infinity };
      allPlayers[name].rounds++;
      allPlayers[name].total += score;
      if (score < allPlayers[name].best) allPlayers[name].best = score;
    });
  });
  const playerStats = Object.entries(allPlayers).map(([name, s]) => ({
    name, ...s, avg: (s.total / s.rounds).toFixed(1)
  })).sort((a, b) => parseFloat(a.avg) - parseFloat(b.avg));

  contentEl.innerHTML = `
    <div class="standings-meta" style="margin-top:16px">
      <div class="meta-stat"><div class="val">${Object.keys(allPlayers).length}</div><div class="lbl">Players</div></div>
      <div class="meta-stat"><div class="val">${weeks.length}</div><div class="lbl">Weeks</div></div>
      <div class="meta-stat"><div class="val">${playerStats[0]?.name || '—'}</div><div class="lbl">Lowest Avg (${playerStats[0]?.avg || '—'})</div></div>
    </div>
    ${weekPills}
    <div style="margin:16px 0 12px;display:flex;gap:20px;flex-wrap:wrap;align-items:center">
      <span style="font-family:'Outfit',sans-serif;font-size:1.15rem;color:var(--pink-hot);font-weight:700">
        ${escHtml(w.date)} — ${escHtml(w.course)}
      </span>
      <span style="font-size:0.78rem;color:var(--gray)">Par ${w.par} &middot; ${entries.length} players</span>
    </div>
    <div class="score-table-wrap">
      <table>
        <thead><tr><th>#</th><th>Player</th><th>Score</th><th>vs Par</th></tr></thead>
        <tbody>
          ${entries.map((e, i) => {
            const rc = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other';
            const vpc = e.vsPar < 0 ? 'score-under' : e.vsPar === 0 ? 'score-even' : 'score-over';
            return `<tr ${i === 0 ? 'class="leader"' : ''}>
              <td><span class="rank-badge ${rc}">${i + 1}</span></td>
              <td><strong>${escHtml(e.name)}</strong></td>
              <td style="font-weight:700;font-size:1rem">${e.score}</td>
              <td><span class="score-pill ${vpc}">${e.vsPar > 0 ? '+' : ''}${e.vsPar}</span></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
    <div class="card" style="margin-top:22px">
      <div class="card-title">${curPastSeason} Season Standings (by Avg Score)</div>
      <div class="score-table-wrap">
        <table>
          <thead><tr><th>#</th><th>Player</th><th>Rounds</th><th>Avg</th><th>Best</th></tr></thead>
          <tbody>
            ${playerStats.map((p, i) => {
              const rc = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other';
              return `<tr ${i === 0 ? 'class="leader"' : ''}>
                <td><span class="rank-badge ${rc}">${i + 1}</span></td>
                <td><strong>${escHtml(p.name)}</strong></td>
                <td>${p.rounds}</td>
                <td style="color:var(--pink-hot);font-weight:700">${p.avg}</td>
                <td>${p.best}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function selectPastSeason(s) {
  curPastSeason = s;
  curPastWeek = null;
  renderPastSeasons();
}
function selectPastWeek(i) {
  curPastWeek = i;
  renderPastSeasons();
}

/* ─── Pre-load roster if empty ─── */
async function preloadDataIfEmpty() {
  await loadState();
  if (state.players.length === 0) {
    const roster = [
      'Ben Pemble','Brooks O\'Hearn','Chris Hemp','Dallas Walton','Daniel Nunez',
      'Dave Stokes','Dwayne Crussell','Evan Battey','Gamal Kader','Gregory Walton',
      'Jami Andregg','James Fouther','Jerry Montoya','Jim Ortega','Ken Carbello',
      'Ken Walton','Kim F','Les Perry','Logan J','Lonnie Dixon',
      'Matthew Walton','Micheal Bryant','Mike Bryant','Mike Mensendick',
      'Phillip Jackson','Preston Bryant','Reggie Gamlin','Rob Hoffschneider',
      'Rob Sanchez','Robert Newell','Robert Perkowski','Roland Jones',
      'Roy Thomas','Ryan B','Ryan Marchbank','Tim Marchbank','Trey Turner',
      'Victoria Braucher','Walter Jackson','William Perkowski','William Wittman',
      'Zach Spratt','Denny Sharkey','Carlos Bossy','Ben Pemble','Brett',
      'Ryan Sims','Megan King','RJ Anchrum','Mamadou Kader','Mike Montoya'
    ];
    // Deduplicate
    const seen = new Set();
    roster.forEach(name => {
      const lower = name.toLowerCase();
      if (!seen.has(lower)) {
        seen.add(lower);
        state.players.push({ id: Date.now().toString() + Math.random().toString(36).slice(2,6), name, handicap: 0 });
      }
    });
    await saveState();
    renderAll();
  }
  // Start listening to Firebase for real-time RSVPs and payments
  listenToRSVPs();
  listenToPayments();
  loadEmailSentFlags();

  // Start countdown timer and auto-email checks
  countdownInterval = setInterval(() => {
    updateDeadlineDisplay();
    emailCheckCounter++;
    if (emailCheckCounter % 30 === 0 && isEditor) {
      checkAutoEmailTriggers();
    }
  }, 1000);
  updateDeadlineDisplay();

  // Check payment cutoff after data loads (give listeners time)
  setTimeout(enforcePaymentCutoff, 3000);
}

// Override the original load
preloadDataIfEmpty();
</script>
</body>
</html>
