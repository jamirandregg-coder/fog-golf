<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FOG - Friends of Golf</title>
<meta name="theme-color" content="#ff3da7">
<meta name="description" content="FOG Golf League - weekly scores, RSVP, live scoring, and standings">
<link rel="manifest" href="/manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FOG Golf">
<link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
<link rel="apple-touch-icon" href="/icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --pink-hot: #ff3da7;
    --pink-bright: #ff6fbf;
    --pink-light: #ff77c4;
    --pink-pale: #ffb8e0;
    --pink-deep: #e6007e;
    --dark: #0f0a10;
    --dark-card: #1a0e18;
    --dark-mid: #2d1228;
    --white: #ffffff;
    --white-soft: #fff0f7;
    --gray: #c090ad;
    --green-good: #00e676;
    --red-bad: #ff5252;
    --gold: #ffd700;
    --silver: #c0c0c0;
    --bronze: #cd7f32;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Space Grotesk', sans-serif;
    background: var(--dark);
    min-height: 100vh;
    color: var(--white);
    background-image:
      radial-gradient(ellipse at 15% 5%, rgba(255,61,167,0.25) 0%, transparent 50%),
      radial-gradient(ellipse at 85% 95%, rgba(255,61,167,0.18) 0%, transparent 50%),
      radial-gradient(ellipse at 50% 50%, rgba(230,0,126,0.1) 0%, transparent 60%);
  }

  /* HEADER */
  .header {
    text-align: center;
    padding: 40px 20px 10px;
    position: relative;
  }
  .header h1 {
    font-family: 'Outfit', sans-serif;
    font-size: clamp(3rem, 10vw, 5.5rem);
    font-weight: 900;
    background: linear-gradient(135deg, var(--pink-hot), var(--pink-light), var(--pink-hot));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: 0.15em;
    line-height: 1;
    text-shadow: none;
    filter: drop-shadow(0 0 40px rgba(255,61,167,0.6)) drop-shadow(0 0 80px rgba(255,61,167,0.3));
  }
  .header .subtitle {
    font-size: 0.9rem;
    color: var(--pink-light);
    letter-spacing: 0.35em;
    text-transform: uppercase;
    margin-top: 6px;
    font-weight: 400;
  }
  .header .golf-icon {
    font-size: 2rem;
    margin-bottom: 6px;
  }

  /* NAV */
  .nav-tabs {
    display: flex;
    justify-content: center;
    gap: 4px;
    padding: 20px 20px 24px;
    flex-wrap: wrap;
  }
  .nav-tab {
    padding: 10px 22px;
    border: 2px solid rgba(255,61,167,0.3);
    background: transparent;
    color: var(--pink-light);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 0.82rem;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 50px;
    transition: all 0.25s;
  }
  .nav-tab:hover {
    border-color: var(--pink-hot);
    color: var(--white);
    background: rgba(255,61,167,0.1);
  }
  .nav-tab.active {
    background: var(--pink-hot);
    color: var(--white);
    border-color: var(--pink-hot);
    box-shadow: 0 0 25px rgba(255,61,167,0.5), 0 0 50px rgba(255,61,167,0.2);
  }
  .nav-tab.editor-only { display: none; }
  body.editor-mode .nav-tab.editor-only { display: inline-block; }

  /* MODE BAR */
  .mode-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    padding: 6px 20px 4px;
  }
  .mode-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 14px;
    border-radius: 20px;
    font-size: 0.72rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-weight: 700;
  }
  .mode-viewer { background: rgba(255,255,255,0.08); color: var(--gray); border: 1px solid rgba(255,255,255,0.15); }
  .mode-editor { background: rgba(255,61,167,0.2); color: var(--pink-light); border: 1px solid rgba(255,61,167,0.5); }
  .mode-dot { width: 7px; height: 7px; border-radius: 50%; }
  .mode-viewer .mode-dot { background: var(--gray); }
  .mode-editor .mode-dot { background: var(--pink-hot); box-shadow: 0 0 6px var(--pink-hot); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
  .lock-btn {
    padding: 5px 14px;
    border: 1px solid rgba(255,61,167,0.3);
    background: transparent;
    color: var(--gray);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 20px;
    transition: all 0.2s;
    font-weight: 600;
  }
  .lock-btn:hover { border-color: var(--pink-hot); color: var(--pink-light); }

  /* CONTAINER */
  .container { max-width: 1100px; margin: 0 auto; padding: 0 20px 60px; }
  .panel { display: none; }
  .panel.active { display: block; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

  /* CARDS */
  .card {
    background: linear-gradient(135deg, rgba(255,61,167,0.06), rgba(255,61,167,0.02));
    border: 1px solid rgba(255,61,167,0.2);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 22px;
    backdrop-filter: blur(8px);
  }
  .card-title {
    font-family: 'Outfit', sans-serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--pink-hot);
    margin-bottom: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .card-title::before {
    content: '';
    display: inline-block;
    width: 4px;
    height: 22px;
    background: linear-gradient(180deg, var(--pink-hot), var(--pink-deep));
    border-radius: 2px;
  }

  /* VENMO BANNER */
  .venmo-banner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 14px;
    padding: 16px 24px;
    background: linear-gradient(135deg, rgba(255,61,167,0.15), rgba(230,0,126,0.1));
    border: 1px solid rgba(255,61,167,0.3);
    border-radius: 50px;
    margin: 0 auto 10px;
    max-width: 500px;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    color: var(--white);
  }
  .venmo-banner:hover {
    background: linear-gradient(135deg, rgba(255,61,167,0.3), rgba(230,0,126,0.25));
    border-color: var(--pink-hot);
    box-shadow: 0 0 30px rgba(255,61,167,0.4), 0 0 60px rgba(255,61,167,0.15);
    transform: translateY(-2px);
  }
  .venmo-banner .venmo-text {
    font-weight: 700;
    font-size: 0.95rem;
    letter-spacing: 0.05em;
  }
  .venmo-banner .venmo-sub {
    font-size: 0.75rem;
    color: var(--pink-light);
  }

  /* PWA INSTALL BANNER */
  .pwa-install-banner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 14px;
    padding: 14px 24px;
    background: linear-gradient(135deg, rgba(255,61,167,0.18), rgba(230,0,126,0.12));
    border: 1px solid rgba(255,61,167,0.4);
    border-radius: 50px;
    margin: 0 auto 10px;
    max-width: 500px;
    position: relative;
    animation: installGlow 3s ease-in-out infinite;
  }
  @keyframes installGlow {
    0%, 100% { box-shadow: 0 0 15px rgba(255,61,167,0.15); }
    50% { box-shadow: 0 0 30px rgba(255,61,167,0.35), 0 0 60px rgba(255,61,167,0.1); }
  }
  .pwa-install-banner .install-text {
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--white);
    letter-spacing: 0.05em;
  }
  .pwa-install-banner .install-sub {
    font-size: 0.72rem;
    color: var(--pink-light);
    letter-spacing: 0.03em;
  }
  .pwa-dismiss {
    position: absolute;
    top: -6px;
    right: -6px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 1px solid rgba(255,61,167,0.4);
    background: var(--dark-card);
    color: var(--gray);
    font-size: 0.85rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }
  .pwa-dismiss:hover { color: var(--white); border-color: var(--pink-hot); }

  /* NOTIFICATION PERMISSION BANNER */
  .notif-permission-banner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 14px;
    padding: 14px 24px;
    background: linear-gradient(135deg, rgba(255,200,50,0.15), rgba(255,160,20,0.10));
    border: 1px solid rgba(255,200,50,0.4);
    border-radius: 50px;
    margin: 0 auto 10px;
    max-width: 500px;
    position: relative;
    animation: notifGlow 3s ease-in-out infinite;
  }
  @keyframes notifGlow {
    0%, 100% { box-shadow: 0 0 15px rgba(255,200,50,0.12); }
    50% { box-shadow: 0 0 25px rgba(255,200,50,0.3), 0 0 50px rgba(255,200,50,0.08); }
  }
  .notif-permission-banner .notif-text {
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--white);
    letter-spacing: 0.05em;
  }
  .notif-permission-banner .notif-sub {
    font-size: 0.72rem;
    color: rgba(255,200,50,0.8);
    letter-spacing: 0.03em;
  }

  /* THIS WEEK HERO */
  .this-week-hero {
    background: linear-gradient(135deg, rgba(255,61,167,0.12), rgba(230,0,126,0.08));
    border: 1px solid rgba(255,61,167,0.3);
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 22px;
    text-align: center;
  }
  .this-week-hero h2 {
    font-family: 'Outfit', sans-serif;
    font-size: 1.6rem;
    font-weight: 800;
    color: var(--pink-hot);
    margin-bottom: 6px;
  }
  .this-week-hero .course-name {
    font-size: 1.2rem;
    color: var(--white);
    margin-bottom: 4px;
    font-weight: 600;
  }
  .this-week-hero .course-details {
    font-size: 0.88rem;
    color: var(--pink-light);
    margin-bottom: 14px;
  }
  .this-week-hero .course-details span {
    margin: 0 8px;
  }
  .rsvp-count-display {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 20px;
    background: rgba(255,61,167,0.15);
    border-radius: 50px;
    font-size: 0.88rem;
    color: var(--pink-light);
    font-weight: 600;
    margin-top: 8px;
  }
  .rsvp-count-display .count-num {
    font-size: 1.3rem;
    color: var(--pink-hot);
    font-weight: 800;
    font-family: 'Outfit', sans-serif;
  }

  /* RSVP */
  .rsvp-section { margin-top: 18px; }
  .rsvp-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 14px;
  }
  .rsvp-chip {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,61,167,0.15);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 0.88rem;
    transition: all 0.2s;
  }
  .rsvp-chip.rsvp-yes {
    border-color: rgba(0,230,118,0.4);
    background: rgba(0,230,118,0.08);
  }
  .rsvp-chip.rsvp-no {
    border-color: rgba(255,82,82,0.3);
    background: rgba(255,82,82,0.05);
    opacity: 0.6;
  }
  .rsvp-status {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 3px 10px;
    border-radius: 20px;
    cursor: pointer;
    border: none;
    font-family: 'Space Grotesk', sans-serif;
  }
  .rsvp-in { background: var(--green-good); color: var(--dark); }
  .rsvp-out { background: rgba(255,82,82,0.3); color: #ff8a8a; }
  .rsvp-pending { background: rgba(255,255,255,0.15); color: var(--gray); }
  .rsvp-paid { background: var(--green-good); color: var(--dark); font-size: 0.62rem; }
  .rsvp-unpaid { background: rgba(255,82,82,0.3); color: #ff8a8a; font-size: 0.62rem; }
  .rsvp-chip .chip-actions { display: flex; align-items: center; gap: 4px; }
  .rsvp-chip .paid-badge { font-size: 0.6rem; color: var(--green-good); font-weight: 700; letter-spacing: 0.08em; }
  .guest-badge { font-size:0.55rem; color:var(--gold,#ffd700); font-weight:700; letter-spacing:0.08em; padding:1px 6px; border:1px solid rgba(255,215,0,0.4); border-radius:4px; background:rgba(255,215,0,0.1); vertical-align:middle; margin-left:4px; }
  .guest-remove-btn { background:none; border:1px solid rgba(255,82,82,0.3); color:#ff5252; font-size:0.65rem; padding:2px 6px; border-radius:4px; cursor:pointer; }
  .guest-remove-btn:hover { background:rgba(255,82,82,0.15); }

  /* DEADLINE COUNTDOWN */
  .deadline-pill {
    display: inline-flex; align-items: center; gap: 8px;
    margin-top: 10px; padding: 8px 20px;
    background: rgba(255,61,167,0.1); border: 1px solid rgba(255,61,167,0.3);
    border-radius: 50px;
  }
  .deadline-pill .dl-label {
    font-size: 0.72rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--pink-light);
  }
  .deadline-pill .dl-time {
    font-family: 'Outfit', sans-serif; font-size: 1.1rem; color: var(--pink-hot); font-weight: 700;
  }
  .deadline-locked {
    display: inline-flex; align-items: center; gap: 6px;
    margin-top: 10px; padding: 8px 20px;
    background: rgba(255,82,82,0.12); border: 1px solid rgba(255,82,82,0.4);
    border-radius: 50px; color: var(--red-bad); font-weight: 700; font-size: 0.85rem;
  }

  /* ADMIN SUMMARY */
  .editor-only-card { display: none !important; }
  body.editor-mode .editor-only-card { display: block !important; }
  .summary-col-header { font-weight: 700; margin-bottom: 8px; font-size: 0.85rem; }
  .summary-player { display: flex; align-items: center; gap: 6px; padding: 3px 0; font-size: 0.85rem; }
  .summary-badge { font-size: 0.6rem; font-weight: 700; letter-spacing: 0.05em; padding: 1px 6px; border-radius: 8px; }
  .summary-badge-paid { background: rgba(0,230,118,0.15); color: var(--green-good); }
  .summary-badge-unpaid { background: rgba(255,82,82,0.15); color: #ff8a8a; }

  /* FORMS */
  .form-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 10px; }
  label {
    display: block;
    font-size: 0.72rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--pink-light);
    margin-bottom: 5px;
    font-weight: 600;
  }
  input, select, textarea {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,61,167,0.25);
    color: var(--white);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 0.88rem;
    padding: 10px 14px;
    border-radius: 10px;
    outline: none;
    transition: all 0.2s;
    width: 100%;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--pink-hot);
    background: rgba(255,61,167,0.08);
    box-shadow: 0 0 12px rgba(255,61,167,0.15);
  }
  select option { background: var(--dark); color: var(--white); }
  input::placeholder, textarea::placeholder { color: rgba(255,255,255,0.25); }
  input:disabled, select:disabled, textarea:disabled { opacity: 0.5; cursor: not-allowed; }
  .form-group { flex: 1; min-width: 130px; }
  .form-group.wide { min-width: 200px; flex: 2; }

  /* BUTTONS */
  .btn {
    padding: 10px 24px;
    border: none;
    border-radius: 50px;
    font-family: 'Space Grotesk', sans-serif;
    font-size: 0.82rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.25s;
    white-space: nowrap;
  }
  .btn-pink {
    background: linear-gradient(135deg, var(--pink-hot), var(--pink-deep));
    color: var(--white);
    box-shadow: 0 4px 18px rgba(255,61,167,0.4), 0 0 40px rgba(255,61,167,0.15);
  }
  .btn-pink:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px rgba(255,61,167,0.6), 0 0 60px rgba(255,61,167,0.25);
  }
  .btn-pink:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
  .btn-outline {
    background: transparent;
    border: 2px solid rgba(255,61,167,0.4);
    color: var(--pink-light);
  }
  .btn-outline:hover { border-color: var(--pink-hot); background: rgba(255,61,167,0.1); }
  .btn-danger {
    background: transparent;
    border: 1px solid rgba(255,82,82,0.4);
    color: #ff8a8a;
    font-size: 0.7rem;
    padding: 5px 10px;
    border-radius: 50px;
  }
  .btn-danger:hover { background: rgba(255,82,82,0.15); border-color: #ff5252; }

  /* TABLES */
  .score-table-wrap { overflow-x: auto; border-radius: 12px; }
  table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
  th {
    background: rgba(255,61,167,0.12);
    color: var(--pink-hot);
    font-family: 'Outfit', sans-serif;
    font-weight: 700;
    padding: 12px 14px;
    text-align: left;
    border-bottom: 1px solid rgba(255,61,167,0.2);
    white-space: nowrap;
    font-size: 0.8rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  td { padding: 11px 14px; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--white); vertical-align: middle; }
  tr:hover td { background: rgba(255,61,167,0.04); }
  tr.leader td { background: rgba(255,61,167,0.08); }

  /* RANK BADGES */
  .rank-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-weight: 800;
    font-size: 0.75rem;
    font-family: 'Outfit', sans-serif;
  }
  .rank-1 { background: var(--gold); color: var(--dark); }
  .rank-2 { background: var(--silver); color: var(--dark); }
  .rank-3 { background: var(--bronze); color: var(--white); }
  .rank-other { background: rgba(255,255,255,0.1); color: var(--gray); }

  /* SCORE PILLS */
  .score-pill { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.78rem; font-weight: 700; }
  .score-under { background: rgba(0,230,118,0.15); color: var(--green-good); }
  .score-even  { background: rgba(255,215,0,0.15); color: var(--gold); }
  .score-over  { background: rgba(255,82,82,0.15); color: var(--red-bad); }

  /* STANDINGS META */
  .standings-meta { display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 20px; }
  .meta-stat {
    background: linear-gradient(135deg, rgba(255,61,167,0.08), rgba(255,61,167,0.03));
    border: 1px solid rgba(255,61,167,0.2);
    border-radius: 12px;
    padding: 14px 20px;
    text-align: center;
    flex: 1;
    min-width: 110px;
  }
  .meta-stat .val {
    font-family: 'Outfit', sans-serif;
    font-size: 1.8rem;
    color: var(--pink-hot);
    font-weight: 800;
    line-height: 1;
  }
  .meta-stat .lbl {
    font-size: 0.68rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--pink-light);
    margin-top: 4px;
    font-weight: 600;
  }

  /* WEEK PILLS */
  .week-pills { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 18px; }
  .week-pill {
    padding: 7px 16px;
    border: 1px solid rgba(255,61,167,0.25);
    background: transparent;
    color: var(--gray);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 0.78rem;
    font-weight: 600;
    cursor: pointer;
    border-radius: 50px;
    transition: all 0.2s;
  }
  .week-pill:hover { border-color: var(--pink-hot); color: var(--pink-light); }
  .week-pill.active { background: var(--pink-hot); color: var(--white); border-color: var(--pink-hot); }

  /* PLAYERS */
  .player-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 14px; }
  .player-chip {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,61,167,0.15);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 0.88rem;
    transition: all 0.2s;
  }
  .player-chip:hover { border-color: rgba(255,61,167,0.4); }
  .player-num { font-size: 0.7rem; color: var(--pink-hot); font-weight: 700; margin-right: 6px; min-width: 18px; }

  /* SCORE ENTRY */
  .score-input-cell input {
    width: 70px;
    padding: 6px 8px;
    font-size: 0.85rem;
    text-align: center;
    border-radius: 8px;
  }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 36px;
    color: rgba(255,255,255,0.25);
    font-style: italic;
    font-size: 0.9rem;
  }
  .flag { font-size: 0.7rem; color: var(--pink-hot); letter-spacing: 0.1em; font-weight: 600; }

  /* SCHEDULE CARD */
  .schedule-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,61,167,0.12);
    border-radius: 12px;
    margin-bottom: 10px;
    transition: all 0.2s;
  }
  .schedule-item:hover { border-color: rgba(255,61,167,0.3); }
  .schedule-week-num {
    font-family: 'Outfit', sans-serif;
    font-size: 1.4rem;
    font-weight: 800;
    color: var(--pink-hot);
    min-width: 50px;
    text-align: center;
  }
  .schedule-info { flex: 1; }
  .schedule-info .course { font-weight: 600; font-size: 0.95rem; }
  .schedule-info .details { font-size: 0.78rem; color: var(--gray); margin-top: 2px; }
  .schedule-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .badge-upcoming { background: rgba(255,61,167,0.2); color: var(--pink-hot); }
  .badge-completed { background: rgba(0,230,118,0.15); color: var(--green-good); }
  .badge-current { background: var(--pink-hot); color: var(--white); animation: pulse 2s infinite; }

  /* MODAL */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(26,10,18,0.9);
    backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center;
    z-index: 200;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--dark-card);
    border: 1px solid rgba(255,61,167,0.4);
    border-radius: 20px;
    padding: 38px;
    width: 100%;
    max-width: 400px;
    text-align: center;
    transform: translateY(20px);
    transition: transform 0.25s;
    box-shadow: 0 20px 60px rgba(255,61,167,0.3), 0 0 100px rgba(255,61,167,0.1);
  }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal h2 { font-family: 'Outfit', sans-serif; color: var(--pink-hot); font-size: 1.5rem; font-weight: 800; margin-bottom: 8px; }
  .modal p { font-size: 0.85rem; color: var(--gray); margin-bottom: 22px; line-height: 1.6; }
  .modal input { text-align: center; letter-spacing: 0.2em; font-size: 1rem; margin-bottom: 12px; }
  .modal-actions { display: flex; gap: 10px; justify-content: center; }
  .modal-error { color: var(--red-bad); font-size: 0.78rem; margin-bottom: 10px; min-height: 18px; }

  /* LOADING & TOAST */
  .loading-bar {
    position: fixed; top: 0; left: 0; right: 0; height: 3px;
    background: linear-gradient(90deg, var(--dark), var(--pink-hot), var(--pink-light), var(--pink-hot), var(--dark));
    background-size: 200%;
    animation: shimmer 1.5s infinite;
    z-index: 300;
    display: none;
  }
  .loading-bar.show { display: block; }
  @keyframes shimmer { 0%{background-position:100%} 100%{background-position:-100%} }
  .toast {
    position: fixed; bottom: 24px; right: 24px;
    background: var(--dark-card);
    border: 1px solid var(--pink-hot);
    color: var(--white);
    padding: 14px 22px;
    border-radius: 12px;
    font-size: 0.85rem;
    box-shadow: 0 8px 30px rgba(255,61,167,0.3);
    z-index: 100;
    transform: translateY(80px); opacity: 0;
    transition: all 0.3s;
    font-weight: 600;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* LIVE SCORING */
  .scorecard-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .scorecard { width: 100%; border-collapse: collapse; font-size: 0.82rem; min-width: 600px; }
  .scorecard th, .scorecard td { padding: 8px 6px; text-align: center; border: 1px solid rgba(255,61,167,0.12); white-space: nowrap; }
  .scorecard th { background: rgba(255,61,167,0.12); color: var(--pink-hot); font-size: 0.72rem; letter-spacing: 0.05em; text-transform: uppercase; font-family: 'Outfit', sans-serif; font-weight: 700; }
  .scorecard th.hole-par { font-weight: 400; font-size: 0.65rem; color: var(--gray); text-transform: none; letter-spacing: 0; }
  .scorecard td.player-name { text-align: left; font-weight: 600; position: sticky; left: 0; background: var(--dark); z-index: 2; min-width: 100px; border-right: 2px solid rgba(255,61,167,0.2); }
  .scorecard td.score-cell { min-width: 38px; }
  .scorecard td.score-birdie { background: rgba(255,61,167,0.18); color: var(--pink-hot); font-weight: 800; text-shadow: 0 0 8px rgba(255,61,167,0.4); }
  .scorecard td.score-eagle { background: rgba(255,61,167,0.3); color: var(--pink-bright); font-weight: 800; }
  .scorecard td.score-par { color: var(--white); }
  .scorecard td.score-bogey { color: rgba(255,82,82,0.7); }
  .scorecard td.score-dbl { color: rgba(255,82,82,0.5); }
  .scorecard td.total-cell { font-weight: 800; font-family: 'Outfit', sans-serif; font-size: 1rem; border-left: 2px solid rgba(255,61,167,0.2); }
  .scorecard tr:hover td { background: rgba(255,61,167,0.04); }
  .scorecard tr:hover td.player-name { background: rgba(255,61,167,0.06); }

  .score-entry-row { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
  .hole-input-group { display: flex; flex-direction: column; align-items: center; gap: 2px; }
  .hole-input-group .hole-label { font-size: 0.65rem; color: var(--pink-hot); font-weight: 700; letter-spacing: 0.05em; }
  .hole-input-group .par-label { font-size: 0.6rem; color: var(--gray); }
  .hole-input-group input {
    width: 44px; height: 40px; text-align: center; font-size: 1rem; font-weight: 700;
    padding: 4px; border-radius: 8px; font-family: 'Outfit', sans-serif;
    background: rgba(255,255,255,0.06); border: 1px solid rgba(255,61,167,0.25); color: var(--white);
  }
  .hole-input-group input:focus { border-color: var(--pink-hot); background: rgba(255,61,167,0.1); box-shadow: 0 0 10px rgba(255,61,167,0.2); }
  .hole-input-group input.input-birdie { border-color: var(--pink-hot); background: rgba(255,61,167,0.15); color: var(--pink-hot); }
  .hole-input-group input.input-bogey { border-color: rgba(255,82,82,0.4); background: rgba(255,82,82,0.08); }

  .scoring-total { display: flex; gap: 16px; align-items: center; padding: 10px 16px; background: rgba(255,61,167,0.08); border-radius: 10px; margin-top: 8px; }
  .scoring-total .st-label { font-size: 0.72rem; color: var(--gray); text-transform: uppercase; letter-spacing: 0.1em; }
  .scoring-total .st-value { font-family: 'Outfit', sans-serif; font-size: 1.3rem; font-weight: 800; color: var(--pink-hot); }

  /* ROUND STATUS */
  .round-status-badge {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 6px 16px; border-radius: 50px; font-size: 0.75rem; font-weight: 700;
    letter-spacing: 0.08em; text-transform: uppercase;
  }
  .round-status-setup { background: rgba(255,255,255,0.1); color: var(--gray); border: 1px solid rgba(255,255,255,0.2); }
  .round-status-open { background: rgba(0,230,118,0.15); color: var(--green-good); border: 1px solid rgba(0,230,118,0.3); }
  .round-status-closed { background: rgba(255,82,82,0.15); color: var(--red-bad); border: 1px solid rgba(255,82,82,0.3); }

  /* SKINS & PAYOUTS */
  .payout-card { margin-top: 22px; }
  .payout-section { margin-bottom: 18px; }
  .payout-section-title { font-family: 'Outfit', sans-serif; font-size: 1rem; font-weight: 700; color: var(--pink-hot); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
  .payout-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 12px; border-radius: 8px; margin-bottom: 4px; font-size: 0.85rem; }
  .payout-row:nth-child(even) { background: rgba(255,255,255,0.02); }
  .payout-winner { color: var(--pink-hot); font-weight: 700; }
  .payout-amount { font-family: 'Outfit', sans-serif; font-weight: 700; color: var(--green-good); }
  .payout-push { color: var(--gray); font-style: italic; }
  .payout-birdie-tag { font-size: 0.65rem; background: rgba(255,61,167,0.2); color: var(--pink-hot); padding: 1px 6px; border-radius: 8px; font-weight: 700; margin-left: 4px; }
  .earnings-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-radius: 8px; font-size: 0.88rem; }
  .earnings-positive { color: var(--green-good); font-weight: 700; }
  .earnings-negative { color: var(--red-bad); }
  .earnings-even { color: var(--gray); }

  /* COURSE SETUP */
  .par-inputs-row { display: flex; gap: 4px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 12px; }
  .par-hole-group { display: flex; flex-direction: column; align-items: center; gap: 2px; }
  .par-hole-group .hole-num { font-size: 0.65rem; color: var(--pink-hot); font-weight: 700; }
  .par-hole-group input { width: 44px; text-align: center; padding: 6px 4px; font-size: 0.9rem; }
  .par-hole-group label.ctp-label { font-size: 0.55rem; color: var(--gray); letter-spacing: 0; text-transform: none; margin: 0; display: flex; align-items: center; gap: 2px; cursor: pointer; }
  .par-hole-group label.ctp-label input[type="checkbox"] { width: auto; margin: 0; }

  /* FRONT/BACK 9 TOGGLE */
  .nine-toggle { display: inline-flex; border: 1px solid rgba(255,61,167,0.3); border-radius: 50px; overflow: hidden; margin-bottom: 10px; }
  .nine-btn { padding: 7px 18px; background: transparent; border: none; color: var(--pink-light); font-family: 'Space Grotesk', sans-serif; font-size: 0.78rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
  .nine-btn.active { background: var(--pink-hot); color: var(--white); }
  .nine-btn:hover:not(.active) { background: rgba(255,61,167,0.15); }

  /* SAVED COURSES LIST */
  .saved-course-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,61,167,0.12); border-radius: 10px; margin-bottom: 6px; font-size: 0.88rem; gap: 8px; }
  .saved-course-item .course-name { font-weight: 600; color: var(--white); }
  .saved-course-item .course-pars-preview { font-size: 0.72rem; color: var(--gray); }
  .saved-course-item .course-actions { display: flex; gap: 6px; flex-shrink: 0; }
  .saved-course-item .course-actions button { font-size: 0.6rem; padding: 3px 8px; border-radius: 6px; cursor: pointer; font-family: 'Space Grotesk', sans-serif; border: 1px solid rgba(255,61,167,0.3); background: none; color: var(--pink-light); }
  .saved-course-item .course-actions button:hover { border-color: var(--pink-hot); color: var(--pink-hot); }

  /* WINNER BANNER */
  .winner-banner {
    display: none;
    max-width: 500px;
    margin: 0 auto 6px;
    padding: 14px 24px;
    background: linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,61,167,0.1), rgba(255,215,0,0.08));
    border: 1px solid rgba(255,215,0,0.4);
    border-radius: 50px;
    text-align: center;
    position: relative;
    overflow: hidden;
    animation: winnerGlow 3s ease-in-out infinite;
  }
  .winner-banner.visible { display: block; }
  @keyframes winnerGlow {
    0%, 100% { box-shadow: 0 0 20px rgba(255,215,0,0.2), 0 0 40px rgba(255,61,167,0.1); }
    50% { box-shadow: 0 0 35px rgba(255,215,0,0.4), 0 0 70px rgba(255,61,167,0.2); }
  }
  .winner-trophy {
    font-size: 1.8rem;
    display: inline-block;
    animation: trophyPulse 2s ease-in-out infinite;
    filter: drop-shadow(0 0 12px rgba(255,215,0,0.7));
  }
  @keyframes trophyPulse {
    0%, 100% { transform: scale(1); filter: drop-shadow(0 0 12px rgba(255,215,0,0.7)); }
    50% { transform: scale(1.12); filter: drop-shadow(0 0 20px rgba(255,215,0,1)) drop-shadow(0 0 40px rgba(255,215,0,0.5)); }
  }
  .winner-label {
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--gold);
    font-weight: 700;
    margin-bottom: 2px;
  }
  .winner-name {
    font-family: 'Outfit', sans-serif;
    font-size: 1.25rem;
    font-weight: 800;
    color: var(--white);
    text-shadow: 0 0 20px rgba(255,215,0,0.4);
  }
  .winner-details {
    font-size: 0.75rem;
    color: var(--pink-light);
    margin-top: 2px;
  }
  .winner-details .winner-score {
    font-family: 'Outfit', sans-serif;
    font-weight: 700;
    color: var(--gold);
  }

  /* SEASON CHAMPION BANNER */
  .season-champ-banner {
    max-width: 540px;
    margin: 0 auto 10px;
    padding: 22px 28px;
    background: linear-gradient(135deg, rgba(255,215,0,0.22), rgba(255,140,0,0.15), rgba(255,61,167,0.08), rgba(255,215,0,0.14));
    border: 2px solid rgba(255,215,0,0.7);
    border-radius: 18px;
    text-align: center;
    position: relative;
    overflow: hidden;
    animation: champGlow 4s ease-in-out infinite;
  }
  .season-champ-banner::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: conic-gradient(from 0deg, transparent, rgba(255,215,0,0.08), transparent, rgba(255,215,0,0.05), transparent);
    animation: champSpin 8s linear infinite;
  }
  @keyframes champSpin { 100% { transform: rotate(360deg); } }
  @keyframes champGlow {
    0%, 100% { box-shadow: 0 0 30px rgba(255,215,0,0.35), 0 0 60px rgba(255,140,0,0.2), inset 0 0 30px rgba(255,215,0,0.05); }
    50% { box-shadow: 0 0 50px rgba(255,215,0,0.55), 0 0 100px rgba(255,140,0,0.3), inset 0 0 40px rgba(255,215,0,0.1); }
  }
  .season-champ-banner .champ-trophy {
    font-size: 2.8rem;
    display: inline-block;
    position: relative;
    animation: trophyPulse 2s ease-in-out infinite;
    filter: drop-shadow(0 0 18px rgba(255,215,0,0.9));
  }
  .season-champ-banner .champ-label {
    font-size: 0.72rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--gold);
    font-weight: 700;
    margin-bottom: 4px;
    position: relative;
  }
  .season-champ-banner .champ-name {
    font-family: 'Outfit', sans-serif;
    font-size: 1.7rem;
    font-weight: 800;
    color: var(--white);
    text-shadow: 0 0 30px rgba(255,215,0,0.6), 0 2px 4px rgba(0,0,0,0.3);
    position: relative;
  }
  .season-champ-banner .champ-details {
    font-size: 0.82rem;
    color: var(--pink-light);
    margin-top: 4px;
    position: relative;
  }
  .season-champ-banner .champ-details span {
    font-family: 'Outfit', sans-serif;
    font-weight: 700;
    color: var(--gold);
  }

  /* TEE TIMES & PAIRINGS */
  .tee-times-row { display: flex; gap: 6px; flex-wrap: wrap; align-items: flex-end; }
  .tee-time-slot { display: flex; flex-direction: column; align-items: center; gap: 2px; }
  .tee-time-slot .slot-label { font-size: 0.6rem; color: var(--pink-hot); font-weight: 700; }
  .tee-time-slot input { width: 90px; padding: 6px 8px; font-size: 0.85rem; text-align: center; }
  .tee-time-slot .remove-slot { font-size: 0.6rem; color: var(--red-bad); cursor: pointer; background: none; border: none; font-family: 'Space Grotesk', sans-serif; }
  .add-tee-time-btn {
    font-size: 0.72rem; padding: 6px 12px; border: 1px dashed rgba(255,61,167,0.4);
    background: transparent; color: var(--pink-light); border-radius: 8px; cursor: pointer;
    font-family: 'Space Grotesk', sans-serif; font-weight: 600; align-self: center;
  }
  .add-tee-time-btn:hover { border-color: var(--pink-hot); color: var(--pink-hot); }

  .pairings-card { margin-top: 16px; }
  .pairing-group {
    background: rgba(255,61,167,0.04); border: 1px solid rgba(255,61,167,0.15);
    border-radius: 12px; padding: 14px 16px; margin-bottom: 10px;
  }
  .pairing-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
  }
  .pairing-tee-time {
    font-family: 'Outfit', sans-serif; font-size: 1rem; font-weight: 700; color: var(--pink-hot);
  }
  .pairing-group-label { font-size: 0.68rem; color: var(--gray); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600; }
  .pairing-players { display: flex; flex-wrap: wrap; gap: 6px; }
  .pairing-player {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 6px 14px; background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,61,167,0.2); border-radius: 20px;
    font-size: 0.85rem; font-weight: 600;
  }
  .pairing-player .pairing-num { font-size: 0.65rem; color: var(--pink-hot); font-weight: 800; }

  /* PAIRINGS TAB - EXPANDABLE WEEKS */
  .pairings-week-section { margin-bottom: 10px; }
  .pairings-week-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; border-radius: 10px; cursor: pointer;
    background: rgba(255,61,167,0.06); border: 1px solid rgba(255,61,167,0.15);
    transition: all 0.2s;
  }
  .pairings-week-header:hover { background: rgba(255,61,167,0.1); border-color: rgba(255,61,167,0.3); }
  .pairings-week-header.pw-current {
    background: rgba(255,61,167,0.12); border-color: rgba(255,61,167,0.4);
  }
  .pairings-week-header .pw-left { display: flex; align-items: center; gap: 10px; }
  .pairings-week-header .pw-week-num {
    font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 0.9rem; color: var(--pink-hot);
  }
  .pairings-week-header .pw-course { font-size: 0.85rem; font-weight: 600; color: var(--white); }
  .pairings-week-header .pw-date { font-size: 0.72rem; color: var(--gray); }
  .pairings-week-header .pw-badge {
    font-size: 0.6rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase;
    padding: 3px 8px; border-radius: 12px;
    background: var(--pink-hot); color: var(--white);
  }
  .pairings-week-header .pw-chevron {
    font-size: 0.8rem; color: var(--gray); transition: transform 0.25s;
  }
  .pairings-week-header.pw-expanded .pw-chevron { transform: rotate(180deg); }
  .pairings-week-body {
    max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
    padding: 0 4px;
  }
  .pairings-week-body.pw-open { max-height: 1200px; padding: 10px 4px 4px; }
  .pairings-week-body .pairing-group { margin-bottom: 8px; }
  .pw-no-pairings { font-size: 0.82rem; color: var(--gray); padding: 8px 0; }
  .pw-player-count { font-size: 0.72rem; color: var(--gray); margin-left: 4px; }

  /* SCHEDULE RSVP */
  .sched-rsvp-toggle {
    display: flex; align-items: center; gap: 6px; margin-top: 8px; cursor: pointer;
    font-size: 0.75rem; color: var(--pink-light); font-weight: 600;
  }
  .sched-rsvp-toggle:hover { color: var(--pink-hot); }
  .sched-rsvp-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
    gap: 6px; margin-top: 8px; padding-top: 8px;
    border-top: 1px solid rgba(255,61,167,0.1);
  }
  .sched-rsvp-chip {
    display: flex; align-items: center; justify-content: space-between;
    background: rgba(255,255,255,0.03); border: 1px solid rgba(255,61,167,0.1);
    border-radius: 8px; padding: 6px 10px; font-size: 0.78rem;
  }
  .sched-rsvp-chip.sched-yes { border-color: rgba(0,230,118,0.3); background: rgba(0,230,118,0.05); }
  .sched-rsvp-chip.sched-no { border-color: rgba(255,82,82,0.2); background: rgba(255,82,82,0.03); opacity: 0.6; }
  .sched-rsvp-btn {
    font-size: 0.62rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em;
    padding: 2px 8px; border-radius: 12px; cursor: pointer; border: none;
    font-family: 'Space Grotesk', sans-serif;
  }
  .sched-btn-in { background: var(--green-good); color: var(--dark); }
  .sched-btn-out { background: rgba(255,82,82,0.3); color: #ff8a8a; }
  .sched-btn-pending { background: rgba(255,255,255,0.15); color: var(--gray); }
  .sched-rsvp-count {
    font-size: 0.78rem; color: var(--pink-light); font-weight: 600;
  }
  .sched-rsvp-count .sched-count-num { color: var(--pink-hot); font-weight: 800; font-family: 'Outfit', sans-serif; }
  .schedule-item { cursor: default; }
  .schedule-item .sched-expand { transition: all 0.3s; overflow: hidden; }

  /* CONTEST SELECTS */
  .contest-select-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 10px; }
  .contest-select-row .form-group { min-width: 160px; }

  /* SCORING MODE TOGGLE */
  .scoring-mode-toggle {
    display: inline-flex;
    border: 1px solid rgba(255,61,167,0.3);
    border-radius: 50px;
    overflow: hidden;
    margin-bottom: 6px;
  }
  .smode-btn {
    padding: 7px 18px;
    background: transparent;
    border: none;
    color: var(--pink-light);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 0.78rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }
  .smode-btn.active { background: var(--pink-hot); color: var(--white); }
  .smode-btn:hover:not(.active) { background: rgba(255,61,167,0.15); }

  /* GROUP SCORER ASSIGNMENT (admin) */
  .group-scorer-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
  .group-scorer-label { font-size: 0.82rem; font-weight: 600; color: var(--pink-light); min-width: 80px; }
  .group-scorer-select {
    padding: 6px 12px; border-radius: 8px;
    border: 1px solid rgba(255,61,167,0.3);
    background: var(--dark-card); color: var(--white);
    font-family: 'Space Grotesk', sans-serif; font-size: 0.82rem;
  }

  /* GROUP SCORING HEADER */
  .group-scoring-header { font-size: 0.85rem; color: var(--gray); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .group-scoring-badge {
    display: inline-block; padding: 3px 10px; border-radius: 20px;
    font-size: 0.65rem; font-weight: 700; letter-spacing: 0.1em;
    background: rgba(255,61,167,0.2); color: var(--pink-hot);
    border: 1px solid rgba(255,61,167,0.4);
  }

  /* GROUP SCORECARD - GOLF SCORECARD STYLE */
  .group-scorecard-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 12px; }
  .group-scorecard {
    width: 100%; border-collapse: collapse; min-width: 520px;
  }
  .group-scorecard th, .group-scorecard td {
    padding: 6px 4px; text-align: center;
    border: 1px solid rgba(255,61,167,0.15); white-space: nowrap;
  }
  .group-scorecard th {
    background: rgba(255,61,167,0.12); color: var(--pink-hot);
    font-size: 0.7rem; font-weight: 700; letter-spacing: 0.04em;
    text-transform: uppercase; font-family: 'Outfit', sans-serif;
  }
  .group-scorecard th.gs-par-header {
    font-weight: 400; font-size: 0.6rem; color: var(--gray);
    text-transform: none; letter-spacing: 0; background: rgba(255,61,167,0.06);
  }
  .group-scorecard td.gs-player-name {
    text-align: left; font-weight: 600; font-size: 0.78rem;
    position: sticky; left: 0; background: var(--dark); z-index: 2;
    min-width: 80px; max-width: 110px;
    border-right: 2px solid rgba(255,61,167,0.2);
    color: var(--pink-light); padding: 6px 8px;
    overflow: hidden; text-overflow: ellipsis;
  }
  .group-scorecard td.gs-player-name.gs-scorer { color: var(--pink-hot); }
  .group-scorecard td.gs-total {
    font-weight: 800; font-family: 'Outfit', sans-serif;
    font-size: 0.95rem; border-left: 2px solid rgba(255,61,167,0.2);
    min-width: 44px;
  }
  .group-scorecard td.gs-vs-par { font-size: 0.75rem; font-weight: 600; min-width: 40px; }
  .group-scorecard input.gs-score-input {
    width: 36px; height: 32px; text-align: center; font-size: 0.88rem; font-weight: 700;
    padding: 2px; border-radius: 6px; font-family: 'Outfit', sans-serif;
    background: rgba(255,255,255,0.06); border: 1px solid rgba(255,61,167,0.2); color: var(--white);
    -moz-appearance: textfield;
  }
  .group-scorecard input.gs-score-input::-webkit-outer-spin-button,
  .group-scorecard input.gs-score-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .group-scorecard input.gs-score-input:focus {
    border-color: var(--pink-hot); background: rgba(255,61,167,0.1);
    box-shadow: 0 0 8px rgba(255,61,167,0.2); outline: none;
  }
  .group-scorecard input.gs-score-input.gs-birdie { border-color: var(--pink-hot); background: rgba(255,61,167,0.15); color: var(--pink-hot); }
  .group-scorecard input.gs-score-input.gs-bogey { border-color: rgba(255,82,82,0.4); background: rgba(255,82,82,0.08); }
  .group-scorecard input.gs-score-input:disabled { opacity: 0.5; cursor: not-allowed; }
  .group-scorecard .gs-score-display {
    font-size: 0.88rem; font-weight: 700; min-width: 36px; display: inline-block;
  }
  .group-scorecard .gs-score-display.gs-birdie { color: var(--pink-hot); }
  .group-scorecard .gs-score-display.gs-bogey { color: rgba(255,82,82,0.7); }

  /* GROUP LOCKED MESSAGE */
  .group-locked-message {
    display: flex; align-items: center; gap: 14px;
    padding: 18px 22px; background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,61,167,0.15); border-radius: 12px;
  }
  .group-locked-icon { font-size: 1.8rem; }
  .group-locked-text { font-size: 0.88rem; color: var(--gray); line-height: 1.5; }
  .group-locked-text strong { color: var(--pink-hot); }

  /* GROUP SCORECARD TOTALS ROW */
  .group-scorecard-totals {
    display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px;
  }
  .gs-player-total {
    display: flex; align-items: center; gap: 6px;
    padding: 6px 12px; border-radius: 8px;
    background: rgba(255,61,167,0.06); font-size: 0.8rem;
  }
  .gs-player-total .gs-pt-name { color: var(--pink-light); font-weight: 600; }
  .gs-player-total .gs-pt-score { color: var(--white); font-weight: 800; font-family: 'Outfit', sans-serif; }

  /* WHATSAPP FLOATING BUTTON */
  .whatsapp-float {
    position: fixed; bottom: 24px; right: 20px; width: 56px; height: 56px;
    background: linear-gradient(135deg, #25D366, #128C7E); border-radius: 50%;
    box-shadow: 0 4px 16px rgba(37,211,102,0.4), 0 0 30px rgba(37,211,102,0.15);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; z-index: 1000; transition: all 0.3s; text-decoration: none; border: none;
  }
  .whatsapp-float:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 6px 24px rgba(37,211,102,0.5); }
  .whatsapp-float svg { width: 30px; height: 30px; fill: white; }
  .whatsapp-label {
    position: fixed; bottom: 84px; right: 14px;
    background: rgba(37,211,102,0.9); color: white;
    padding: 6px 12px; border-radius: 8px;
    font-size: 0.7rem; font-weight: 600; white-space: nowrap; z-index: 1000;
    pointer-events: none; opacity: 0; transition: opacity 0.3s;
  }
  .whatsapp-float:hover + .whatsapp-label { opacity: 1; }

  /* ANNOUNCEMENT BANNER */
  .announcement-banner {
    background: linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,165,0,0.08));
    border: 1px solid rgba(255,215,0,0.35); border-radius: 12px;
    padding: 14px 20px; margin: 0 20px 16px; position: relative;
    animation: announcePulse 3s ease-in-out infinite;
  }
  @keyframes announcePulse {
    0%, 100% { box-shadow: 0 0 10px rgba(255,215,0,0.15); }
    50% { box-shadow: 0 0 20px rgba(255,215,0,0.3); }
  }
  .announcement-content { display: flex; flex-direction: column; align-items: center; text-align: center; }
  .announcement-icon { font-size: 1.3rem; }
  .announcement-text { color: var(--white); font-size: 0.9rem; font-weight: 600; line-height: 1.4; text-align: center; }
  .announcement-date { font-size: 0.65rem; color: var(--gray); margin-top: 4px; display: block; text-align: center; }
  .announcement-close {
    position: absolute; top: 6px; right: 8px; background: none; border: none;
    color: var(--gray); font-size: 1.2rem; cursor: pointer; padding: 2px 6px; line-height: 1;
  }
  .announcement-close:hover { color: var(--white); }

  /* RESPONSIVE */
  @media (max-width: 600px) {
    .card { padding: 18px; border-radius: 12px; }
    th, td { padding: 8px 10px; }
    .this-week-hero { padding: 20px; }
    .header h1 { font-size: clamp(2.5rem, 10vw, 5.5rem); }
    .venmo-banner { flex-direction: column; gap: 6px; text-align: center; padding: 14px 20px; }
    .schedule-item { flex-direction: column; text-align: center; gap: 8px; }
    .hole-input-group input { width: 38px; height: 36px; font-size: 0.9rem; }
    .par-hole-group input { width: 38px; }
    .scorecard td.player-name { min-width: 80px; font-size: 0.75rem; }
    .group-scorecard input.gs-score-input { width: 32px; height: 28px; font-size: 0.8rem; }
    .group-scorecard td.gs-player-name { min-width: 65px; max-width: 80px; font-size: 0.7rem; padding: 4px 6px; }
    .group-scorecard th, .group-scorecard td { padding: 4px 2px; }
    .group-scorecard th { font-size: 0.62rem; }
    .group-scorecard { min-width: 440px; }
  }
</style>
</head>
<body>

<div class="loading-bar" id="loading-bar"></div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <h2>Editor Access</h2>
    <p>Enter the league admin password to manage players, scores, and schedule.</p>
    <input type="password" id="modal-pw" placeholder="Password" onkeydown="if(event.key==='Enter')submitPassword()">
    <div class="modal-error" id="modal-error"></div>
    <div class="modal-actions">
      <button class="btn btn-pink" onclick="submitPassword()">Unlock</button>
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="header">
  <div class="golf-icon">&#9971;</div>
  <h1>FOG</h1>
  <div class="subtitle">Friends of Golf</div>
</div>

<div style="padding: 0 20px 4px;">
  <div class="season-champ-banner" id="season-champ-banner">
    <div class="champ-trophy">üèÜ</div>
    <div class="champ-label">2025 Season Champion</div>
    <div class="champ-name" id="champ-name"></div>
    <div class="champ-details" id="champ-details"></div>
  </div>
  <div class="winner-banner" id="winner-banner">
    <div class="winner-trophy">üèÜ</div>
    <div class="winner-label">This Week's Champion</div>
    <div class="winner-name" id="winner-name"></div>
    <div class="winner-details" id="winner-details"></div>
  </div>
</div>

<div style="padding: 8px 20px;">
  <a class="venmo-banner" id="venmo-link" href="https://venmo.com/Jami-Andregg" target="_blank" rel="noopener">
    <span style="font-size:1.4rem">&#128176;</span>
    <div>
      <div class="venmo-text">Pay League Dues via Venmo</div>
      <div class="venmo-sub">Tap to open Venmo</div>
    </div>
    <span style="font-size:1.1rem">&#8594;</span>
  </a>
</div>

<!-- PWA Install Banner -->
<div style="padding: 0 20px 4px;">
  <div class="pwa-install-banner" id="pwa-install-banner" style="display:none">
    <button class="pwa-dismiss" onclick="dismissInstallBanner()" aria-label="Dismiss">&times;</button>
    <span style="font-size:1.4rem">&#9971;</span>
    <div>
      <div class="install-text"><span class="install-btn-text">Install FOG App</span></div>
      <div class="install-sub">Add to home screen for full-screen access</div>
    </div>
    <button class="btn btn-pink" style="padding:8px 18px;font-size:0.75rem" onclick="handleInstallClick()">Install</button>
  </div>
</div>

<!-- Announcement Banner (admin-posted, shown to all) -->
<div id="announcement-banner-container"></div>

<!-- Notification Permission Banner (shown to users who haven't enabled push) -->
<div class="notif-permission-banner" id="notif-permission-banner" style="display:none">
  <button class="pwa-dismiss" onclick="dismissNotificationBanner()" aria-label="Dismiss">&times;</button>
  <span style="font-size:1.4rem">üîî</span>
  <div>
    <div class="notif-text">Turn On Notifications</div>
    <div class="notif-sub">Get alerts when scoring opens &amp; results are posted</div>
  </div>
  <button class="btn btn-pink" style="padding:8px 18px;font-size:0.75rem" onclick="handleEnableNotifications()">Enable</button>
</div>

<div class="mode-bar">
  <div class="mode-badge mode-viewer" id="mode-badge">
    <span class="mode-dot"></span>
    <span id="mode-label">View Only</span>
  </div>
  <button class="lock-btn" id="lock-btn" onclick="handleLockBtn()">Admin Login</button>
</div>

<div class="nav-tabs">
  <button class="nav-tab active"       onclick="showPanel('home',this)">This Week</button>
  <button class="nav-tab"              onclick="showPanel('live-scoring',this)">Live Scoring</button>
  <button class="nav-tab"              onclick="showPanel('pairings',this)">Pairings</button>
  <button class="nav-tab"              onclick="showPanel('standings',this)">Standings</button>
  <button class="nav-tab"              onclick="showPanel('history',this)">Scores</button>
  <button class="nav-tab"              onclick="showPanel('schedule',this)">Schedule</button>
  <button class="nav-tab"              onclick="showPanel('past-seasons',this)">Past Seasons</button>
  <button class="nav-tab editor-only"  onclick="showPanel('scores',this)">Enter Scores</button>
  <button class="nav-tab editor-only"  onclick="showPanel('players',this)">Players</button>
  <button class="nav-tab editor-only"  onclick="showPanel('manage-week',this)">Manage Week</button>
</div>

<div class="container">

  <!-- THIS WEEK / RSVP PANEL -->
  <div id="panel-home" class="panel active">
    <div class="this-week-hero" id="this-week-hero">
      <h2>This Week's Round</h2>
      <div class="course-name" id="tw-course">No course set yet</div>
      <div class="course-details" id="tw-details"></div>
      <div class="rsvp-count-display" id="tw-rsvp-count"></div>
      <div id="rsvp-deadline-display"></div>
    </div>

    <div class="card">
      <div class="card-title">RSVP for This Week</div>
      <p style="font-size:0.85rem;color:var(--gray);margin-bottom:12px">Tap your name to toggle your RSVP status.</p>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:16px;flex-wrap:wrap">
        <input type="text" id="guest-name-input" placeholder="Guest name..." style="flex:1;min-width:140px;padding:8px 12px;border-radius:8px;border:1px solid rgba(255,61,167,0.3);background:rgba(255,255,255,0.05);color:var(--white);font-family:'Space Grotesk',sans-serif;font-size:0.85rem" onkeydown="if(event.key==='Enter')addGuest()">
        <button class="btn btn-outline" style="font-size:0.78rem;padding:8px 16px" onclick="addGuest()">+ Add Guest</button>
      </div>
      <div class="rsvp-grid" id="rsvp-list">
        <div class="empty-state" style="grid-column:1/-1">No players yet. Admin must add players first.</div>
      </div>
    </div>

    <!-- Admin RSVP Summary (visible only in editor mode) -->
    <div class="card editor-only-card" id="admin-rsvp-summary">
      <div class="card-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
        <span>RSVP Summary</span>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-outline" style="font-size:0.7rem;padding:6px 14px" onclick="sendRSVPEmail()">Email Summary</button>
        </div>
      </div>
      <div id="admin-summary-content"></div>
    </div>

    <!-- Pairings Display (visible to everyone when pairings exist) -->
    <div class="card" id="pairings-card" style="display:none">
      <div class="card-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
        <span>Tee Time Pairings</span>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-outline editor-only-card" style="font-size:0.7rem;padding:6px 14px" onclick="generatePairings()">Regenerate</button>
        </div>
      </div>
      <div id="pairings-content"></div>
    </div>
  </div>

  <!-- LIVE SCORING PANEL -->
  <div id="panel-live-scoring" class="panel">
    <div class="card">
      <div class="card-title" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
        <span>Live Scoring</span>
        <span id="round-status-badge" class="round-status-badge round-status-setup">Setup</span>
      </div>
      <!-- Round controls are in Manage Week panel -->
      <!-- Player score entry -->
      <div id="live-score-entry" style="margin-bottom:20px">
        <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;margin-bottom:14px">
          <div class="form-group" style="min-width:180px;max-width:250px">
            <label>Enter Scores For</label>
            <select id="live-player-select" onchange="renderLiveScoreInputs()">
              <option value="">‚Äî Select Your Name ‚Äî</option>
            </select>
          </div>
        </div>
        <div id="live-hole-inputs"></div>
        <div id="live-score-total" class="scoring-total" style="display:none"></div>
        <div style="margin-top:10px">
          <button class="btn btn-pink" id="save-live-scores-btn" onclick="saveLiveScores()" style="display:none">Save Scores</button>
        </div>
      </div>
      <!-- Full scorecard grid -->
      <div class="card-title" style="margin-top:10px">Scorecard</div>
      <div class="scorecard-wrap">
        <div id="live-scorecard-grid"><div class="empty-state">Waiting for scores...</div></div>
      </div>
    </div>

    <!-- Skins & Payout Results (shown after round closes) -->
    <div id="payout-results" class="card payout-card" style="display:none">
      <div class="card-title">Round Payouts</div>
      <div id="payout-content"></div>
    </div>

    <!-- Contest Winner Selection (admin only, after round closes) -->
    <div id="contest-selection" class="card" style="display:none">
      <div class="card-title">Select Contest Winners</div>
      <div id="contest-selection-content"></div>
    </div>
  </div>

  <!-- PAIRINGS PANEL -->
  <div id="panel-pairings" class="panel">
    <div class="card">
      <div class="card-title">Group Pairings</div>
      <div id="pairings-tab-content"><div class="empty-state">Loading pairings...</div></div>
    </div>
  </div>

  <!-- STANDINGS PANEL -->
  <div id="panel-standings" class="panel">
    <div id="standings-meta" class="standings-meta"></div>
    <div class="card">
      <div class="card-title">Season Standings</div>
      <div class="score-table-wrap">
        <table>
          <thead><tr><th>#</th><th>Player</th><th>Rounds</th><th>Total</th><th>Avg</th><th>Best</th><th>vs Par</th></tr></thead>
          <tbody id="standings-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- HISTORY PANEL -->
  <div id="panel-history" class="panel">
    <div class="card">
      <div class="card-title">Week-by-Week Scores</div>
      <div class="week-pills" id="week-pills"></div>
      <div id="history-content"><div class="empty-state">No scores saved yet.</div></div>
    </div>
  </div>

  <!-- SCHEDULE PANEL -->
  <div id="panel-schedule" class="panel">
    <!-- Admin: Add/Edit Schedule -->
    <div class="card editor-only-card">
      <div class="card-title">Add to Schedule</div>
      <div class="form-row">
        <div class="form-group">
          <label>Week #</label>
          <select id="sched-week-select"></select>
        </div>
        <div class="form-group wide">
          <label>Course</label>
          <input type="text" id="sched-course-input" list="sched-course-datalist" placeholder="e.g. Kennedy..." autocomplete="off">
          <datalist id="sched-course-datalist"></datalist>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="sched-date-input">
        </div>
        <div class="form-group">
          <label>Par</label>
          <input type="number" id="sched-par-input" value="36" min="27" max="80" style="width:80px">
        </div>
      </div>
      <div style="margin-top:10px">
        <label style="margin-bottom:6px;display:block">Tee Times (up to 6)</label>
        <div class="tee-times-row" id="sched-tee-times-row">
          <div class="tee-time-slot">
            <span class="slot-label">T1</span>
            <input type="time" class="sched-tee-input" value="14:00">
          </div>
        </div>
        <button class="add-tee-time-btn" onclick="addSchedTeeTime()" style="margin-top:6px">+ Add Tee Time</button>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-pink" onclick="saveScheduleWeek()">Save Week</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Season Schedule</div>
      <div id="schedule-list">
        <div class="empty-state">No schedule set yet. Admin can add course info each week.</div>
      </div>
    </div>
  </div>

  <!-- PAST SEASONS PANEL -->
  <div id="panel-past-seasons" class="panel">
    <div class="card">
      <div class="card-title">Past Seasons</div>
      <div class="week-pills" id="season-pills"></div>
      <div id="past-season-content"><div class="empty-state">Select a season above.</div></div>
    </div>
  </div>

  <!-- ENTER SCORES PANEL (editor) -->
  <div id="panel-scores" class="panel">
    <div class="card">
      <div class="card-title">Select Week &amp; Course</div>
      <div class="form-row">
        <div class="form-group">
          <label>Week</label>
          <select id="week-select" onchange="renderScoreEntry()"></select>
        </div>
        <div class="form-group">
          <label>Par</label>
          <input type="number" id="par-input" value="72" min="60" max="80" style="width:90px">
        </div>
        <div class="form-group wide">
          <label>Course Name</label>
          <input type="text" id="course-input" placeholder="e.g. Pebble Beach...">
        </div>
        <div style="padding-bottom:1px">
          <button class="btn btn-pink" id="save-scores-btn" onclick="saveScores()">Save Scores</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Score Entry</div>
      <div id="score-entry-area"><div class="empty-state">Add players first, then enter scores here.</div></div>
    </div>
  </div>

  <!-- PLAYERS PANEL (editor) -->
  <div id="panel-players" class="panel">
    <div class="card">
      <div class="card-title">Add Players</div>
      <div class="form-row">
        <div class="form-group wide">
          <label>Player Name</label>
          <input type="text" id="player-name-input" placeholder="Enter name..." onkeydown="if(event.key==='Enter')addPlayer()">
        </div>
        <div class="form-group">
          <label>Handicap</label>
          <input type="number" id="player-handicap-input" placeholder="0" min="0" max="54" style="width:100px" onkeydown="if(event.key==='Enter')addPlayer()">
        </div>
        <div style="padding-bottom:1px">
          <button class="btn btn-pink" onclick="addPlayer()">+ Add Player</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Roster <span id="roster-count" style="font-size:0.85rem;color:var(--gray);font-family:'Space Grotesk',sans-serif;"></span></div>
      <div class="player-grid" id="player-list">
        <div class="empty-state" style="grid-column:1/-1">No players yet.</div>
      </div>
    </div>
  </div>

  <!-- MANAGE WEEK PANEL (editor) -->
  <div id="panel-manage-week" class="panel">
    <div class="card">
      <div class="card-title">Set This Week's Info</div>
      <p style="font-size:0.85rem;color:var(--gray);margin-bottom:16px">This info shows on the "This Week" tab for all players.</p>
      <div class="form-row">
        <div class="form-group">
          <label>Current Week #</label>
          <select id="current-week-select"></select>
        </div>
        <div class="form-group wide">
          <label>Course Name</label>
          <input type="text" id="tw-course-input" list="course-datalist" placeholder="e.g. Kennedy..." autocomplete="off">
          <datalist id="course-datalist"></datalist>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="tw-date-input">
        </div>
        <div class="form-group">
          <label>Par</label>
          <input type="number" id="tw-par-input" value="72" min="60" max="80" style="width:90px">
        </div>
      </div>
      <div style="margin-top:10px">
        <label style="margin-bottom:6px;display:block">Tee Times (up to 6)</label>
        <div class="tee-times-row" id="tw-tee-times-row">
          <div class="tee-time-slot">
            <span class="slot-label">T1</span>
            <input type="time" class="tw-tee-input" value="14:00">
          </div>
        </div>
        <button class="add-tee-time-btn" onclick="addManageWeekTeeTime()" style="margin-top:6px">+ Add Tee Time</button>
      </div>
      <div class="form-row">
        <div class="form-group wide">
          <label>Notes (optional)</label>
          <textarea id="tw-notes-input" rows="2" placeholder="e.g. Bring cash for skins..."></textarea>
        </div>
      </div>
      <!-- Hole-by-Hole Par Setup -->
      <div style="margin-top:18px;padding-top:14px;border-top:1px solid rgba(255,61,167,0.15)">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px">
          <label style="margin-bottom:0">Hole-by-Hole Pars (9 Holes)</label>
        </div>
        <div class="nine-toggle" id="nine-toggle">
          <button type="button" class="nine-btn active" data-nine="front" onclick="selectNine('front')">Front 9</button>
          <button type="button" class="nine-btn" data-nine="back" onclick="selectNine('back')">Back 9</button>
        </div>
        <div class="par-inputs-row" id="par-holes-row"></div>
        <div style="margin-top:8px">
          <label style="margin-bottom:6px;display:block">Long Drive Hole</label>
          <select id="long-drive-select" style="width:140px">
            <option value="">None</option>
          </select>
        </div>
      </div>

      <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-pink" onclick="saveThisWeek()">Save This Week</button>
        <button class="btn btn-outline" onclick="generatePairings()">Generate Pairings</button>
        <button class="btn btn-outline" onclick="markAllPaid()">Mark All In as Paid</button>
        <button class="btn btn-outline" onclick="resetPayments()">Reset Payments</button>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-outline" id="btn-open-scoring" onclick="openScoring()" style="display:none">Open Scoring</button>
        <button class="btn btn-pink" id="btn-close-scoring" onclick="closeScoring()" style="display:none">Close & Calculate</button>
        <button class="btn btn-outline" id="btn-reopen-scoring" onclick="reopenScoring()" style="display:none">Reopen Scoring</button>
      </div>

      <!-- Scoring Mode Toggle -->
      <div style="margin-top:16px;padding-top:14px;border-top:1px solid rgba(255,61,167,0.15)" id="scoring-mode-section">
        <label style="margin-bottom:8px;display:block">Scoring Mode</label>
        <div class="scoring-mode-toggle" id="scoring-mode-toggle">
          <button type="button" class="smode-btn active" data-mode="individual" onclick="setScoringMode('individual')">Individual</button>
          <button type="button" class="smode-btn" data-mode="group" onclick="setScoringMode('group')">Group</button>
        </div>
        <p style="font-size:0.72rem;color:var(--gray);margin-top:6px" id="scoring-mode-desc">Each player enters their own scores.</p>
        <div id="group-scorer-assignment" style="display:none;margin-top:12px">
          <label style="margin-bottom:6px;display:block">Group Scorers</label>
          <div id="group-scorer-list"></div>
        </div>
      </div>

      <p style="font-size:0.72rem;color:var(--gray);margin-top:10px">Auto-emails send if this page is open at Sunday 2 PM & Monday 8 AM. Use the manual button in the RSVP Summary as backup.</p>
    </div>

    <!-- Announcements & Notifications Card (admin only) -->
    <div class="card editor-only-card">
      <div class="card-title">Announcements & Notifications</div>

      <!-- In-App Announcement -->
      <div style="margin-bottom:20px">
        <h3 style="font-size:0.9rem;color:var(--pink-light);margin-bottom:8px">üì£ In-App Announcement</h3>
        <p style="font-size:0.78rem;color:var(--gray);margin-bottom:8px">Post a banner all players see when they open the app.</p>
        <div class="form-group wide" style="margin-bottom:8px">
          <textarea id="announcement-text" rows="2" placeholder="e.g. League championship next week!" maxlength="200" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,61,167,0.3);background:var(--dark-card);color:var(--white);font-family:'Space Grotesk',sans-serif;font-size:0.85rem;resize:vertical"></textarea>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-pink" style="font-size:0.78rem;padding:8px 16px" onclick="saveAnnouncement()">Post Announcement</button>
          <button class="btn btn-outline" style="font-size:0.78rem;padding:8px 16px" onclick="clearAnnouncement()">Clear</button>
        </div>
      </div>

      <!-- Push Notification -->
      <div style="border-top:1px solid rgba(255,61,167,0.15);padding-top:16px">
        <h3 style="font-size:0.9rem;color:var(--pink-light);margin-bottom:8px">üì≤ Push Notification</h3>
        <p style="font-size:0.78rem;color:var(--gray);margin-bottom:8px">Send a push notification to all subscribed devices.</p>
        <div class="form-group wide" style="margin-bottom:6px">
          <label>Title</label>
          <input type="text" id="notif-title" placeholder="e.g. FOG Update" maxlength="50">
        </div>
        <div class="form-group wide" style="margin-bottom:8px">
          <label>Message</label>
          <textarea id="notif-message" rows="2" placeholder="e.g. Don't forget to RSVP!" maxlength="200" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,61,167,0.3);background:var(--dark-card);color:var(--white);font-family:'Space Grotesk',sans-serif;font-size:0.85rem;resize:vertical"></textarea>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn btn-pink" style="font-size:0.78rem;padding:8px 16px" onclick="sendPushNotification()">Send Notification</button>
          <span id="notif-status" style="font-size:0.72rem;color:var(--gray)"></span>
        </div>
        <p id="fcm-subscriber-count" style="font-size:0.72rem;color:var(--gray);margin-top:8px"></p>
      </div>
    </div>

    <!-- Manage Courses Card (admin only) -->
    <div class="card editor-only-card">
      <div class="card-title" style="cursor:pointer" onclick="toggleCourseManager()">
        Manage Courses <span id="course-mgr-arrow" style="font-size:0.8rem;transition:transform 0.2s;display:inline-block">&#9654;</span>
      </div>
      <div id="course-manager" style="display:none">
        <p style="font-size:0.85rem;color:var(--gray);margin-bottom:12px">Save courses with 18-hole pars. When you select a course above and pick Front/Back 9, pars auto-fill.</p>
        <div class="form-row">
          <div class="form-group wide">
            <label>Course Name</label>
            <input type="text" id="cm-course-name" placeholder="e.g. Kennedy Golf Course">
          </div>
        </div>
        <label style="margin-bottom:6px;display:block">Front 9 Pars (H1&ndash;H9)</label>
        <div class="par-inputs-row" id="cm-front-pars"></div>
        <label style="margin-bottom:6px;display:block">Back 9 Pars (H10&ndash;H18)</label>
        <div class="par-inputs-row" id="cm-back-pars"></div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-pink" onclick="saveMasterCourse()">Save Course</button>
          <button class="btn btn-outline" onclick="clearCourseForm()">Clear</button>
        </div>
        <div style="margin-top:18px;border-top:1px solid rgba(255,61,167,0.15);padding-top:14px">
          <label>Saved Courses</label>
          <div id="saved-courses-list" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>
<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script>
/* ‚îÄ‚îÄ‚îÄ PWA: Service Worker + Install Prompt ‚îÄ‚îÄ‚îÄ */

// Register service worker with auto-update
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js')
    .then(reg => {
      console.log('SW registered:', reg.scope);
      // Check for updates every 60 seconds
      setInterval(() => reg.update(), 60000);
      // When a new SW is waiting, activate it immediately
      reg.addEventListener('updatefound', () => {
        const newWorker = reg.installing;
        if (newWorker) {
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'activated') {
              console.log('New version available ‚Äî reloading.');
              window.location.reload();
            }
          });
        }
      });
    })
    .catch(err => console.warn('SW registration failed:', err));
  // If the controller changes (new SW took over), reload to get fresh content
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    window.location.reload();
  });
}

// Generate apple-touch-icon via canvas (for iOS home screen icon)
(function generateAppleTouchIcon() {
  try {
    const canvas = document.createElement('canvas');
    canvas.width = 180;
    canvas.height = 180;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#0f0a10';
    ctx.fillRect(0, 0, 180, 180);
    ctx.fillStyle = '#ff3da7';
    ctx.font = '900 72px Arial Black, Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('FOG', 90, 78);
    ctx.fillStyle = '#ff77c4';
    ctx.font = '700 24px Arial, sans-serif';
    ctx.fillText('GOLF', 90, 130);
    const link = document.createElement('link');
    link.rel = 'apple-touch-icon';
    link.href = canvas.toDataURL('image/png');
    document.head.appendChild(link);
  } catch (e) { /* canvas not supported */ }
})();

// Capture beforeinstallprompt for Android/Chrome install button
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredInstallPrompt = e;
  showInstallBanner();
});

window.addEventListener('appinstalled', () => {
  hideInstallBanner();
  deferredInstallPrompt = null;
  localStorage.setItem('fog-pwa-installed', 'true');
});

function isStandalone() {
  return window.matchMedia('(display-mode: standalone)').matches
    || window.navigator.standalone === true;
}

function showInstallBanner() {
  const banner = document.getElementById('pwa-install-banner');
  if (!banner) return;
  if (isStandalone()) return;
  if (localStorage.getItem('fog-pwa-installed') === 'true') return;
  if (localStorage.getItem('fog-pwa-dismissed')) {
    const dismissed = parseInt(localStorage.getItem('fog-pwa-dismissed'), 10);
    if (Date.now() - dismissed < 7 * 24 * 60 * 60 * 1000) return;
  }
  banner.style.display = 'flex';
}

function hideInstallBanner() {
  const banner = document.getElementById('pwa-install-banner');
  if (banner) banner.style.display = 'none';
}

function dismissInstallBanner() {
  hideInstallBanner();
  localStorage.setItem('fog-pwa-dismissed', Date.now().toString());
}

async function handleInstallClick() {
  if (deferredInstallPrompt) {
    deferredInstallPrompt.prompt();
    const result = await deferredInstallPrompt.userChoice;
    if (result.outcome === 'accepted') {
      localStorage.setItem('fog-pwa-installed', 'true');
    }
    deferredInstallPrompt = null;
    hideInstallBanner();
  } else {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS) {
      alert('To install: Tap the Share button (box with arrow) at the bottom of Safari, then tap "Add to Home Screen"');
    } else {
      alert('Use your browser menu (three dots) and tap "Add to Home Screen" or "Install App"');
    }
  }
}

// Show install banner for iOS Safari (doesn't fire beforeinstallprompt)
setTimeout(() => {
  if (!isStandalone() && !deferredInstallPrompt) {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
    if (isIOS && isSafari) {
      showInstallBanner();
      const btnText = document.querySelector('#pwa-install-banner .install-btn-text');
      if (btnText) btnText.textContent = 'Add to Home Screen';
    }
  }
}, 3000);

/* ‚îÄ‚îÄ‚îÄ App Constants ‚îÄ‚îÄ‚îÄ */
const ADMIN_PASSWORD = 'golf2025';
const TOTAL_WEEKS    = 20;
const STORAGE_KEY    = 'fog-league-v2';

/* ‚îÄ‚îÄ‚îÄ Firebase Init ‚îÄ‚îÄ‚îÄ */
const firebaseConfig = {
  apiKey: "AIzaSyD8swdfrbrzGsvP--QYL0fuWE_cp7zk7HE",
  authDomain: "fog-golf.firebaseapp.com",
  projectId: "fog-golf",
  storageBucket: "fog-golf.firebasestorage.app",
  messagingSenderId: "865532832027",
  appId: "1:865532832027:web:389127ab5a9f01d2e28bbe",
  databaseURL: "https://fog-golf-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ‚îÄ‚îÄ FCM / Push Notification Config ‚îÄ‚îÄ
const FCM_VAPID_KEY = 'BLt-nddGQquAs8gM9EVd5NRFNQ7WszqVMkQhbE3gPxZzE7VZH5UMAJ1OCIDNLn2KHrcsWW2--N7lR8SPfUgwvKQ';
const CLOUD_FUNCTION_URL = 'https://us-central1-fog-golf.cloudfunctions.net/sendNotification';
let messaging = null;
let currentFCMToken = null;
let announcementListener = null;

let isEditor = false;
let state = {
  players: [],
  weeks: {},
  thisWeek: { weekNum: 1, course: '', date: '', time: '', par: 72, notes: '' }
};
let rsvpData = {};       // Populated by Firebase listener: { weekNum: { playerId: status } }
let rsvpListener = null; // Track current Firebase listener
let paymentData = {};       // Populated by Firebase: { weekNum: { playerId: true/false } }
let paymentListener = null;
let curHistoryWeek = null;
let countdownInterval = null;
let emailCheckCounter = 0;
let emailSentFlags = {};

/* ‚îÄ‚îÄ‚îÄ Live Scoring State ‚îÄ‚îÄ‚îÄ */
let liveScoresData = {};     // { playerId: [s1,s2,...,s9] }
let liveScoresListener = null;
let roundStatus = 'setup';   // 'setup' | 'open' | 'closed'
let roundStatusListener = null;
let courseSetupData = {};     // { pars: [...], ctpHoles: [...], longDriveHole: null }
let courseSetupListener = null;
let contestsData = {};       // { ctp: { holeIdx: playerId }, longDrive: playerId }
let contestsListener = null;
let scheduleData = {};       // { weekNum: { course, date, teeTimes, par } }
let scheduleListener = null;
let scheduleRsvpData = {};   // { weekNum: { playerId: status } }
let scheduleRsvpListeners = {};
let expandedScheduleWeeks = {};  // track which weeks have RSVP expanded
let pairingsData = {};       // { weekNum: [ { teeTime, players: [id,...] }, ... ] }
let pairingsListener = null;
let allPairingsListener = null;
let rsvpOverrideLocked = false;    // admin manual RSVP lock override
let scoringMode = 'individual';    // 'individual' | 'group'
let scoringModeListener = null;
let groupScorersData = {};         // { groupIndex: playerId }
let groupScorersListener = null;
let thisWeekListener = null;
let groupSaveTimers = {};           // debounce timers for auto-saving group scores
let masterCourses = {};      // { courseId: { name, pars: [18 ints] } }
let masterCoursesListener = null;
let weekResultsListener = null;  // Firebase listener for week results (cross-device sync)
let pendingSyncs = {};           // { weekNum: weekResult } ‚Äî queued writes that failed to sync
let selectedNine = 'front';  // 'front' or 'back'
let guestData = {};          // { weekNum: { guestId: guestObj } }
let guestListener = null;

/* ‚îÄ‚îÄ‚îÄ EmailJS Config (update after setting up emailjs.com) ‚îÄ‚îÄ‚îÄ */
const EMAILJS_PUBLIC_KEY  = '-IFkOARWCJ652xybq';
const EMAILJS_SERVICE_ID  = 'service_snxugu5';
const EMAILJS_TEMPLATE_ID = 'template_tcwdgrp';
const ADMIN_EMAIL = 'jamirandregg@gmail.com';

/* ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ */
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function setLoading(v) { document.getElementById('loading-bar').classList.toggle('show', v); }
let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

/* ‚îÄ‚îÄ‚îÄ RSVP Deadline ‚îÄ‚îÄ‚îÄ */
function getRSVPDeadline() {
  const tw = state.thisWeek;
  if (!tw.date) return null;
  // RSVP deadline = Monday 2:00 PM MDT (tee time)
  const teeTimeLocal = new Date(tw.date + 'T14:00:00');
  const year = teeTimeLocal.getFullYear();
  const month = String(teeTimeLocal.getMonth() + 1).padStart(2, '0');
  const day = String(teeTimeLocal.getDate()).padStart(2, '0');
  const teeStr = `${year}-${month}-${day}T14:00:00`;
  // Get the UTC offset for Denver on that date (handles MDT/MST)
  const testDate = new Date(teeStr);
  const utcStr = testDate.toLocaleString('en-US', { timeZone: 'UTC' });
  const denStr = testDate.toLocaleString('en-US', { timeZone: 'America/Denver' });
  const utcDate = new Date(utcStr);
  const denDate = new Date(denStr);
  const offsetMs = utcDate.getTime() - denDate.getTime();
  // Deadline = tee time (Monday 2 PM Denver time) in UTC
  return new Date(testDate.getTime() + offsetMs);
}

function isRSVPLocked() {
  // Admin manual override takes priority
  if (rsvpOverrideLocked) return true;
  const deadline = getRSVPDeadline();
  if (!deadline) return false;
  const now = new Date();
  // Lock only during the window between deadline and 24 hours after
  // After 24 hours past deadline, the round is over ‚Äî unlock for next week setup
  const msPast = now.getTime() - deadline.getTime();
  if (msPast > 24 * 60 * 60 * 1000) return false; // stale deadline, don't lock
  return msPast >= 0;
}

function updateDeadlineDisplay() {
  const el = document.getElementById('rsvp-deadline-display');
  if (!el) return;

  // If admin manually locked RSVPs
  if (rsvpOverrideLocked) {
    let html = '<div class="deadline-locked">RSVPs ARE LOCKED (Manual Override)</div>';
    if (isEditor) {
      html += `<button class="btn btn-outline" style="margin-top:8px;font-size:0.72rem;padding:5px 14px" onclick="unlockRSVPOverride()">Unlock RSVPs</button>`;
    }
    el.innerHTML = html;
    return;
  }

  const deadline = getRSVPDeadline();
  if (!deadline) { el.innerHTML = ''; return; }
  const now = new Date();
  const diff = deadline.getTime() - now.getTime();
  if (diff <= 0) {
    el.innerHTML = '<div class="deadline-locked">RSVPs ARE LOCKED</div>';
    return;
  }
  const days = Math.floor(diff / (1000*60*60*24));
  const hours = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
  const minutes = Math.floor((diff % (1000*60*60)) / (1000*60));
  const seconds = Math.floor((diff % (1000*60)) / 1000);
  let timeStr = '';
  if (days > 0) timeStr += days + 'd ';
  timeStr += hours + 'h ' + minutes + 'm ' + seconds + 's';
  let html = `<div class="deadline-pill"><span class="dl-label">RSVP Closes In:</span><span class="dl-time">${timeStr}</span></div>`;
  if (isEditor) {
    html += `<button class="btn btn-outline" style="margin-top:8px;font-size:0.72rem;padding:5px 14px" onclick="lockRSVPOverride()">Lock RSVPs Now</button>`;
  }
  el.innerHTML = html;
}

async function lockRSVPOverride() {
  if (!isEditor) return;
  const wn = state.thisWeek.weekNum || 1;
  rsvpOverrideLocked = true;
  await db.ref('rsvpOverride/' + wn).set(true);
  updateDeadlineDisplay();
  renderThisWeek();
  toast('RSVPs locked manually.');
  autoGeneratePairingsIfNeeded();
}

async function unlockRSVPOverride() {
  if (!isEditor) return;
  const wn = state.thisWeek.weekNum || 1;
  rsvpOverrideLocked = false;
  await db.ref('rsvpOverride/' + wn).set(false);
  updateDeadlineDisplay();
  renderThisWeek();
  toast('RSVPs unlocked.');
}

/* ‚îÄ‚îÄ‚îÄ Storage ‚îÄ‚îÄ‚îÄ */
async function saveState() {
  setLoading(true);
  try {
    if (window.storage && window.storage.set) {
      await window.storage.set(STORAGE_KEY, JSON.stringify(state), true);
    } else {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
  } catch(e) { toast('Save failed - try again.'); console.warn(e); }
  setLoading(false);
}

async function loadState() {
  setLoading(true);
  try {
    let raw = null;
    if (window.storage && window.storage.get) {
      const res = await window.storage.get(STORAGE_KEY, true);
      if (res && res.value) raw = res.value;
    } else {
      raw = localStorage.getItem(STORAGE_KEY);
    }
    if (raw) {
      const loaded = JSON.parse(raw);
      state.players = loaded.players || [];
      state.thisWeek = loaded.thisWeek || { weekNum: 1, course: '', date: '', time: '', par: 72, notes: '' };
      // 2026 season reset: clear cached weeks data so all devices start fresh
      // (Firebase is the source of truth ‚Äî weekResults listener will repopulate)
      if (!localStorage.getItem('fog-2026-reset')) {
        state.weeks = {};
        state.thisWeek = { weekNum: 1, course: '', date: '', time: '', par: 72, notes: '' };
        localStorage.setItem('fog-2026-reset', 'true');
      } else {
        state.weeks = loaded.weeks || {};
      }
    }
  } catch(e) { console.warn('No saved data yet.'); }
  setLoading(false);
  try { renderAll(); } catch(e) { console.error('renderAll error during loadState:', e); }
}

/* ‚îÄ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ */
function handleLockBtn() { isEditor ? logout() : openModal(); }
function openModal() {
  document.getElementById('modal-overlay').classList.add('open');
  document.getElementById('modal-pw').value = '';
  document.getElementById('modal-error').textContent = '';
  setTimeout(() => document.getElementById('modal-pw').focus(), 200);
}
function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); }
function submitPassword() {
  const pw = document.getElementById('modal-pw').value;
  if (pw === ADMIN_PASSWORD) {
    isEditor = true;
    closeModal();
    applyMode();
    toast('Editor mode unlocked!');
  } else {
    document.getElementById('modal-error').textContent = 'Incorrect password. Try again.';
    document.getElementById('modal-pw').value = '';
    document.getElementById('modal-pw').focus();
  }
}
function logout() {
  if (!confirm('Log out of editor mode?')) return;
  isEditor = false;
  applyMode();
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-home').classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelector('.nav-tab').classList.add('active');
  toast('Logged out.');
}
function applyMode() {
  const badge = document.getElementById('mode-badge');
  const label = document.getElementById('mode-label');
  const lockBtn = document.getElementById('lock-btn');
  if (isEditor) {
    badge.className = 'mode-badge mode-editor';
    label.textContent = 'Editor';
    lockBtn.textContent = 'Logout';
    document.body.classList.add('editor-mode');
  } else {
    badge.className = 'mode-badge mode-viewer';
    label.textContent = 'View Only';
    lockBtn.textContent = 'Admin Login';
    document.body.classList.remove('editor-mode');
  }
  ['player-name-input','player-handicap-input','week-select','par-input','course-input','save-scores-btn',
   'tw-course-input','tw-date-input','tw-par-input','tw-notes-input','current-week-select']
    .forEach(id => { const el = document.getElementById(id); if (el) el.disabled = !isEditor; });
  // Also disable/enable tee time inputs in manage week
  document.querySelectorAll('.tw-tee-input').forEach(el => el.disabled = !isEditor);
  renderScoreEntry();
  updateRoundStatusUI();
  renderCourseSetup();
}

/* ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ */
function showPanel(name, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'home')           renderThisWeek();
  if (name === 'live-scoring')   renderLiveScoring();
  if (name === 'pairings')      renderPairingsTab();
  if (name === 'scores')        { populateWeekSelect(); renderScoreEntry(); }
  if (name === 'standings')     renderStandings();
  if (name === 'history')       renderHistory(curHistoryWeek);
  if (name === 'players')       renderPlayers();
  if (name === 'schedule')      renderSchedule();
  if (name === 'past-seasons')  renderPastSeasons();
  if (name === 'manage-week')   renderManageWeek();
}

/* ‚îÄ‚îÄ‚îÄ Get active players (roster + current-week guests) ‚îÄ‚îÄ‚îÄ */
function getActivePlayers() {
  const wn = state.thisWeek.weekNum || 1;
  const guests = guestData[wn] || {};
  const guestList = Object.values(guests).map(g => ({ ...g, isGuest: true }));
  return [...state.players, ...guestList];
}

/* ‚îÄ‚îÄ‚îÄ Firebase Guest Listener ‚îÄ‚îÄ‚îÄ */
function listenToGuests() {
  const wn = state.thisWeek.weekNum || 1;
  const ref = db.ref('guests/' + wn);
  if (guestListener) guestListener.off();
  guestListener = ref;
  ref.on('value', (snap) => {
    guestData[wn] = snap.val() || {};
    renderThisWeek();
    if (isEditor) renderAdminSummary();
  });
}

/* ‚îÄ‚îÄ‚îÄ Firebase RSVP Listener ‚îÄ‚îÄ‚îÄ */
function listenToRSVPs() {
  const wn = state.thisWeek.weekNum || 1;
  const rsvpRef = db.ref('rsvps/' + wn);

  if (rsvpListener) rsvpListener.off();
  rsvpListener = rsvpRef;

  rsvpRef.on('value', (snapshot) => {
    rsvpData[wn] = snapshot.val() || {};
    syncPairingsWithRSVPs();
    renderThisWeek();
    if (isEditor) renderAdminSummary();
  });
}

/* ‚îÄ‚îÄ‚îÄ Firebase Payment Listener ‚îÄ‚îÄ‚îÄ */
function listenToPayments() {
  const wn = state.thisWeek.weekNum || 1;
  const payRef = db.ref('payments/' + wn);

  if (paymentListener) paymentListener.off();
  paymentListener = payRef;

  payRef.on('value', (snapshot) => {
    paymentData[wn] = snapshot.val() || {};
    renderRSVP();
    if (isEditor) renderAdminSummary();
  });
}

/* ‚îÄ‚îÄ‚îÄ This Week / RSVP ‚îÄ‚îÄ‚îÄ */
function renderThisWeek() {
  const tw = state.thisWeek;
  const courseEl = document.getElementById('tw-course');
  const detailsEl = document.getElementById('tw-details');
  const rsvpCountEl = document.getElementById('tw-rsvp-count');

  if (tw.course) {
    courseEl.textContent = tw.course;
    let details = [];
    if (tw.date) {
      const d = new Date(tw.date + 'T00:00:00');
      details.push(d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }));
    }
    // Show multiple tee times if available, otherwise single time
    const teeTimes = tw.teeTimes && tw.teeTimes.length > 0 ? tw.teeTimes : (tw.time ? [tw.time] : []);
    if (teeTimes.length > 0) {
      const formatted = teeTimes.map(t => formatTeeTime(t)).filter(Boolean);
      if (formatted.length === 1) {
        details.push(formatted[0]);
      } else if (formatted.length > 1) {
        details.push(formatted[0] + '‚Äì' + formatted[formatted.length - 1] + ' (' + formatted.length + ' tee times)');
      }
    }
    if (tw.par) details.push('Par ' + tw.par);
    detailsEl.innerHTML = details.map(d => '<span>' + escHtml(d) + '</span>').join(' &middot; ');
    if (tw.notes) {
      detailsEl.innerHTML += '<br><span style="font-size:0.8rem;color:var(--gray);margin-top:4px;display:inline-block">' + escHtml(tw.notes) + '</span>';
    }
  } else {
    courseEl.textContent = 'No course set yet';
    detailsEl.innerHTML = '<span style="color:var(--gray)">Admin will post this week\'s details soon</span>';
  }

  // RSVP count (from Firebase data)
  const wn = tw.weekNum || 1;
  const rsvps = rsvpData[wn] || {};
  const yesCount = Object.values(rsvps).filter(v => v === 'yes').length;
  rsvpCountEl.innerHTML = '<span class="count-num">' + yesCount + '</span> player' + (yesCount !== 1 ? 's' : '') + ' confirmed';

  updateDeadlineDisplay();
  renderRSVP();
  renderPairingsDisplay();
}

function renderRSVP() {
  const list = document.getElementById('rsvp-list');
  const allPlayers = getActivePlayers();
  if (!allPlayers.length) {
    list.innerHTML = '<div class="empty-state" style="grid-column:1/-1">No players yet. Admin must add players first.</div>';
    return;
  }
  const wn = state.thisWeek.weekNum || 1;
  const rsvps = rsvpData[wn] || {};
  const payments = paymentData[wn] || {};
  const locked = isRSVPLocked() && !isEditor;

  list.innerHTML = allPlayers.map(p => {
    const status = rsvps[p.id] || 'pending';
    const paid = payments[p.id] === true;
    const chipClass = status === 'yes' ? 'rsvp-yes' : status === 'no' ? 'rsvp-no' : '';
    const btnClass = status === 'yes' ? 'rsvp-in' : status === 'no' ? 'rsvp-out' : 'rsvp-pending';
    const btnText = status === 'yes' ? 'I\'m In' : status === 'no' ? 'Out' : 'Pending';
    const disabledAttr = locked ? 'disabled style="opacity:0.5;cursor:not-allowed"' : '';

    // Payment indicator
    let payHtml = '';
    if (isEditor) {
      payHtml = `<button class="rsvp-status ${paid ? 'rsvp-paid' : 'rsvp-unpaid'}" onclick="togglePayment('${p.id}')">${paid ? 'PAID' : 'UNPAID'}</button>`;
    } else if (paid) {
      payHtml = '<span class="paid-badge">PAID</span>';
    }

    const guestBadge = p.isGuest ? ' <span class="guest-badge">GUEST</span>' : '';
    const guestRemoveBtn = p.isGuest && isEditor ? ` <button class="guest-remove-btn" onclick="removeGuest('${p.id}')" title="Remove guest">‚úï</button>` : '';

    return `
      <div class="rsvp-chip ${chipClass}">
        <span style="font-weight:600">${escHtml(p.name)}${guestBadge}${guestRemoveBtn}</span>
        <span class="chip-actions">
          ${payHtml}
          <button class="rsvp-status ${btnClass}" onclick="toggleRSVP('${p.id}')" ${disabledAttr}>${btnText}</button>
        </span>
      </div>
    `;
  }).join('');
}

async function addGuest() {
  const nameEl = document.getElementById('guest-name-input');
  const name = nameEl.value.trim();
  if (!name) return toast('Enter a guest name.');
  const wn = state.thisWeek.weekNum || 1;
  if (getActivePlayers().find(p => p.name.toLowerCase() === name.toLowerCase())) return toast('A player with that name already exists.');
  const guestId = 'guest_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
  try {
    await db.ref('guests/' + wn + '/' + guestId).set({ id: guestId, name, handicap: 0, isGuest: true, addedAt: Date.now() });
    await db.ref('rsvps/' + wn + '/' + guestId).set('yes');
    nameEl.value = '';
    toast(name + ' added as guest!');
  } catch (e) { toast('Failed to add guest.'); console.warn(e); }
}

async function removeGuest(guestId) {
  if (!isEditor) return;
  const wn = state.thisWeek.weekNum || 1;
  const guest = (guestData[wn] || {})[guestId];
  if (!guest || !confirm('Remove guest ' + guest.name + '?')) return;
  try {
    await db.ref('guests/' + wn + '/' + guestId).remove();
    await db.ref('rsvps/' + wn + '/' + guestId).remove();
    await db.ref('liveScores/' + wn + '/' + guestId).remove();
    toast('Guest removed.');
  } catch (e) { toast('Failed to remove guest.'); console.warn(e); }
}

async function toggleRSVP(playerId) {
  if (isRSVPLocked() && !isEditor) {
    toast('RSVPs are locked! Deadline has passed.');
    return;
  }
  const wn = state.thisWeek.weekNum || 1;
  const cur = (rsvpData[wn] && rsvpData[wn][playerId]) || 'pending';
  const next = cur === 'pending' ? 'yes' : cur === 'yes' ? 'no' : 'pending';

  try {
    await db.ref('rsvps/' + wn + '/' + playerId).set(next);
    // Redirect to Venmo when player RSVPs "In"
    if (next === 'yes') {
      const venmoLink = document.getElementById('venmo-link');
      if (venmoLink) window.open(venmoLink.href, '_blank');
    }
  } catch (e) {
    toast('RSVP update failed - try again.');
    console.warn(e);
  }
}

/* ‚îÄ‚îÄ‚îÄ Payment Tracking ‚îÄ‚îÄ‚îÄ */
async function togglePayment(playerId) {
  if (!isEditor) return;
  const wn = state.thisWeek.weekNum || 1;
  const cur = (paymentData[wn] && paymentData[wn][playerId]) === true;
  try {
    await db.ref('payments/' + wn + '/' + playerId).set(!cur);
    toast(cur ? 'Marked as unpaid' : 'Marked as paid');
  } catch (e) {
    toast('Payment update failed');
    console.warn(e);
  }
}

async function markAllPaid() {
  if (!isEditor) return;
  const wn = state.thisWeek.weekNum || 1;
  const rsvps = rsvpData[wn] || {};
  const updates = {};
  Object.entries(rsvps).forEach(([pid, status]) => {
    if (status === 'yes') updates[pid] = true;
  });
  if (Object.keys(updates).length === 0) { toast('No confirmed players to mark'); return; }
  await db.ref('payments/' + wn).update(updates);
  toast('All confirmed players marked as paid');
}

async function resetPayments() {
  if (!isEditor) return;
  if (!confirm('Reset all payment statuses for this week?')) return;
  const wn = state.thisWeek.weekNum || 1;
  await db.ref('payments/' + wn).remove();
  await db.ref('paymentEnforced/' + wn).remove();
  toast('Payments reset');
}

async function enforcePaymentCutoff() {
  if (!isRSVPLocked() || !isEditor) return;
  const wn = state.thisWeek.weekNum || 1;
  try {
    const enforcedSnap = await db.ref('paymentEnforced/' + wn).once('value');
    if (enforcedSnap.val() === true) return;
    const rsvps = rsvpData[wn] || {};
    const payments = paymentData[wn] || {};
    const updates = {};
    let changed = false;
    Object.entries(rsvps).forEach(([playerId, status]) => {
      if (status === 'yes' && !payments[playerId]) {
        updates['rsvps/' + wn + '/' + playerId] = 'no';
        changed = true;
      }
    });
    if (changed) {
      updates['paymentEnforced/' + wn] = true;
      await db.ref().update(updates);
      toast('Unpaid players marked as Out (deadline passed)');
    } else {
      await db.ref('paymentEnforced/' + wn).set(true);
    }
  } catch (e) { console.warn('Payment enforcement error:', e); }
}

/* ‚îÄ‚îÄ‚îÄ Admin RSVP Summary ‚îÄ‚îÄ‚îÄ */
function renderAdminSummary() {
  const el = document.getElementById('admin-summary-content');
  if (!el || !isEditor) return;
  const wn = state.thisWeek.weekNum || 1;
  const rsvps = rsvpData[wn] || {};
  const payments = paymentData[wn] || {};
  const inList = [], outList = [], pendingList = [];

  getActivePlayers().forEach(p => {
    const status = rsvps[p.id] || 'pending';
    const paid = payments[p.id] === true;
    const entry = { name: p.name + (p.isGuest ? ' (Guest)' : ''), paid };
    if (status === 'yes') inList.push(entry);
    else if (status === 'no') outList.push(entry);
    else if (!p.isGuest) pendingList.push(entry);
  });

  const renderList = (items, showPay) => {
    if (!items.length) return '<div style="color:var(--gray);font-size:0.8rem;padding:4px 0">None</div>';
    return items.map(item => `
      <div class="summary-player">
        <span>${escHtml(item.name)}</span>
        ${showPay ? (item.paid
          ? '<span class="summary-badge summary-badge-paid">PAID</span>'
          : '<span class="summary-badge summary-badge-unpaid">UNPAID</span>') : ''}
      </div>
    `).join('');
  };

  const total = getActivePlayers().length;
  const responded = inList.length + outList.length;
  el.innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-top:10px">
      <div>
        <div class="summary-col-header" style="color:var(--green-good)">IN (${inList.length})</div>
        ${renderList(inList, true)}
      </div>
      <div>
        <div class="summary-col-header" style="color:var(--red-bad)">OUT (${outList.length})</div>
        ${renderList(outList, false)}
      </div>
      <div>
        <div class="summary-col-header" style="color:var(--gray)">NO RESPONSE (${pendingList.length})</div>
        ${renderList(pendingList, false)}
      </div>
    </div>
    <div style="margin-top:14px;padding-top:10px;border-top:1px solid rgba(255,61,167,0.15);font-size:0.8rem;color:var(--gray)">
      Total: ${total} players &middot; Response rate: ${total ? Math.round((responded / total) * 100) : 0}%
    </div>
  `;
}

/* ‚îÄ‚îÄ‚îÄ Email Notifications (EmailJS) ‚îÄ‚îÄ‚îÄ */
function buildRSVPSummaryText() {
  const wn = state.thisWeek.weekNum || 1;
  const rsvps = rsvpData[wn] || {};
  const payments = paymentData[wn] || {};
  const inPlayers = [], outPlayers = [], pendingPlayers = [];

  getActivePlayers().forEach(p => {
    const status = rsvps[p.id] || 'pending';
    const paid = payments[p.id] === true;
    if (status === 'yes') inPlayers.push(p.name + (paid ? ' (Paid)' : ' (UNPAID)') + (p.isGuest ? ' [GUEST]' : ''));
    else if (status === 'no') outPlayers.push(p.name);
    else if (!p.isGuest) pendingPlayers.push(p.name);
  });

  let text = 'FOG Golf League - Week ' + wn + ' RSVP Summary\n';
  text += 'Course: ' + (state.thisWeek.course || 'TBD') + '\n';
  text += 'Date: ' + (state.thisWeek.date || 'TBD') + '\n';
  text += 'Tee Time: 2:00 PM MDT\n\n';
  text += '--- IN (' + inPlayers.length + ') ---\n' + (inPlayers.join('\n') || 'None') + '\n\n';
  text += '--- OUT (' + outPlayers.length + ') ---\n' + (outPlayers.join('\n') || 'None') + '\n\n';
  text += '--- NO RESPONSE (' + pendingPlayers.length + ') ---\n' + (pendingPlayers.join('\n') || 'None') + '\n';
  return text;
}

async function sendRSVPEmail(subject) {
  if (!EMAILJS_PUBLIC_KEY || !EMAILJS_SERVICE_ID || !EMAILJS_TEMPLATE_ID) {
    toast('EmailJS not configured yet - check settings');
    console.warn('EmailJS keys not set. Set EMAILJS_PUBLIC_KEY, EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID in the code.');
    return false;
  }
  try {
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
      to_email: ADMIN_EMAIL,
      subject: subject || 'FOG RSVP Summary - Week ' + (state.thisWeek.weekNum || 1),
      rsvp_summary: buildRSVPSummaryText()
    }, EMAILJS_PUBLIC_KEY);
    toast('RSVP summary email sent!');
    return true;
  } catch(e) {
    toast('Email failed to send');
    console.warn('EmailJS error:', e);
    return false;
  }
}

function loadEmailSentFlags() {
  const wn = state.thisWeek.weekNum || 1;
  ['deadline-', 'morning-'].forEach(prefix => {
    const key = prefix + wn;
    if (localStorage.getItem('emailSent_' + key) === 'true') {
      emailSentFlags[key] = true;
    }
  });
}

function checkAutoEmailTriggers() {
  if (!isEditor || !EMAILJS_PUBLIC_KEY) return;
  const wn = state.thisWeek.weekNum || 1;
  const deadline = getRSVPDeadline();
  if (!deadline || !state.thisWeek.date) return;
  const now = new Date();

  // Trigger 1: At deadline (Monday 2 PM MDT = tee time)
  const deadlineKey = 'deadline-' + wn;
  if (!emailSentFlags[deadlineKey]) {
    const diffMs = now.getTime() - deadline.getTime();
    if (diffMs >= 0 && diffMs < 120000) {
      emailSentFlags[deadlineKey] = true;
      localStorage.setItem('emailSent_' + deadlineKey, 'true');
      sendRSVPEmail('FOG RSVPs CLOSED - Week ' + wn);
    }
  }

  // Trigger 2: Monday 8 AM MDT (6 hours before tee time)
  const mondayMorning = new Date(deadline.getTime() - 6 * 60 * 60 * 1000);
  const morningKey = 'morning-' + wn;
  if (!emailSentFlags[morningKey]) {
    const diffMs2 = now.getTime() - mondayMorning.getTime();
    if (diffMs2 >= 0 && diffMs2 < 120000) {
      emailSentFlags[morningKey] = true;
      localStorage.setItem('emailSent_' + morningKey, 'true');
      sendRSVPEmail('FOG Game Day Reminder - Week ' + wn);
    }
  }
}

/* ‚îÄ‚îÄ‚îÄ In-App Announcements ‚îÄ‚îÄ‚îÄ */
function listenToAnnouncement() {
  const ref = db.ref('announcement');
  if (announcementListener) announcementListener.off();
  announcementListener = ref;
  ref.on('value', (snap) => renderAnnouncement(snap.val()));
}

function renderAnnouncement(data) {
  const container = document.getElementById('announcement-banner-container');
  if (!container) return;
  if (!data || !data.text) { container.innerHTML = ''; return; }
  const dismissKey = 'ann_dismissed_' + (data.timestamp || 0);
  if (localStorage.getItem(dismissKey)) { container.innerHTML = ''; return; }
  const dateStr = data.timestamp ? new Date(data.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) : '';
  container.innerHTML = `
    <div class="announcement-banner">
      <button class="announcement-close" onclick="dismissAnnouncement(${data.timestamp})">&times;</button>
      <div class="announcement-content">
        <span class="announcement-icon">üì¢</span>
        <div class="announcement-text">${escHtml(data.text)}</div>
        ${dateStr ? `<span class="announcement-date">${dateStr}</span>` : ''}
      </div>
    </div>`;
}

function dismissAnnouncement(ts) {
  localStorage.setItem('ann_dismissed_' + (ts || 0), 'true');
  const c = document.getElementById('announcement-banner-container');
  if (c) c.innerHTML = '';
}

async function saveAnnouncement() {
  if (!isEditor) return;
  const text = document.getElementById('announcement-text')?.value.trim();
  if (!text) return toast('Enter announcement text.');
  try {
    await db.ref('announcement').set({ text, timestamp: Date.now(), author: 'admin' });
    toast('Announcement posted!');
    document.getElementById('announcement-text').value = '';
  } catch (e) { toast('Failed to post announcement.'); console.warn(e); }
}

async function clearAnnouncement() {
  if (!isEditor) return;
  if (!confirm('Clear the current announcement?')) return;
  try {
    await db.ref('announcement').remove();
    toast('Announcement cleared.');
  } catch (e) { toast('Failed to clear.'); console.warn(e); }
}

/* ‚îÄ‚îÄ‚îÄ FCM Push Notifications ‚îÄ‚îÄ‚îÄ */
const isNativeApp = window.Capacitor?.isNativePlatform?.() === true;

function initFCM() {
  if (isNativeApp) {
    initNativePush();
    return;
  }
  try {
    if (!firebase.messaging || !firebase.messaging.isSupported()) {
      console.log('FCM not supported in this browser.');
      return;
    }
    messaging = firebase.messaging();
    messaging.onMessage((payload) => {
      const n = payload.notification || {};
      toast((n.title ? n.title + ': ' : '') + (n.body || 'New notification'));
    });
    // Check current permission state
    if ('Notification' in window) {
      if (Notification.permission === 'granted') {
        // Already granted ‚Äî silently get/refresh token
        requestNotificationPermission();
      } else if (Notification.permission === 'default') {
        // Not yet asked ‚Äî show the banner so user can tap to enable (required on iOS)
        setTimeout(() => showNotificationBanner(), 2000);
      }
      // If 'denied', do nothing ‚Äî user explicitly blocked notifications
    }
  } catch (e) { console.warn('FCM init error:', e); }
}

/* ‚îÄ‚îÄ‚îÄ Native Push (Capacitor iOS) ‚îÄ‚îÄ‚îÄ */
async function initNativePush() {
  try {
    const FirebaseMessaging = window.Capacitor?.Plugins?.FirebaseMessaging;
    if (!FirebaseMessaging) {
      console.warn('FirebaseMessaging plugin not available');
      return;
    }

    // Check current permission status
    const permStatus = await FirebaseMessaging.checkPermissions();
    if (permStatus.receive === 'granted') {
      // Already granted ‚Äî get token silently
      await getNativeToken(FirebaseMessaging);
    } else if (permStatus.receive === 'prompt') {
      // Not yet asked ‚Äî show the banner so user can tap to enable
      setTimeout(() => showNotificationBanner(), 2000);
    }

    // Listen for foreground notifications
    FirebaseMessaging.addListener('notificationReceived', (event) => {
      const n = event.notification || {};
      toast((n.title ? n.title + ': ' : '') + (n.body || 'New notification'));
    });

    // Listen for notification taps (app was in background)
    FirebaseMessaging.addListener('notificationActionPerformed', () => {
      // App is already open ‚Äî no action needed
    });

    // Listen for token refresh
    FirebaseMessaging.addListener('tokenReceived', async (event) => {
      if (event.token) {
        currentFCMToken = event.token;
        await saveFCMToken(event.token);
      }
    });
  } catch (e) { console.warn('Native push init error:', e); }
}

async function getNativeToken(FirebaseMessaging) {
  try {
    const { token } = await FirebaseMessaging.getToken();
    console.log('Native FCM token:', token ? 'received (' + token.length + ' chars)' : 'null');
    if (token) {
      currentFCMToken = token;
      await saveFCMToken(token);
    }
    hideNotificationBanner();
  } catch (e) { console.warn('Native FCM token error:', e); }
}

async function requestNotificationPermission() {
  // Native app path
  if (isNativeApp) {
    try {
      const FirebaseMessaging = window.Capacitor?.Plugins?.FirebaseMessaging;
      if (!FirebaseMessaging) return;
      const perm = await FirebaseMessaging.requestPermissions();
      if (perm.receive === 'granted') {
        await getNativeToken(FirebaseMessaging);
      }
      hideNotificationBanner();
    } catch (e) { console.warn('Native permission error:', e); }
    return;
  }
  // Web path
  if (!messaging || !FCM_VAPID_KEY) { console.warn('FCM not ready:', !messaging, !FCM_VAPID_KEY); return; }
  try {
    const perm = await Notification.requestPermission();
    console.log('Notification permission:', perm);
    if (perm === 'granted') {
      // Pass our existing SW registration so FCM doesn't look for /firebase-messaging-sw.js
      const swReg = await navigator.serviceWorker.getRegistration();
      const token = await messaging.getToken({ vapidKey: FCM_VAPID_KEY, serviceWorkerRegistration: swReg });
      console.log('FCM token:', token ? 'received (' + token.length + ' chars)' : 'null');
      if (token) { currentFCMToken = token; await saveFCMToken(token); }
      hideNotificationBanner();
    } else {
      hideNotificationBanner();
    }
  } catch (e) { console.warn('FCM token error:', e); }
}

function showNotificationBanner() {
  // Don't show if user dismissed recently (30-day cooldown)
  const dismissed = localStorage.getItem('fog-notif-dismissed');
  if (dismissed && Date.now() - parseInt(dismissed) < 30 * 24 * 60 * 60 * 1000) return;
  // Don't show if permission already granted or denied
  if ('Notification' in window && Notification.permission !== 'default') return;
  const banner = document.getElementById('notif-permission-banner');
  if (banner) banner.style.display = 'flex';
}

function hideNotificationBanner() {
  const banner = document.getElementById('notif-permission-banner');
  if (banner) banner.style.display = 'none';
}

async function handleEnableNotifications() {
  // This is called from a button tap ‚Äî user gesture satisfies iOS requirement
  await requestNotificationPermission();
}

function dismissNotificationBanner() {
  hideNotificationBanner();
  localStorage.setItem('fog-notif-dismissed', Date.now().toString());
}

async function saveFCMToken(token) {
  if (!token) return;
  const hash = 'tk_' + Math.abs(token.split('').reduce((h, c) => ((h << 5) - h) + c.charCodeAt(0), 0)).toString(36);
  try {
    await db.ref('fcmTokens/' + hash).set({ token, timestamp: Date.now(), lastSeen: Date.now() });
  } catch (e) { console.warn('FCM token save error:', e); }
}

/* ‚îÄ‚îÄ‚îÄ Capacitor Native Features (iOS only) ‚îÄ‚îÄ‚îÄ */
async function initCapacitorNative() {
  if (!isNativeApp) return;
  try {
    // Style the native status bar to match the dark theme
    const StatusBar = window.Capacitor?.Plugins?.StatusBar;
    if (StatusBar) {
      await StatusBar.setStyle({ style: 'DARK' });
      await StatusBar.setBackgroundColor({ color: '#0f0a10' });
    }
  } catch (e) { console.warn('StatusBar init error:', e); }
}

// Add haptic feedback on score entry in native app
function hapticTap() {
  if (!isNativeApp) return;
  try {
    const Haptics = window.Capacitor?.Plugins?.Haptics;
    if (Haptics) Haptics.impact({ style: 'LIGHT' });
  } catch (e) { /* ignore */ }
}

async function sendPushNotification() {
  if (!isEditor) return;
  const title = document.getElementById('notif-title')?.value.trim();
  const message = document.getElementById('notif-message')?.value.trim();
  const statusEl = document.getElementById('notif-status');
  if (!title || !message) return toast('Enter both title and message.');
  if (!CLOUD_FUNCTION_URL) return toast('Cloud Function URL not configured yet. See setup instructions.');
  if (statusEl) statusEl.textContent = 'Sending...';
  try {
    const resp = await fetch(CLOUD_FUNCTION_URL, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, body: message })
    });
    const result = await resp.json();
    if (resp.ok) {
      toast('Notification sent!');
      if (statusEl) statusEl.textContent = '‚úì Sent to ' + (result.successCount || 0) + ' devices';
      document.getElementById('notif-title').value = '';
      document.getElementById('notif-message').value = '';
    } else { throw new Error(result.error || 'Failed'); }
  } catch (e) {
    toast('Failed to send notification.');
    if (statusEl) statusEl.textContent = '‚úó Send failed';
    console.warn(e);
  }
}

async function updateFCMSubscriberCount() {
  if (!isEditor) return;
  try {
    const snap = await db.ref('fcmTokens').once('value');
    const count = snap.numChildren();
    const el = document.getElementById('fcm-subscriber-count');
    if (el) el.textContent = count + ' device' + (count !== 1 ? 's' : '') + ' subscribed to push notifications';
  } catch (e) { console.warn('Subscriber count error:', e); }
}

/* ‚îÄ‚îÄ‚îÄ Manage Week (editor) ‚îÄ‚îÄ‚îÄ */
function renderManageWeek() {
  const sel = document.getElementById('current-week-select');
  if (!sel) return;
  sel.innerHTML = '';
  for (let w = 1; w <= TOTAL_WEEKS; w++) {
    const opt = document.createElement('option');
    opt.value = w;
    opt.textContent = 'Week ' + w;
    sel.appendChild(opt);
  }
  sel.value = state.thisWeek.weekNum || 1;
  document.getElementById('tw-course-input').value = state.thisWeek.course || '';
  document.getElementById('tw-date-input').value = state.thisWeek.date || '';
  document.getElementById('tw-par-input').value = state.thisWeek.par || 72;
  document.getElementById('tw-notes-input').value = state.thisWeek.notes || '';
  // Populate tee times
  const teeTimes = state.thisWeek.teeTimes || (state.thisWeek.time ? [state.thisWeek.time] : ['14:00']);
  setTeeTimes('tw-tee-times-row', 'tw-tee-input', teeTimes);
  renderCourseSetup();
  updateRoundStatusUI();
  // Wire up course input change to auto-fill pars
  const courseInput = document.getElementById('tw-course-input');
  if (courseInput) {
    courseInput.removeEventListener('change', autoFillParsFromCourse);
    courseInput.addEventListener('change', autoFillParsFromCourse);
  }
  // Wire up schedule course input to auto-fill par total
  const schedCourseInput = document.getElementById('sched-course-input');
  if (schedCourseInput) {
    schedCourseInput.removeEventListener('change', autoFillSchedParFromCourse);
    schedCourseInput.addEventListener('change', autoFillSchedParFromCourse);
  }
  updateFCMSubscriberCount();
}

async function saveThisWeek() {
  if (!isEditor) return;
  const oldWeekNum = state.thisWeek.weekNum;
  const teeTimes = getTeeTimes('tw-tee-input');
  state.thisWeek = {
    weekNum: parseInt(document.getElementById('current-week-select').value),
    course: document.getElementById('tw-course-input').value.trim(),
    date: document.getElementById('tw-date-input').value,
    time: teeTimes[0] || '',  // keep backward compat
    teeTimes: teeTimes,
    par: parseInt(document.getElementById('tw-par-input').value) || 72,
    notes: document.getElementById('tw-notes-input').value.trim()
  };
  // If week changed, clear old week's RSVPs so everyone resets to "pending"
  const newWeekNum = state.thisWeek.weekNum;
  if (oldWeekNum && oldWeekNum !== newWeekNum) {
    await db.ref('rsvps/' + oldWeekNum).remove();
  }
  await saveState();
  // Sync thisWeek to Firebase so all devices see it
  await db.ref('thisWeek').set(state.thisWeek);
  // Save course setup to Firebase
  const wn = state.thisWeek.weekNum;
  const setup = getCourseSetupFromInputs();
  await db.ref('courseSetup/' + wn).set(setup);
  listenToRSVPs();
  listenToGuests();
  listenToPayments();
  listenToLiveScores();
  listenToRoundStatus();
  listenToCourseSetup();
  listenToContests();
  listenToPairings();
  listenToScoringMode();
  listenToGroupScorers();
  toast('This week updated!');
  renderThisWeek();
}

/* ‚îÄ‚îÄ‚îÄ Schedule ‚îÄ‚îÄ‚îÄ */
function renderSchedule() {
  const el = document.getElementById('schedule-list');
  const currentWn = state.thisWeek.weekNum || 1;

  // Populate admin week selector
  const schedSel = document.getElementById('sched-week-select');
  if (schedSel) {
    const curVal = schedSel.value;
    schedSel.innerHTML = '';
    for (let w = 1; w <= TOTAL_WEEKS; w++) {
      const opt = document.createElement('option');
      opt.value = w;
      const sd = scheduleData[w];
      opt.textContent = 'Week ' + w + (sd && sd.course ? ' ‚úì' : '');
      schedSel.appendChild(opt);
    }
    if (curVal) schedSel.value = curVal;
    schedSel.onchange = loadScheduleWeekForm;
  }

  // Merge all weeks: from scheduleData (Firebase), state.weeks (localStorage), and state.thisWeek
  const allWeeks = {};

  // Firebase schedule entries (primary source for future dates)
  Object.entries(scheduleData).forEach(([w, data]) => {
    allWeeks[w] = { ...data, source: 'schedule' };
  });

  // state.weeks (completed weeks with scores)
  Object.keys(state.weeks).forEach(w => {
    const wd = state.weeks[w];
    if (wd && (wd.course || Object.keys(wd.scores || {}).length > 0)) {
      if (!allWeeks[w]) allWeeks[w] = {};
      allWeeks[w] = { ...allWeeks[w], course: allWeeks[w].course || wd.course, par: allWeeks[w].par || wd.par, hasScores: Object.keys(wd.scores || {}).length > 0, scoreCount: Object.keys(wd.scores || {}).length };
    }
  });

  // Current week (state.thisWeek)
  if (state.thisWeek.course) {
    if (!allWeeks[currentWn]) allWeeks[currentWn] = {};
    allWeeks[currentWn] = { ...allWeeks[currentWn], course: state.thisWeek.course, date: allWeeks[currentWn].date || state.thisWeek.date, teeTimes: allWeeks[currentWn].teeTimes || state.thisWeek.teeTimes || (state.thisWeek.time ? [state.thisWeek.time] : []), par: state.thisWeek.par, isCurrent: true };
  }

  const sortedWeeks = Object.keys(allWeeks).sort((a, b) => +a - +b);

  if (!sortedWeeks.length) {
    el.innerHTML = '<div class="empty-state">No schedule set yet. Admin can add weeks above.</div>';
    return;
  }

  let items = [];

  sortedWeeks.forEach(w => {
    const wd = allWeeks[w];
    const isCurrent = +w === currentWn && wd.isCurrent;
    const hasScores = wd.hasScores;
    const isPast = hasScores || (+w < currentWn && !isCurrent);
    const isUpcoming = !isPast && !isCurrent;

    // Determine badge
    let badgeClass, badgeText;
    if (isCurrent) { badgeClass = 'badge-current'; badgeText = 'This Week'; }
    else if (isPast) { badgeClass = 'badge-completed'; badgeText = 'Completed'; }
    else { badgeClass = 'badge-upcoming'; badgeText = 'Upcoming'; }

    // Format date/tee times
    let details = [];
    if (wd.date) {
      const d = new Date(wd.date + 'T00:00:00');
      details.push(d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
    }
    // Show tee times (multiple or single fallback)
    const wdTeeTimes = wd.teeTimes && wd.teeTimes.length > 0 ? wd.teeTimes : (wd.time ? [wd.time] : []);
    if (wdTeeTimes.length > 0) {
      const fmtTimes = wdTeeTimes.map(t => formatTeeTime(t)).filter(Boolean);
      if (fmtTimes.length === 1) {
        details.push(fmtTimes[0]);
      } else if (fmtTimes.length > 1) {
        details.push(fmtTimes[0] + '‚Äì' + fmtTimes[fmtTimes.length - 1]);
      }
    }
    if (wd.par) details.push('Par ' + wd.par);
    if (hasScores) details.push(wd.scoreCount + ' players');

    // RSVP count for this week
    const weekRsvps = scheduleRsvpData[w] || rsvpData[w] || {};
    const yesCount = Object.values(weekRsvps).filter(v => v === 'yes').length;

    // Build RSVP section for upcoming/current weeks
    let rsvpHtml = '';
    if (isUpcoming || isCurrent) {
      const isExpanded = expandedScheduleWeeks[w];
      rsvpHtml += `<div style="margin-top:6px">
        <div class="sched-rsvp-toggle" onclick="toggleScheduleRSVP(${w})">
          <span class="sched-rsvp-count"><span class="sched-count-num">${yesCount}</span> confirmed</span>
          <span style="font-size:0.65rem">${isExpanded ? '‚ñ≤ Hide' : '‚ñº RSVP'}</span>
        </div>`;

      if (isExpanded) {
        rsvpHtml += `<div class="sched-rsvp-grid">`;
        rsvpHtml += getActivePlayers().map(p => {
          const status = weekRsvps[p.id] || 'pending';
          const chipClass = status === 'yes' ? 'sched-yes' : status === 'no' ? 'sched-no' : '';
          const btnClass = status === 'yes' ? 'sched-btn-in' : status === 'no' ? 'sched-btn-out' : 'sched-btn-pending';
          const btnText = status === 'yes' ? "In" : status === 'no' ? 'Out' : '‚Äî';
          const guestBadge = p.isGuest ? ' <span class="guest-badge">GUEST</span>' : '';
          return `<div class="sched-rsvp-chip ${chipClass}">
            <span style="font-weight:600">${escHtml(p.name)}${guestBadge}</span>
            <button class="sched-rsvp-btn ${btnClass}" onclick="event.stopPropagation();toggleScheduleWeekRSVP('${p.id}',${w})">${btnText}</button>
          </div>`;
        }).join('');
        rsvpHtml += '</div>';
      }
      rsvpHtml += '</div>';
    }

    // Admin edit button
    const editBtn = isEditor && !isPast ? ` <button style="font-size:0.55rem;background:none;border:1px solid rgba(255,61,167,0.3);color:var(--pink-light);padding:1px 6px;border-radius:4px;cursor:pointer" onclick="event.stopPropagation();loadScheduleWeekToForm(${w})">Edit</button>` : '';

    const borderStyle = isCurrent ? 'border-color:rgba(255,61,167,0.5)' : '';

    items.push(`
      <div class="schedule-item" style="${borderStyle}">
        <div class="schedule-week-num">W${w}</div>
        <div class="schedule-info" style="flex:1">
          <div class="course">${wd.course ? escHtml(wd.course) : 'Course TBD'}${editBtn}</div>
          <div class="details">${details.length ? details.join(' &middot; ') : 'Date TBD'}</div>
          ${rsvpHtml}
        </div>
        <span class="schedule-badge ${badgeClass}">${badgeText}</span>
      </div>
    `);
  });

  el.innerHTML = items.join('');
}

function toggleScheduleRSVP(weekNum) {
  expandedScheduleWeeks[weekNum] = !expandedScheduleWeeks[weekNum];
  renderSchedule();
}

async function toggleScheduleWeekRSVP(playerId, weekNum) {
  const weekRsvps = scheduleRsvpData[weekNum] || rsvpData[weekNum] || {};
  const cur = weekRsvps[playerId] || 'pending';
  const next = cur === 'pending' ? 'yes' : cur === 'yes' ? 'no' : 'pending';
  try {
    await db.ref('rsvps/' + weekNum + '/' + playerId).set(next);
    // Redirect to Venmo when player RSVPs "In"
    if (next === 'yes') {
      const venmoLink = document.getElementById('venmo-link');
      if (venmoLink) window.open(venmoLink.href, '_blank');
    }
  } catch (e) {
    toast('RSVP update failed');
    console.warn(e);
  }
}

/* ‚îÄ‚îÄ‚îÄ Schedule Admin ‚îÄ‚îÄ‚îÄ */
function loadScheduleWeekForm() {
  const w = document.getElementById('sched-week-select')?.value;
  if (!w) return;
  loadScheduleWeekToForm(parseInt(w));
}

function loadScheduleWeekToForm(weekNum) {
  const sel = document.getElementById('sched-week-select');
  if (sel) sel.value = weekNum;
  const sd = scheduleData[weekNum] || {};
  document.getElementById('sched-course-input').value = sd.course || '';
  document.getElementById('sched-date-input').value = sd.date || '';
  document.getElementById('sched-par-input').value = sd.par || 36;
  // Load tee times into slots
  if (sd.teeTimes && sd.teeTimes.length > 0) {
    setTeeTimes('sched-tee-times-row', 'sched-tee-input', sd.teeTimes);
  } else {
    // Reset to single default slot
    setTeeTimes('sched-tee-times-row', 'sched-tee-input', [sd.time || '14:00']);
  }
}

async function saveScheduleWeek() {
  if (!isEditor) return;
  const weekNum = document.getElementById('sched-week-select')?.value;
  if (!weekNum) return toast('Select a week first.');
  const teeTimes = getTeeTimes('sched-tee-input');
  const data = {
    course: document.getElementById('sched-course-input').value.trim(),
    date: document.getElementById('sched-date-input').value,
    teeTimes: teeTimes.length > 0 ? teeTimes : ['14:00'],
    par: parseInt(document.getElementById('sched-par-input').value) || 36
  };
  if (!data.course && !data.date) return toast('Enter at least a course or date.');
  try {
    await db.ref('schedule/' + weekNum).set(data);
    toast('Week ' + weekNum + ' saved to schedule!');
    // Clear form for next entry
    document.getElementById('sched-course-input').value = '';
    document.getElementById('sched-date-input').value = '';
    // Reset tee time slots
    setTeeTimes('sched-tee-times-row', 'sched-tee-input', ['14:00']);
  } catch (e) {
    toast('Failed to save schedule');
    console.warn(e);
  }
}

/* ‚îÄ‚îÄ‚îÄ Players ‚îÄ‚îÄ‚îÄ */
function syncPlayersToFirebase() {
  db.ref('players').set(state.players).catch(e => console.warn('Player sync error:', e));
}

async function addPlayer() {
  if (!isEditor) return;
  const nameEl = document.getElementById('player-name-input');
  const hcpEl = document.getElementById('player-handicap-input');
  const name = nameEl.value.trim();
  if (!name) return toast('Enter a player name.');
  if (state.players.find(p => p.name.toLowerCase() === name.toLowerCase())) return toast('Player already exists.');
  state.players.push({ id: generatePlayerId(name), name, handicap: parseInt(hcpEl.value) || 0 });
  nameEl.value = ''; hcpEl.value = '';
  await saveState();
  syncPlayersToFirebase();
  renderPlayers(); renderScoreEntry(); renderRSVP();
  toast(name + ' added!');
  nameEl.focus();
}

async function removePlayer(id) {
  if (!isEditor) return;
  const p = state.players.find(p => p.id === id);
  if (!confirm('Remove ' + (p?.name) + '? Their scores will also be removed.')) return;
  state.players = state.players.filter(p => p.id !== id);
  Object.values(state.weeks).forEach(w => { delete w.scores[id]; });
  await saveState();
  syncPlayersToFirebase();
  renderPlayers(); renderScoreEntry(); renderStandings();
  toast('Player removed.');
}

async function editPlayer(id) {
  if (!isEditor) return;
  const p = state.players.find(p => p.id === id);
  if (!p) return;
  const newName = prompt('Player name:', p.name);
  if (newName === null) return; // cancelled
  if (!newName.trim()) return toast('Name cannot be empty.');
  const newHcp = prompt('Handicap:', p.handicap || 0);
  if (newHcp === null) return; // cancelled
  p.name = newName.trim();
  p.handicap = parseInt(newHcp) || 0;
  await saveState();
  syncPlayersToFirebase();
  renderPlayers(); renderScoreEntry(); renderRSVP(); renderStandings();
  toast(p.name + ' updated!');
}

function renderPlayers() {
  const list = document.getElementById('player-list');
  const count = document.getElementById('roster-count');
  if (count) count.textContent = '(' + state.players.length + ' players)';
  if (!list) return;
  if (!state.players.length) {
    list.innerHTML = '<div class="empty-state" style="grid-column:1/-1">No players yet.</div>';
    return;
  }
  list.innerHTML = state.players.map((p, i) => `
    <div class="player-chip">
      <span>
        <span class="player-num">${i + 1}.</span>
        <span>${escHtml(p.name)}</span>
        ${p.handicap ? `<span style="font-size:0.7rem;color:var(--gray);margin-left:4px">(HCP ${p.handicap})</span>` : ''}
      </span>
      ${isEditor ? `<span style="display:flex;gap:4px">
        <button class="btn btn-outline" style="font-size:0.6rem;padding:3px 8px;border-radius:8px" onclick="editPlayer('${p.id}')">Edit</button>
        <button class="btn btn-danger" onclick="removePlayer('${p.id}')">‚úï</button>
      </span>` : ''}
    </div>
  `).join('');
}

/* ‚îÄ‚îÄ‚îÄ Scores ‚îÄ‚îÄ‚îÄ */
function populateWeekSelect() {
  const sel = document.getElementById('week-select');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '';
  for (let w = 1; w <= TOTAL_WEEKS; w++) {
    const opt = document.createElement('option');
    opt.value = w;
    const has = state.weeks[w] && Object.keys(state.weeks[w].scores || {}).length > 0;
    opt.textContent = 'Week ' + w + (has ? ' ‚úì' : '');
    sel.appendChild(opt);
  }
  if (cur) sel.value = cur;
}

function renderScoreEntry() {
  const area = document.getElementById('score-entry-area');
  if (!area) return;
  if (!state.players.length) {
    area.innerHTML = '<div class="empty-state">Add players first, then enter scores here.</div>';
    return;
  }
  const week = document.getElementById('week-select')?.value || '1';
  const weekData = state.weeks[week] || { par: 72, course: '', scores: {} };
  const parEl = document.getElementById('par-input');
  const crsEl = document.getElementById('course-input');
  if (parEl) parEl.value = weekData.par || 72;
  if (crsEl) crsEl.value = weekData.course || '';
  area.innerHTML = `
    <div class="score-table-wrap">
      <table>
        <thead><tr><th>#</th><th>Player</th><th>HCP</th><th>Gross Score</th><th>Net Score</th></tr></thead>
        <tbody>
          ${state.players.map((p, i) => {
            const gross = weekData.scores[p.id] ?? '';
            const net = gross !== '' ? gross - p.handicap : '';
            return `<tr>
              <td style="color:var(--gray);font-size:0.78rem">${i + 1}</td>
              <td><strong>${escHtml(p.name)}</strong></td>
              <td style="color:var(--pink-light)">${p.handicap || '‚Äî'}</td>
              <td class="score-input-cell">
                <input type="number" id="score-${p.id}" value="${gross}" min="50" max="150" placeholder="‚Äî"
                  ${!isEditor ? 'disabled' : ''}
                  oninput="updateNet('${p.id}',${p.handicap})"
                  onkeydown="if(event.key==='Enter'){event.preventDefault();focusNext(this)}">
              </td>
              <td id="net-${p.id}" style="color:var(--pink-hot);font-weight:700">${net !== '' ? net : '‚Äî'}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function updateNet(id, hcp) {
  const gross = parseInt(document.getElementById('score-' + id)?.value);
  const el = document.getElementById('net-' + id);
  if (el) el.textContent = isNaN(gross) ? '‚Äî' : gross - hcp;
}

function focusNext(el) {
  const inputs = [...document.querySelectorAll('.score-input-cell input:not(:disabled)')];
  const idx = inputs.indexOf(el);
  if (idx < inputs.length - 1) inputs[idx + 1].focus();
  else saveScores();
}

async function saveScores() {
  if (!isEditor) return;
  if (!state.players.length) return toast('Add players first.');
  const week = document.getElementById('week-select').value;
  const par = parseInt(document.getElementById('par-input').value) || 72;
  const course = document.getElementById('course-input').value.trim();
  const scores = {};
  state.players.forEach(p => {
    const v = document.getElementById('score-' + p.id)?.value;
    if (v !== '' && v !== undefined && !isNaN(parseInt(v))) scores[p.id] = parseInt(v);
  });
  const weekResult = { par, course, scores };
  state.weeks[week] = weekResult;
  await saveState();
  // Sync to Firebase so all devices see the scores
  try {
    await db.ref('weekResults/' + week).set(weekResult);
  } catch (e) {
    console.error('Error saving week results to Firebase:', e);
    toast('Scores saved locally but failed to sync ‚Äî will retry.');
    pendingSyncs[week] = weekResult;
  }
  populateWeekSelect();
  renderStandings();
  renderHistory(curHistoryWeek);
  toast('Week ' + week + ' scores saved!');
  renderWinnerBanner();
}

/* ‚îÄ‚îÄ‚îÄ Standings ‚îÄ‚îÄ‚îÄ */
function renderStandings() {
  const body = document.getElementById('standings-body');
  const meta = document.getElementById('standings-meta');
  if (!state.players.length) {
    body.innerHTML = '<tr><td colspan="7" class="empty-state">No players added yet.</td></tr>';
    meta.innerHTML = ''; return;
  }
  const weeksPlayed = Object.keys(state.weeks).filter(w => Object.keys(state.weeks[w].scores || {}).length > 0).length;
  const stats = state.players.map(p => {
    let total = 0, rounds = 0, best = Infinity, totalPar = 0;
    Object.values(state.weeks).forEach(w => {
      const s = w.scores[p.id];
      if (s !== undefined) { total += s; rounds++; if (s < best) best = s; totalPar += (w.par || 72); }
    });
    return { ...p, total: rounds ? total : null, rounds, avg: rounds ? (total / rounds).toFixed(1) : null, best: rounds ? best : null, vsPar: rounds ? total - totalPar : null };
  });
  stats.sort((a, b) => { if (!a.rounds && !b.rounds) return 0; if (!a.rounds) return 1; if (!b.rounds) return -1; return a.total - b.total; });
  const allScores = Object.values(state.weeks).flatMap(w => Object.values(w.scores || {}));
  const lowestEver = allScores.length ? Math.min(...allScores) : null;
  let lowestPlayerName = '';
  if (lowestEver !== null) {
    outer: for (const w of Object.values(state.weeks)) {
      for (const [pid, sc] of Object.entries(w.scores || {})) {
        if (sc === lowestEver) { const pl = state.players.find(p => p.id === pid); if (pl) lowestPlayerName = pl.name; break outer; }
      }
    }
  }
  const totalRounds = stats.reduce((s, p) => s + p.rounds, 0);
  meta.innerHTML = `
    <div class="meta-stat"><div class="val">${state.players.length}</div><div class="lbl">Players</div></div>
    <div class="meta-stat"><div class="val">${weeksPlayed}</div><div class="lbl">Weeks Played</div></div>
    <div class="meta-stat"><div class="val">${totalRounds}</div><div class="lbl">Total Rounds</div></div>
    <div class="meta-stat"><div class="val">${lowestEver ?? '‚Äî'}</div>
      <div class="lbl">Course Record${lowestPlayerName ? '<br><span style="font-size:0.63rem;color:var(--pink-light)">' + escHtml(lowestPlayerName) + '</span>' : ''}</div>
    </div>
  `;
  body.innerHTML = stats.map((p, i) => {
    const rc = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other';
    const lc = i === 0 && p.rounds > 0 ? 'leader' : '';
    let vph = '‚Äî';
    if (p.vsPar !== null) {
      const cls = p.vsPar < 0 ? 'score-under' : p.vsPar === 0 ? 'score-even' : 'score-over';
      vph = `<span class="score-pill ${cls}">${p.vsPar > 0 ? '+' : ''}${p.vsPar}</span>`;
    }
    return `<tr class="${lc}">
      <td><span class="rank-badge ${rc}">${i + 1}</span></td>
      <td><strong>${escHtml(p.name)}</strong>${p.handicap ? `<span class="flag"> HCP ${p.handicap}</span>` : ''}</td>
      <td>${p.rounds}</td><td>${p.total ?? '‚Äî'}</td><td>${p.avg ?? '‚Äî'}</td><td>${p.best ?? '‚Äî'}</td><td>${vph}</td>
    </tr>`;
  }).join('');
}

/* ‚îÄ‚îÄ‚îÄ History ‚îÄ‚îÄ‚îÄ */
function renderHistory(sel) {
  const pillsEl = document.getElementById('week-pills');
  const contentEl = document.getElementById('history-content');
  const weeks = Object.keys(state.weeks).filter(w => Object.keys(state.weeks[w].scores || {}).length > 0).sort((a, b) => +a - +b);
  if (!weeks.length) { pillsEl.innerHTML = ''; contentEl.innerHTML = '<div class="empty-state">No scores saved yet.</div>'; return; }
  if (!sel || !weeks.includes(String(sel))) sel = weeks[weeks.length - 1];
  curHistoryWeek = sel;
  pillsEl.innerHTML = weeks.map(w => `
    <button class="week-pill ${String(w) === String(sel) ? 'active' : ''}" onclick="renderHistory('${w}')">Week ${w}</button>
  `).join('');
  const wd = state.weeks[sel];
  const par = wd.par || 72, course = wd.course || '';
  const entries = Object.entries(wd.scores)
    .map(([id, score]) => { const pl = state.players.find(p => p.id === id); return pl ? { pl, gross: score, net: score - pl.handicap, vp: score - par } : null; })
    .filter(Boolean).sort((a, b) => a.gross - b.gross);
  contentEl.innerHTML = `
    <div style="margin-bottom:16px;display:flex;gap:20px;flex-wrap:wrap;align-items:center">
      <span style="font-family:'Outfit',sans-serif;font-size:1.15rem;color:var(--pink-hot);font-weight:700">
        Week ${sel}${course ? ' ‚Äî ' + escHtml(course) : ''}
      </span>
      <span style="font-size:0.78rem;color:var(--gray)">Par ${par} &middot; ${entries.length} players</span>
    </div>
    <div class="score-table-wrap">
      <table>
        <thead><tr><th>#</th><th>Player</th><th>Course</th><th>Gross</th><th>vs Par</th><th>HCP</th><th>Net</th></tr></thead>
        <tbody>
          ${entries.map((e, i) => {
            const rc = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other';
            const vpc = e.vp < 0 ? 'score-under' : e.vp === 0 ? 'score-even' : 'score-over';
            return `<tr ${i === 0 ? 'class="leader"' : ''}>
              <td><span class="rank-badge ${rc}">${i + 1}</span></td>
              <td><strong>${escHtml(e.pl.name)}</strong></td>
              <td style="color:var(--gray);font-size:0.8rem">${course ? escHtml(course) : '‚Äî'}</td>
              <td style="font-weight:700;font-size:1rem">${e.gross}</td>
              <td><span class="score-pill ${vpc}">${e.vp > 0 ? '+' : ''}${e.vp}</span></td>
              <td style="color:var(--pink-light)">${e.pl.handicap || '‚Äî'}</td>
              <td style="color:var(--pink-hot);font-weight:700">${e.net}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

/* ‚îÄ‚îÄ‚îÄ Live Scoring Firebase Listeners ‚îÄ‚îÄ‚îÄ */
function listenToThisWeek() {
  const ref = db.ref('thisWeek');
  if (thisWeekListener) thisWeekListener.off();
  thisWeekListener = ref;
  ref.on('value', (snap) => {
    const tw = snap.val();
    if (tw && tw.weekNum) {
      const oldWn = state.thisWeek.weekNum;
      state.thisWeek = tw;
      saveState();
      // If week number changed, re-attach week-specific listeners
      if (oldWn !== tw.weekNum) {
        listenToRSVPs();
        listenToGuests();
        listenToPayments();
        listenToLiveScores();
        listenToRoundStatus();
        listenToCourseSetup();
        listenToContests();
        listenToPairings();
        listenToScoringMode();
        listenToGroupScorers();
      }
      renderThisWeek();
      try { renderAll(); } catch(e) {}
    }
  });
}

function listenToLiveScores() {
  const wn = state.thisWeek.weekNum || 1;
  const ref = db.ref('liveScores/' + wn);
  if (liveScoresListener) liveScoresListener.off();
  liveScoresListener = ref;
  ref.on('value', (snap) => {
    liveScoresData = snap.val() || {};
    renderLiveScorecardGrid();
    renderLiveScoreTotal();
  });
}

function listenToRoundStatus() {
  const wn = state.thisWeek.weekNum || 1;
  const ref = db.ref('roundStatus/' + wn);
  if (roundStatusListener) roundStatusListener.off();
  roundStatusListener = ref;
  ref.on('value', (snap) => {
    roundStatus = snap.val() || 'setup';
    updateRoundStatusUI();
  });
}

function listenToCourseSetup() {
  const wn = state.thisWeek.weekNum || 1;
  const ref = db.ref('courseSetup/' + wn);
  if (courseSetupListener) courseSetupListener.off();
  courseSetupListener = ref;
  ref.on('value', (snap) => {
    courseSetupData = snap.val() || {};
    renderLiveScorecardGrid();
    renderLiveScoreInputs();
  });
}

function listenToContests() {
  const wn = state.thisWeek.weekNum || 1;
  const ref = db.ref('contests/' + wn);
  if (contestsListener) contestsListener.off();
  contestsListener = ref;
  ref.on('value', (snap) => {
    contestsData = snap.val() || {};
    if (roundStatus === 'closed') renderPayouts();
  });
}

/* ‚îÄ‚îÄ‚îÄ Schedule Firebase Listener ‚îÄ‚îÄ‚îÄ */
function listenToSchedule() {
  const ref = db.ref('schedule');
  if (scheduleListener) scheduleListener.off();
  scheduleListener = ref;
  ref.on('value', (snap) => {
    scheduleData = snap.val() || {};
    renderSchedule();
    // Attach RSVP listeners for all scheduled weeks
    Object.keys(scheduleData).forEach(wn => {
      listenToScheduleRSVP(wn);
    });
  });
}

function listenToScheduleRSVP(weekNum) {
  if (scheduleRsvpListeners[weekNum]) return; // already listening
  const ref = db.ref('rsvps/' + weekNum);
  scheduleRsvpListeners[weekNum] = ref;
  ref.on('value', (snap) => {
    scheduleRsvpData[weekNum] = snap.val() || {};
    renderSchedule();
  });
}

function listenToPairings() {
  const wn = state.thisWeek.weekNum || 1;
  const ref = db.ref('pairings/' + wn);
  if (pairingsListener) pairingsListener.off();
  pairingsListener = ref;
  ref.on('value', (snap) => {
    pairingsData[wn] = snap.val() || [];
    renderPairingsDisplay();
    renderPairingsTab();
  });
}

function listenToAllPairings() {
  const ref = db.ref('pairings');
  if (allPairingsListener) allPairingsListener.off();
  allPairingsListener = ref;
  ref.on('value', (snap) => {
    const all = snap.val() || {};
    Object.entries(all).forEach(([wn, data]) => {
      pairingsData[wn] = data || [];
    });
    renderPairingsTab();
  });
}

function renderPairingsTab() {
  const container = document.getElementById('pairings-tab-content');
  if (!container) return;

  const currentWn = state.thisWeek.weekNum || 1;

  // Gather all weeks that have pairings or schedule data
  const allWeeks = new Set();
  Object.keys(pairingsData).forEach(w => {
    if (pairingsData[w] && pairingsData[w].length) allWeeks.add(Number(w));
  });

  if (allWeeks.size === 0) {
    container.innerHTML = '<div class="empty-state">No pairings have been generated yet.</div>';
    return;
  }

  // Sort weeks descending (current/recent first)
  const weeks = Array.from(allWeeks).sort((a, b) => b - a);

  let html = '';
  weeks.forEach(wn => {
    const pairings = pairingsData[wn] || [];
    if (!pairings.length) return;

    const isCurrent = wn === currentWn;
    const sd = scheduleData[wn] || {};
    const courseName = sd.course || state.weeks?.[wn]?.course || (isCurrent ? (state.thisWeek.course || '') : '');
    const dateStr = sd.date || (isCurrent ? state.thisWeek.date : '');
    const formattedDate = dateStr ? new Date(dateStr + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
    const playerCount = pairings.reduce((sum, g) => sum + (g.players ? g.players.length : 0), 0);

    html += `<div class="pairings-week-section">`;
    html += `<div class="pairings-week-header ${isCurrent ? 'pw-current' : ''} ${isCurrent ? 'pw-expanded' : ''}"
      onclick="togglePairingsWeek(${wn}, this)">
      <div class="pw-left">
        <span class="pw-week-num">Wk ${wn}</span>
        <span class="pw-course">${escHtml(courseName) || 'TBD'}</span>
        ${formattedDate ? `<span class="pw-date">${formattedDate}</span>` : ''}
        <span class="pw-player-count">(${playerCount} players)</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        ${isCurrent ? '<span class="pw-badge">This Week</span>' : ''}
        <span class="pw-chevron">${isCurrent ? '‚ñ≤' : '‚ñº'}</span>
      </div>
    </div>`;

    // Pairings body
    html += `<div class="pairings-week-body ${isCurrent ? 'pw-open' : ''}" id="pw-body-${wn}">`;
    pairings.forEach((group, gi) => {
      const teeTimeStr = formatTeeTime(group.teeTime);
      html += `<div class="pairing-group">
        <div class="pairing-header">
          <span class="pairing-tee-time">${teeTimeStr || 'TBD'}</span>
          <span class="pairing-group-label">Group ${gi + 1}</span>
        </div>
        <div class="pairing-players">`;
      (group.players || []).forEach((pid, pi) => {
        const player = getActivePlayers().find(p => p.id === pid);
        if (player) {
          const gb = player.isGuest ? ' <span class="guest-badge">G</span>' : '';
          html += `<span class="pairing-player"><span class="pairing-num">${pi + 1}</span>${escHtml(player.name)}${gb}</span>`;
        }
      });
      html += `</div></div>`;
    });
    html += `</div></div>`;
  });

  container.innerHTML = html;
}

function togglePairingsWeek(weekNum, headerEl) {
  const body = document.getElementById('pw-body-' + weekNum);
  if (!body || !headerEl) return;
  const isOpen = body.classList.contains('pw-open');
  if (isOpen) {
    body.classList.remove('pw-open');
    headerEl.classList.remove('pw-expanded');
    headerEl.querySelector('.pw-chevron').textContent = '‚ñº';
  } else {
    body.classList.add('pw-open');
    headerEl.classList.add('pw-expanded');
    headerEl.querySelector('.pw-chevron').textContent = '‚ñ≤';
  }
}

function listenToScoringMode() {
  const wn = state.thisWeek.weekNum || 1;
  const ref = db.ref('scoringMode/' + wn);
  if (scoringModeListener) scoringModeListener.off();
  scoringModeListener = ref;
  ref.on('value', (snap) => {
    scoringMode = snap.val() || 'individual';
    renderLiveScoreInputs();
    updateScoringModeUI();
  });
}

function listenToGroupScorers() {
  const wn = state.thisWeek.weekNum || 1;
  const ref = db.ref('groupScorers/' + wn);
  if (groupScorersListener) groupScorersListener.off();
  groupScorersListener = ref;
  ref.on('value', (snap) => {
    groupScorersData = snap.val() || {};
    renderLiveScoreInputs();
    if (isEditor) renderGroupScorerAssignment();
  });
}

/* ‚îÄ‚îÄ‚îÄ Tee Time Helpers ‚îÄ‚îÄ‚îÄ */
function addSchedTeeTime() {
  const row = document.getElementById('sched-tee-times-row');
  const count = row.querySelectorAll('.tee-time-slot').length;
  if (count >= 6) return toast('Maximum 6 tee times.');
  const slot = document.createElement('div');
  slot.className = 'tee-time-slot';
  // Auto-increment by 8 minutes from last tee time
  const lastInput = row.querySelector('.tee-time-slot:last-child .sched-tee-input');
  let nextTime = '14:00';
  if (lastInput && lastInput.value) {
    const [h, m] = lastInput.value.split(':').map(Number);
    const totalMin = h * 60 + m + 8;
    nextTime = String(Math.floor(totalMin / 60)).padStart(2, '0') + ':' + String(totalMin % 60).padStart(2, '0');
  }
  slot.innerHTML = `<span class="slot-label">T${count + 1}</span><input type="time" class="sched-tee-input" value="${nextTime}"><button class="remove-slot" onclick="this.parentElement.remove();renumberTeeSlots('sched-tee-times-row','sched-tee-input')">‚úï</button>`;
  row.appendChild(slot);
}

function addManageWeekTeeTime() {
  const row = document.getElementById('tw-tee-times-row');
  const count = row.querySelectorAll('.tee-time-slot').length;
  if (count >= 6) return toast('Maximum 6 tee times.');
  const slot = document.createElement('div');
  slot.className = 'tee-time-slot';
  const lastInput = row.querySelector('.tee-time-slot:last-child .tw-tee-input');
  let nextTime = '14:00';
  if (lastInput && lastInput.value) {
    const [h, m] = lastInput.value.split(':').map(Number);
    const totalMin = h * 60 + m + 8;
    nextTime = String(Math.floor(totalMin / 60)).padStart(2, '0') + ':' + String(totalMin % 60).padStart(2, '0');
  }
  slot.innerHTML = `<span class="slot-label">T${count + 1}</span><input type="time" class="tw-tee-input" value="${nextTime}"><button class="remove-slot" onclick="this.parentElement.remove();renumberTeeSlots('tw-tee-times-row','tw-tee-input')">‚úï</button>`;
  row.appendChild(slot);
}

function renumberTeeSlots(rowId, inputClass) {
  const slots = document.getElementById(rowId)?.querySelectorAll('.tee-time-slot');
  if (slots) slots.forEach((s, i) => { const lbl = s.querySelector('.slot-label'); if (lbl) lbl.textContent = 'T' + (i + 1); });
}

function getTeeTimes(inputClass) {
  const inputs = document.querySelectorAll('.' + inputClass);
  const times = [];
  inputs.forEach(input => { if (input.value) times.push(input.value); });
  return times;
}

function setTeeTimes(rowId, inputClass, teeTimes) {
  const row = document.getElementById(rowId);
  if (!row || !teeTimes || !teeTimes.length) return;
  row.innerHTML = '';
  teeTimes.forEach((t, i) => {
    const slot = document.createElement('div');
    slot.className = 'tee-time-slot';
    const removeBtn = i > 0 ? `<button class="remove-slot" onclick="this.parentElement.remove();renumberTeeSlots('${rowId}','${inputClass}')">‚úï</button>` : '';
    slot.innerHTML = `<span class="slot-label">T${i + 1}</span><input type="time" class="${inputClass}" value="${t}">${removeBtn}`;
    row.appendChild(slot);
  });
}

function formatTeeTime(timeStr) {
  if (!timeStr) return '';
  const [h, m] = timeStr.split(':');
  const hr = parseInt(h);
  return (hr > 12 ? hr - 12 : hr) + ':' + m + (hr >= 12 ? ' PM' : ' AM');
}

/* ‚îÄ‚îÄ‚îÄ Sync Pairings with RSVPs ‚îÄ‚îÄ‚îÄ */
async function syncPairingsWithRSVPs() {
  const wn = state.thisWeek.weekNum || 1;
  const pairings = pairingsData[wn];
  if (!pairings || !pairings.length) return; // no pairings to sync

  const rsvps = rsvpData[wn] || {};
  const yesPlayerIds = new Set(Object.entries(rsvps).filter(([, s]) => s === 'yes').map(([id]) => id));

  let changed = false;
  const updated = [];

  // Remove players who are no longer RSVP'd yes
  pairings.forEach(group => {
    const filteredPlayers = (group.players || []).filter(pid => {
      if (!yesPlayerIds.has(pid)) { changed = true; return false; }
      return true;
    });
    updated.push({ teeTime: group.teeTime, players: filteredPlayers });
  });

  // Check if any RSVP'd yes players are missing from pairings ‚Äî add to smallest group
  const pairedIds = new Set(updated.flatMap(g => g.players));
  yesPlayerIds.forEach(pid => {
    if (!pairedIds.has(pid)) {
      changed = true;
      // Find the smallest group and add them
      let smallest = updated.reduce((min, g, i) => g.players.length < updated[min].players.length ? i : min, 0);
      updated[smallest].players.push(pid);
    }
  });

  // Remove empty groups
  const cleaned = updated.filter(g => g.players.length > 0);
  if (cleaned.length !== updated.length) changed = true;

  if (!changed) return;

  try {
    pairingsData[wn] = cleaned;
    await db.ref('pairings/' + wn).set(cleaned);
  } catch (e) {
    console.warn('Failed to sync pairings:', e);
  }
}

/* ‚îÄ‚îÄ‚îÄ Auto-Pairings ‚îÄ‚îÄ‚îÄ */
async function generatePairings() {
  const wn = state.thisWeek.weekNum || 1;
  const rsvps = rsvpData[wn] || {};

  // Get confirmed players
  const confirmedPlayers = getActivePlayers().filter(p => rsvps[p.id] === 'yes');
  if (confirmedPlayers.length === 0) return toast('No confirmed players to pair.');

  // Get tee times from schedule or thisWeek
  let teeTimes = [];
  const sd = scheduleData[wn];
  if (sd && sd.teeTimes && sd.teeTimes.length > 0) {
    teeTimes = sd.teeTimes;
  } else if (state.thisWeek.teeTimes && state.thisWeek.teeTimes.length > 0) {
    teeTimes = state.thisWeek.teeTimes;
  } else if (state.thisWeek.time) {
    teeTimes = [state.thisWeek.time];
  } else {
    teeTimes = ['14:00'];
  }

  // Shuffle players for random pairings
  const shuffled = [...confirmedPlayers];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }

  // Create groups of 4
  const groups = [];
  for (let i = 0; i < shuffled.length; i += 4) {
    groups.push(shuffled.slice(i, i + 4).map(p => p.id));
  }

  // If last group has fewer than 4 and there are multiple groups,
  // distribute remainder: if 1-2 leftover, add to previous groups to make 5s
  if (groups.length > 1) {
    const lastGroup = groups[groups.length - 1];
    if (lastGroup.length < 3) {
      // Distribute leftover players to earlier groups
      groups.pop();
      lastGroup.forEach((pid, idx) => {
        groups[idx % groups.length].push(pid);
      });
    }
  }

  // Assign tee times to groups
  const pairings = groups.map((playerIds, i) => ({
    teeTime: teeTimes[i % teeTimes.length] || teeTimes[0],
    players: playerIds
  }));

  try {
    await db.ref('pairings/' + wn).set(pairings);
    toast('Pairings generated! ' + groups.length + ' groups created.');
  } catch (e) {
    toast('Failed to save pairings');
    console.warn(e);
  }
}

/* ‚îÄ‚îÄ‚îÄ Pairings Display ‚îÄ‚îÄ‚îÄ */
function renderPairingsDisplay() {
  const card = document.getElementById('pairings-card');
  const content = document.getElementById('pairings-content');
  if (!card || !content) return;

  const wn = state.thisWeek.weekNum || 1;
  const pairings = pairingsData[wn];

  if (!pairings || !pairings.length) {
    card.style.display = 'none';
    return;
  }

  card.style.display = 'block';

  let html = '';
  pairings.forEach((group, gi) => {
    const teeTimeStr = formatTeeTime(group.teeTime);
    html += `<div class="pairing-group">
      <div class="pairing-header">
        <span class="pairing-tee-time">${teeTimeStr || 'TBD'}</span>
        <span class="pairing-group-label">Group ${gi + 1}</span>
      </div>
      <div class="pairing-players">`;

    (group.players || []).forEach((pid, pi) => {
      const player = getActivePlayers().find(p => p.id === pid);
      if (player) {
        const gb = player.isGuest ? ' <span class="guest-badge">G</span>' : '';
        html += `<span class="pairing-player"><span class="pairing-num">${pi + 1}</span>${escHtml(player.name)}${gb}</span>`;
      }
    });

    html += `</div></div>`;
  });

  content.innerHTML = html;
}

/* ‚îÄ‚îÄ‚îÄ Master Course List ‚îÄ‚îÄ‚îÄ */
function courseNameToId(name) {
  return name.trim().toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
}

function listenToMasterCourses() {
  const ref = db.ref('courses');
  if (masterCoursesListener) masterCoursesListener.off();
  masterCoursesListener = ref;
  let seeded = false;
  ref.on('value', (snap) => {
    masterCourses = snap.val() || {};
    if (!seeded) {
      seeded = true;
      seedDefaultCourses();
    }
    populateCourseDatalist();
    renderSavedCoursesList();
  });
}

async function seedDefaultCourses() {
  const defaults = {
    'city-park':         { name: 'City Park',         pars: [4,3,4,4,3,4,4,3,5, 4,4,3,5,4,4,5,3,4] },
    'evergreen':         { name: 'Evergreen',         pars: [4,4,3,4,5,3,5,3,4, 3,5,3,4,4,4,3,4,4] },
    'kennedy-west':      { name: 'Kennedy West',      pars: [5,4,4,3,4,4,4,5,3, 5,4,4,3,4,4,4,5,3] },
    'kennedy-babe-lind': { name: 'Kennedy Babe Lind', pars: [5,4,3,4,3,4,5,4,4, 5,4,3,4,3,4,5,4,4] },
    'kennedy-creek':     { name: 'Kennedy Creek',     pars: [4,4,4,4,3,5,3,4,4, 4,4,4,4,3,5,3,4,4] },
    'overland-park':     { name: 'Overland Park',     pars: [4,3,5,4,4,4,4,3,5, 3,4,4,5,4,4,3,4,5] },
    'wellshire':         { name: 'Wellshire',         pars: [5,3,4,4,4,4,4,4,3, 4,3,4,4,3,4,4,4,5] },
    'aurora-hills':      { name: 'Aurora Hills',      pars: [4,5,3,4,4,4,3,5,4, 5,3,5,3,4,5,4,3,4] },
    'meadow-hills':      { name: 'Meadow Hills',     pars: [4,3,4,3,4,5,4,4,4, 5,4,4,3,4,3,5,3,4] },
    'murphy-creek':      { name: 'Murphy Creek',      pars: [4,4,5,4,3,5,4,3,4, 4,3,4,5,4,5,4,3,4] },
    'saddle-rock':       { name: 'Saddle Rock',       pars: [5,4,4,4,3,5,4,3,4, 4,4,5,4,3,4,3,5,4] },
    'springhill':        { name: 'Springhill',        pars: [4,3,3,5,4,3,4,3,3, 3,3,4,5,3,4,4,3,3] },
    'riverdale-knolls':  { name: 'Riverdale Knolls',  pars: [4,4,4,4,3,4,5,3,4, 4,4,5,5,3,4,4,3,4] },
    'riverdale-dunes':   { name: 'Riverdale Dunes',   pars: [4,4,5,3,4,4,4,3,5, 4,5,3,4,4,4,5,3,4] },
    'todd-creek':        { name: 'Todd Creek',        pars: [4,4,3,5,4,4,3,5,4, 4,3,4,4,5,4,4,3,5] },
    'interlocken-vista':     { name: 'Interlocken Vista',     pars: [4,3,4,5,3,4,4,5,4, 4,3,4,5,3,4,4,5,4] },
    'interlocken-sunshine':  { name: 'Interlocken Sunshine',  pars: [4,4,3,4,4,5,4,3,5, 4,4,3,4,4,5,4,3,5] },
    'interlocken-eldorado':  { name: 'Interlocken Eldorado',  pars: [4,3,4,4,5,3,4,4,5, 4,3,4,4,5,3,4,4,5] },
    'colorado-national': { name: 'Colorado National', pars: [4,5,4,4,3,4,5,4,3, 4,4,5,4,3,5,3,4,4] },
    'applewood':         { name: 'Applewood',         pars: [4,3,4,5,4,4,5,4,3, 4,3,4,4,3,5,5,3,4] },
    'fossil-trace':      { name: 'Fossil Trace',      pars: [5,4,3,4,3,4,4,4,5, 4,3,5,4,3,5,3,4,5] },
    'arrowhead':         { name: 'Arrowhead',         pars: [4,5,3,4,4,4,4,4,3, 4,3,4,3,4,4,5,3,5] },
    'stony-creek':       { name: 'Stony Creek',       pars: [4,3,4,3,4,4,3,5,3, 5,4,3,4,4,3,4,3,3] },
    'broken-tee':        { name: 'Broken Tee',        pars: [4,4,4,4,3,5,3,4,5, 3,4,4,5,4,5,4,3,4] },
    'the-ridge-at-castle-pines': { name: 'The Ridge at Castle Pines', pars: [4,5,4,3,5,4,3,4,4, 4,5,3,5,3,4,4,3,4] },
    'red-hawk-ridge':    { name: 'Red Hawk Ridge',    pars: [5,4,3,4,4,3,5,4,4, 4,3,4,5,3,4,5,3,5] },
    'plum-creek':        { name: 'Plum Creek',        pars: [4,5,3,4,4,4,4,5,3, 4,5,3,4,4,4,4,5,3] },
    'commonground':      { name: 'CommonGround',      pars: [4,3,5,4,4,3,5,4,4, 4,5,3,4,3,4,4,3,5] },
    'eisenhower-blue':   { name: 'Eisenhower Blue',   pars: [4,4,3,4,5,4,3,4,5, 4,5,4,3,4,4,5,3,4] },
    'eisenhower-silver': { name: 'Eisenhower Silver', pars: [4,4,3,5,4,4,5,3,4, 4,4,5,3,4,4,4,3,5] },
    'indian-tree-par-3': { name: 'Indian Tree Par 3', pars: [3,3,3,3,3,3,3,3,3, 3,3,3,3,3,3,3,3,3] }
  };
  // Only seed courses that don't already exist (merge, not overwrite)
  const missing = {};
  Object.entries(defaults).forEach(([id, data]) => {
    if (!masterCourses[id]) missing[id] = data;
  });
  if (Object.keys(missing).length === 0) return;
  try {
    await db.ref('courses').update(missing);
    console.log('Seeded ' + Object.keys(missing).length + ' new courses.');
  } catch (e) {
    console.warn('Could not seed courses:', e);
  }
}

function populateCourseDatalist() {
  const dl = document.getElementById('course-datalist');
  if (!dl) return;
  const opts = Object.values(masterCourses).map(c => '<option value="' + escHtml(c.name) + '">').join('');
  dl.innerHTML = opts;
  const schedDl = document.getElementById('sched-course-datalist');
  if (schedDl) schedDl.innerHTML = opts;
}

function selectNine(which) {
  selectedNine = which;
  document.querySelectorAll('#nine-toggle .nine-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.nine === which);
  });
  autoFillParsFromCourse();
}

function autoFillParsFromCourse() {
  const courseName = document.getElementById('tw-course-input')?.value.trim();
  if (!courseName) return;
  const courseId = courseNameToId(courseName);
  const course = masterCourses[courseId];
  if (!course || !course.pars || course.pars.length !== 18) return;

  const offset = selectedNine === 'back' ? 9 : 0;
  const ninePars = course.pars.slice(offset, offset + 9);

  for (let i = 0; i < 9; i++) {
    const input = document.getElementById('par-hole-' + i);
    if (input) input.value = ninePars[i] || 4;
  }
  const totalPar = ninePars.reduce((sum, p) => sum + p, 0);
  const parInput = document.getElementById('tw-par-input');
  if (parInput) parInput.value = totalPar;
  toast(courseName + ' (' + (selectedNine === 'back' ? 'Back' : 'Front') + ' 9) pars loaded!');
}

function autoFillSchedParFromCourse() {
  const name = document.getElementById('sched-course-input')?.value.trim();
  if (!name) return;
  const id = courseNameToId(name);
  const course = masterCourses[id];
  if (!course || !course.pars || course.pars.length !== 18) return;
  const frontPar = course.pars.slice(0, 9).reduce((s, p) => s + p, 0);
  const parInput = document.getElementById('sched-par-input');
  if (parInput) parInput.value = frontPar;
}

function toggleCourseManager() {
  const el = document.getElementById('course-manager');
  const arrow = document.getElementById('course-mgr-arrow');
  if (!el) return;
  const isHidden = el.style.display === 'none';
  el.style.display = isHidden ? 'block' : 'none';
  if (arrow) arrow.style.transform = isHidden ? 'rotate(90deg)' : '';
  if (isHidden) renderCourseManagerInputs();
}

function renderCourseManagerInputs() {
  ['cm-front-pars', 'cm-back-pars'].forEach((rowId, half) => {
    const row = document.getElementById(rowId);
    if (!row) return;
    // Only render if empty (to preserve user edits)
    if (row.children.length > 0) return;
    row.innerHTML = '';
    for (let i = 0; i < 9; i++) {
      const holeNum = half * 9 + i + 1;
      row.innerHTML += '<div class="par-hole-group"><span class="hole-num">H' + holeNum + '</span><input type="number" id="cm-par-' + (half * 9 + i) + '" value="4" min="3" max="6"></div>';
    }
  });
}

async function saveMasterCourse() {
  if (!isEditor) return;
  const name = document.getElementById('cm-course-name')?.value.trim();
  if (!name) return toast('Enter a course name.');
  const pars = [];
  for (let i = 0; i < 18; i++) {
    pars.push(parseInt(document.getElementById('cm-par-' + i)?.value) || 4);
  }
  const id = courseNameToId(name);
  try {
    await db.ref('courses/' + id).set({ name, pars });
    toast('"' + name + '" saved!');
    clearCourseForm();
  } catch (e) {
    toast('Failed to save course');
    console.warn(e);
  }
}

function clearCourseForm() {
  const nameEl = document.getElementById('cm-course-name');
  if (nameEl) nameEl.value = '';
  for (let i = 0; i < 18; i++) {
    const el = document.getElementById('cm-par-' + i);
    if (el) el.value = 4;
  }
}

function renderSavedCoursesList() {
  const el = document.getElementById('saved-courses-list');
  if (!el) return;
  const courses = Object.entries(masterCourses);
  if (courses.length === 0) {
    el.innerHTML = '<div class="empty-state">No courses saved yet.</div>';
    return;
  }
  el.innerHTML = courses.map(([id, c]) => {
    const p = c.pars || [];
    const frontPar = p.slice(0, 9).reduce((s, v) => s + v, 0);
    const backPar = p.slice(9, 18).reduce((s, v) => s + v, 0);
    return '<div class="saved-course-item"><div><div class="course-name">' + escHtml(c.name) + '</div><div class="course-pars-preview">Front: ' + frontPar + ' | Back: ' + backPar + ' | Total: ' + (frontPar + backPar) + '</div></div><div class="course-actions"><button onclick="editMasterCourse(\'' + id + '\')">Edit</button><button onclick="deleteMasterCourse(\'' + id + '\')">Delete</button></div></div>';
  }).join('');
}

function editMasterCourse(id) {
  const c = masterCourses[id];
  if (!c) return;
  // Ensure inputs are rendered
  renderCourseManagerForceRebuild();
  const nameEl = document.getElementById('cm-course-name');
  if (nameEl) nameEl.value = c.name;
  const pars = c.pars || [];
  for (let i = 0; i < 18; i++) {
    const el = document.getElementById('cm-par-' + i);
    if (el) el.value = pars[i] || 4;
  }
  // Make sure course manager is visible
  const mgr = document.getElementById('course-manager');
  if (mgr) mgr.style.display = 'block';
  const arrow = document.getElementById('course-mgr-arrow');
  if (arrow) arrow.style.transform = 'rotate(90deg)';
  if (nameEl) nameEl.scrollIntoView({ behavior: 'smooth' });
}

function renderCourseManagerForceRebuild() {
  ['cm-front-pars', 'cm-back-pars'].forEach((rowId, half) => {
    const row = document.getElementById(rowId);
    if (!row) return;
    row.innerHTML = '';
    for (let i = 0; i < 9; i++) {
      const holeNum = half * 9 + i + 1;
      row.innerHTML += '<div class="par-hole-group"><span class="hole-num">H' + holeNum + '</span><input type="number" id="cm-par-' + (half * 9 + i) + '" value="4" min="3" max="6"></div>';
    }
  });
}

async function deleteMasterCourse(id) {
  if (!isEditor) return;
  const c = masterCourses[id];
  if (!confirm('Delete course "' + (c?.name || id) + '"?')) return;
  try {
    await db.ref('courses/' + id).remove();
    toast('Course deleted.');
  } catch (e) {
    toast('Failed to delete course');
    console.warn(e);
  }
}

/* ‚îÄ‚îÄ‚îÄ Course Setup in Manage Week ‚îÄ‚îÄ‚îÄ */
function renderCourseSetup() {
  const row = document.getElementById('par-holes-row');
  const ldSel = document.getElementById('long-drive-select');
  if (!row || !ldSel) return;

  // Restore nine selection from saved data
  if (courseSetupData.nine) selectedNine = courseSetupData.nine;
  document.querySelectorAll('#nine-toggle .nine-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.nine === selectedNine);
  });

  const pars = courseSetupData.pars || [4,4,4,4,4,4,4,4,4];
  const ctpHoles = courseSetupData.ctpHoles || [];
  const longDriveHole = courseSetupData.longDriveHole;

  row.innerHTML = '';
  for (let i = 0; i < 9; i++) {
    const isCtpChecked = ctpHoles.includes(i) ? 'checked' : '';
    row.innerHTML += `
      <div class="par-hole-group">
        <span class="hole-num">H${i+1}</span>
        <input type="number" id="par-hole-${i}" value="${pars[i] || 4}" min="3" max="6" ${!isEditor ? 'disabled' : ''}>
        <label class="ctp-label"><input type="checkbox" id="ctp-hole-${i}" ${isCtpChecked} ${!isEditor ? 'disabled' : ''}> CTP</label>
      </div>
    `;
  }

  ldSel.innerHTML = '<option value="">None</option>';
  for (let i = 0; i < 9; i++) {
    const sel = longDriveHole === i ? 'selected' : '';
    ldSel.innerHTML += `<option value="${i}" ${sel}>Hole ${i+1}</option>`;
  }
  ldSel.disabled = !isEditor;
}

function getCourseSetupFromInputs() {
  const pars = [];
  const ctpHoles = [];
  for (let i = 0; i < 9; i++) {
    pars.push(parseInt(document.getElementById('par-hole-' + i)?.value) || 4);
    if (document.getElementById('ctp-hole-' + i)?.checked) ctpHoles.push(i);
  }
  const ldVal = document.getElementById('long-drive-select')?.value;
  const longDriveHole = ldVal !== '' && ldVal !== undefined ? parseInt(ldVal) : null;
  return { pars, ctpHoles, longDriveHole, nine: selectedNine };
}

/* ‚îÄ‚îÄ‚îÄ Round Status UI ‚îÄ‚îÄ‚îÄ */
function updateRoundStatusUI() {
  const badge = document.getElementById('round-status-badge');
  if (badge) {
    badge.className = 'round-status-badge round-status-' + roundStatus;
    badge.textContent = roundStatus === 'setup' ? 'Setup' : roundStatus === 'open' ? '‚óè Live' : 'Closed';
  }

  // Admin round control buttons
  const btnOpen = document.getElementById('btn-open-scoring');
  const btnClose = document.getElementById('btn-close-scoring');
  const btnReopen = document.getElementById('btn-reopen-scoring');
  if (btnOpen) btnOpen.style.display = (isEditor && roundStatus === 'setup') ? 'inline-block' : 'none';
  if (btnClose) btnClose.style.display = (isEditor && roundStatus === 'open') ? 'inline-block' : 'none';
  if (btnReopen) btnReopen.style.display = (isEditor && roundStatus === 'closed') ? 'inline-block' : 'none';

  // Show/hide score entry based on round status
  const entryDiv = document.getElementById('live-score-entry');
  if (entryDiv) entryDiv.style.display = (roundStatus === 'open') ? 'block' : 'none';

  // Show payout results if closed
  const payoutDiv = document.getElementById('payout-results');
  if (payoutDiv) payoutDiv.style.display = (roundStatus === 'closed') ? 'block' : 'none';

  // Contest selection for admin
  const contestDiv = document.getElementById('contest-selection');
  if (contestDiv) contestDiv.style.display = (roundStatus === 'closed' && isEditor) ? 'block' : 'none';

  if (roundStatus === 'closed') {
    renderPayouts();
    renderContestSelection();
  }
}

async function openScoring() {
  if (!isEditor) return;
  const wn = state.thisWeek.weekNum || 1;
  // Save course setup first
  const setup = getCourseSetupFromInputs();
  await db.ref('courseSetup/' + wn).set(setup);
  await db.ref('roundStatus/' + wn).set('open');
  toast('Scoring is now LIVE!');
}

async function closeScoring() {
  if (!isEditor) return;
  if (!confirm('Close scoring and calculate skins/payouts?')) return;
  const wn = state.thisWeek.weekNum || 1;
  await db.ref('roundStatus/' + wn).set('closed');

  // Also save totals to state.weeks for standings compatibility
  saveHoleScoresToWeekTotals();
  renderWinnerBanner();
  toast('Round closed! Skins & payouts calculated.');
}

async function reopenScoring() {
  if (!isEditor) return;
  if (!confirm('Reopen scoring for corrections?')) return;
  const wn = state.thisWeek.weekNum || 1;
  await db.ref('roundStatus/' + wn).set('open');
  toast('Scoring reopened for corrections.');
}

/* ‚îÄ‚îÄ‚îÄ Live Scoring Tab ‚îÄ‚îÄ‚îÄ */
function renderLiveScoring() {
  // Populate player select
  const sel = document.getElementById('live-player-select');
  if (sel) {
    const curVal = sel.value;
    sel.innerHTML = '<option value="">‚Äî Select Your Name ‚Äî</option>';
    const wn = state.thisWeek.weekNum || 1;
    const rsvps = rsvpData[wn] || {};
    // Show players who RSVP'd yes first, then all
    const allActive = getActivePlayers();
    const yesPlayers = allActive.filter(p => rsvps[p.id] === 'yes');
    const otherPlayers = allActive.filter(p => rsvps[p.id] !== 'yes');
    const sorted = [...yesPlayers, ...otherPlayers];
    sorted.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name + (p.isGuest ? ' [GUEST]' : '') + (rsvps[p.id] === 'yes' ? '' : ' (not RSVP\'d)');
      sel.appendChild(opt);
    });
    if (curVal) sel.value = curVal;
  }
  updateRoundStatusUI();
  updateScoringModeUI();
  renderLiveScoreInputs();
  renderLiveScorecardGrid();
}

function renderLiveScoreInputs() {
  const container = document.getElementById('live-hole-inputs');
  const saveBtn = document.getElementById('save-live-scores-btn');
  const totalDiv = document.getElementById('live-score-total');
  if (!container) return;

  const playerId = document.getElementById('live-player-select')?.value;
  if (!playerId || roundStatus !== 'open') {
    container.innerHTML = roundStatus !== 'open'
      ? '<div class="empty-state">Scoring is not open yet. Admin must open scoring in Manage Week.</div>'
      : '<div class="empty-state">Select your name above to enter scores.</div>';
    if (saveBtn) saveBtn.style.display = 'none';
    if (totalDiv) totalDiv.style.display = 'none';
    return;
  }

  // ‚îÄ‚îÄ GROUP MODE: show group scorecard ABOVE individual entry ‚îÄ‚îÄ
  // Group scorer can score for everyone; individual entry always available below.
  if (scoringMode === 'group') {
    const groupInfo = getPlayerGroupInfo(playerId);
    if (groupInfo) {
      const groupDiv = document.createElement('div');
      groupDiv.style.marginBottom = '24px';
      renderGroupScorecardGrid(groupDiv, groupInfo, playerId);
      // Add a group save button inside the group section
      const groupSaveBtn = document.createElement('button');
      groupSaveBtn.className = 'btn btn-primary';
      groupSaveBtn.style.cssText = 'margin-top:10px;font-size:0.82rem';
      groupSaveBtn.textContent = 'Save Group Scores';
      groupSaveBtn.onclick = saveGroupScores;
      groupDiv.appendChild(groupSaveBtn);
      // Separator
      const sep = document.createElement('div');
      sep.style.cssText = 'border-top:1px solid rgba(255,61,167,0.2);margin:18px 0 12px;padding-top:12px;font-size:0.78rem;color:var(--gray)';
      sep.textContent = '‚Äî or enter your own score below ‚Äî';
      container.innerHTML = '';
      container.appendChild(groupDiv);
      container.appendChild(sep);
      // Fall through to also render individual inputs below
    }
  }

  // ‚îÄ‚îÄ INDIVIDUAL MODE (existing logic) ‚îÄ‚îÄ
  const pars = courseSetupData.pars || [4,4,4,4,4,4,4,4,4];
  const scores = liveScoresData[playerId] || [];
  const isLocked = roundStatus === 'closed' && !isEditor;

  let html = '<div class="score-entry-row">';
  for (let i = 0; i < 9; i++) {
    const val = (scores[i] !== null && scores[i] !== undefined) ? scores[i] : '';
    const par = pars[i] || 4;
    let inputClass = '';
    if (val !== '' && val !== null) {
      if (val < par) inputClass = 'input-birdie';
      else if (val > par) inputClass = 'input-bogey';
    }
    html += `
      <div class="hole-input-group">
        <span class="hole-label">H${i+1}</span>
        <input type="number" id="live-hole-${i}" value="${val}" min="1" max="15"
          class="${inputClass}" ${isLocked ? 'disabled' : ''}
          oninput="updateLiveScoreStyle(${i})" onkeydown="if(event.key==='Enter'){event.preventDefault();focusNextLive(${i})}">
        <span class="par-label">Par ${par}</span>
      </div>
    `;
  }
  html += '</div>';
  // If group scorecard was rendered above, append individual below it; otherwise replace
  if (scoringMode === 'group' && container.children.length > 0) {
    const indivDiv = document.createElement('div');
    indivDiv.innerHTML = html;
    container.appendChild(indivDiv);
  } else {
    container.innerHTML = html;
  }

  if (saveBtn) saveBtn.style.display = isLocked ? 'none' : 'inline-block';
  renderLiveScoreTotal();
}

function updateLiveScoreStyle(holeIdx) {
  const input = document.getElementById('live-hole-' + holeIdx);
  if (!input) return;
  const pars = courseSetupData.pars || [4,4,4,4,4,4,4,4,4];
  const par = pars[holeIdx] || 4;
  const val = parseInt(input.value);
  input.className = '';
  if (!isNaN(val)) {
    if (val < par) input.className = 'input-birdie';
    else if (val > par) input.className = 'input-bogey';
  }
  renderLiveScoreTotal();
}

function focusNextLive(holeIdx) {
  if (holeIdx < 8) {
    const next = document.getElementById('live-hole-' + (holeIdx + 1));
    if (next) next.focus();
  } else {
    saveLiveScores();
  }
}

function renderLiveScoreTotal() {
  const totalDiv = document.getElementById('live-score-total');
  const playerId = document.getElementById('live-player-select')?.value;
  if (!totalDiv || !playerId) { if(totalDiv) totalDiv.style.display = 'none'; return; }

  const pars = courseSetupData.pars || [4,4,4,4,4,4,4,4,4];
  let total = 0, totalPar = 0, holes = 0;
  for (let i = 0; i < 9; i++) {
    const el = document.getElementById('live-hole-' + i);
    if (el) {
      const val = parseInt(el.value);
      if (!isNaN(val)) { total += val; totalPar += (pars[i] || 4); holes++; }
    } else {
      // Use Firebase data
      const scores = liveScoresData[playerId] || [];
      if (scores[i] !== null && scores[i] !== undefined) { total += scores[i]; totalPar += (pars[i] || 4); holes++; }
    }
  }

  if (holes === 0) { totalDiv.style.display = 'none'; return; }
  const diff = total - totalPar;
  const diffStr = diff > 0 ? '+' + diff : diff === 0 ? 'E' : diff;
  const diffClass = diff < 0 ? 'score-under' : diff === 0 ? 'score-even' : 'score-over';
  totalDiv.style.display = 'flex';
  totalDiv.innerHTML = `
    <div><span class="st-label">Holes</span><br><span class="st-value">${holes}/9</span></div>
    <div><span class="st-label">Total</span><br><span class="st-value">${total}</span></div>
    <div><span class="st-label">vs Par</span><br><span class="score-pill ${diffClass}" style="font-size:1rem">${diffStr}</span></div>
  `;
}

async function saveLiveScores() {
  const playerId = document.getElementById('live-player-select')?.value;
  if (!playerId) return toast('Select a player first.');
  if (roundStatus !== 'open' && !isEditor) return toast('Scoring is not open.');

  const wn = state.thisWeek.weekNum || 1;
  const scores = [];
  for (let i = 0; i < 9; i++) {
    const val = document.getElementById('live-hole-' + i)?.value;
    scores.push(val !== '' && val !== undefined ? parseInt(val) : null);
  }

  try {
    await db.ref('liveScores/' + wn + '/' + playerId).set(scores);
    toast('Scores saved!');
  } catch (e) {
    toast('Failed to save scores.');
    console.warn(e);
  }
}

/* ‚îÄ‚îÄ‚îÄ Live Scorecard Grid ‚îÄ‚îÄ‚îÄ */
function renderLiveScorecardGrid() {
  const grid = document.getElementById('live-scorecard-grid');
  if (!grid) return;

  const pars = courseSetupData.pars || [4,4,4,4,4,4,4,4,4];
  const ctpHoles = courseSetupData.ctpHoles || [];
  const longDriveHole = courseSetupData.longDriveHole;
  const wn = state.thisWeek.weekNum || 1;
  const rsvps = rsvpData[wn] || {};

  // Get players who have scores or RSVP'd yes
  const playersWithScores = Object.entries(liveScoresData)
    .filter(([, scores]) => Array.isArray(scores) && scores.some(s => s !== null && s !== undefined))
    .map(([id]) => id);
  const yesPlayers = getActivePlayers().filter(p => rsvps[p.id] === 'yes' || playersWithScores.includes(p.id));

  if (!yesPlayers.length) {
    grid.innerHTML = '<div class="empty-state">No players have entered scores yet.</div>';
    return;
  }

  // Build scorecard table
  let html = '<table class="scorecard"><thead><tr>';
  html += '<th style="text-align:left;position:sticky;left:0;background:rgba(255,61,167,0.12);z-index:3">Player</th>';
  for (let i = 0; i < 9; i++) {
    let hLabel = 'H' + (i+1);
    if (ctpHoles.includes(i)) hLabel += ' ‚õ≥';
    if (longDriveHole === i) hLabel += ' üí™';
    html += `<th>${hLabel}</th>`;
  }
  html += '<th>Tot</th><th>+/-</th></tr>';
  // Par row
  html += '<tr style="background:rgba(255,255,255,0.02)"><td class="player-name" style="font-weight:400;color:var(--gray);font-size:0.75rem">PAR</td>';
  let totalPar = 0;
  for (let i = 0; i < 9; i++) { totalPar += (pars[i]||4); html += `<td style="color:var(--gray);font-size:0.75rem">${pars[i]||4}</td>`; }
  html += `<td style="color:var(--gray);font-size:0.75rem;font-weight:700">${totalPar}</td><td></td></tr>`;
  html += '</thead><tbody>';

  // Player rows sorted by total (completed first)
  const rows = yesPlayers.map(p => {
    const scores = liveScoresData[p.id] || [];
    let total = 0, parPlayed = 0, holesPlayed = 0;
    for (let i = 0; i < 9; i++) {
      if (scores[i] !== null && scores[i] !== undefined) {
        total += scores[i]; parPlayed += (pars[i]||4); holesPlayed++;
      }
    }
    return { player: p, scores, total, parPlayed, holesPlayed };
  }).sort((a, b) => {
    if (a.holesPlayed === 0 && b.holesPlayed === 0) return 0;
    if (a.holesPlayed === 0) return 1;
    if (b.holesPlayed === 0) return -1;
    if (a.holesPlayed === 9 && b.holesPlayed < 9) return -1;
    if (b.holesPlayed === 9 && a.holesPlayed < 9) return 1;
    return a.total - b.total;
  });

  rows.forEach(({ player, scores, total, parPlayed, holesPlayed }) => {
    const canEdit = isEditor && roundStatus === 'open';
    html += `<tr>`;
    const gBadge = player.isGuest ? ' <span class="guest-badge">G</span>' : '';
    html += `<td class="player-name">${escHtml(player.name)}${gBadge}${canEdit ? ` <button style="font-size:0.55rem;background:none;border:1px solid rgba(255,61,167,0.3);color:var(--pink-light);padding:1px 5px;border-radius:4px;cursor:pointer" onclick="editLiveScores('${player.id}')">‚úèÔ∏è</button>` : ''}</td>`;
    for (let i = 0; i < 9; i++) {
      const s = scores[i];
      const par = pars[i] || 4;
      if (s === null || s === undefined) {
        html += '<td class="score-cell" style="color:var(--gray)">‚Äî</td>';
      } else {
        let cls = 'score-cell score-par';
        if (s <= par - 2) cls = 'score-cell score-eagle';
        else if (s === par - 1) cls = 'score-cell score-birdie';
        else if (s === par + 1) cls = 'score-cell score-bogey';
        else if (s >= par + 2) cls = 'score-cell score-dbl';
        html += `<td class="${cls}">${s}</td>`;
      }
    }
    if (holesPlayed > 0) {
      const diff = total - parPlayed;
      const diffStr = diff > 0 ? '+' + diff : diff === 0 ? 'E' : '' + diff;
      const diffClass = diff < 0 ? 'score-under' : diff === 0 ? 'score-even' : 'score-over';
      html += `<td class="total-cell">${total}</td>`;
      html += `<td><span class="score-pill ${diffClass}">${diffStr}</span></td>`;
    } else {
      html += '<td class="total-cell" style="color:var(--gray)">‚Äî</td><td></td>';
    }
    html += '</tr>';
  });

  html += '</tbody></table>';
  grid.innerHTML = html;
}

function editLiveScores(playerId) {
  // Admin selects this player for editing
  const sel = document.getElementById('live-player-select');
  if (sel) { sel.value = playerId; renderLiveScoreInputs(); }
}

/* ‚îÄ‚îÄ‚îÄ Scoring Mode (Admin) ‚îÄ‚îÄ‚îÄ */
async function setScoringMode(mode) {
  if (!isEditor) return;
  const wn = state.thisWeek.weekNum || 1;
  await db.ref('scoringMode/' + wn).set(mode);
  if (mode === 'group') {
    const pairings = pairingsData[wn] || [];
    if (pairings.length > 0 && Object.keys(groupScorersData).length === 0) {
      await autoAssignGroupScorers();
    }
  }
  toast(mode === 'group' ? 'Group scoring enabled.' : 'Individual scoring restored.');
}

function updateScoringModeUI() {
  document.querySelectorAll('#scoring-mode-toggle .smode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === scoringMode);
  });
  const desc = document.getElementById('scoring-mode-desc');
  if (desc) {
    desc.textContent = scoringMode === 'group'
      ? 'Group scorers see all players in their group. Everyone can still enter their own scores.'
      : 'Each player enters their own scores.';
  }
  const assignDiv = document.getElementById('group-scorer-assignment');
  if (assignDiv) {
    assignDiv.style.display = scoringMode === 'group' ? 'block' : 'none';
    if (scoringMode === 'group') renderGroupScorerAssignment();
  }
}

async function autoAssignGroupScorers() {
  const wn = state.thisWeek.weekNum || 1;
  const pairings = pairingsData[wn] || [];
  const scorers = {};
  pairings.forEach((group, idx) => {
    if (group.players && group.players.length > 0) {
      scorers[idx] = group.players[0];
    }
  });
  await db.ref('groupScorers/' + wn).set(scorers);
}

function renderGroupScorerAssignment() {
  const container = document.getElementById('group-scorer-list');
  if (!container) return;
  const wn = state.thisWeek.weekNum || 1;
  const pairings = pairingsData[wn] || [];
  if (!pairings.length) {
    container.innerHTML = '<div class="empty-state" style="font-size:0.8rem">Generate pairings first to assign group scorers.</div>';
    return;
  }
  let html = '';
  pairings.forEach((group, gi) => {
    const scorerId = groupScorersData[gi];
    html += `<div class="group-scorer-row">
      <span class="group-scorer-label">Group ${gi + 1}:</span>
      <select class="group-scorer-select" onchange="changeGroupScorer(${gi}, this.value)">`;
    (group.players || []).forEach(pid => {
      const player = getActivePlayers().find(p => p.id === pid);
      if (player) {
        html += `<option value="${pid}" ${pid === scorerId ? 'selected' : ''}>${escHtml(player.name)}</option>`;
      }
    });
    html += `</select></div>`;
  });
  container.innerHTML = html;
}

async function changeGroupScorer(groupIndex, playerId) {
  const wn = state.thisWeek.weekNum || 1;
  await db.ref('groupScorers/' + wn + '/' + groupIndex).set(playerId);
  toast('Group scorer updated.');
}

/* ‚îÄ‚îÄ‚îÄ Group Scoring Helpers ‚îÄ‚îÄ‚îÄ */
function getPlayerGroupInfo(playerId) {
  const wn = state.thisWeek.weekNum || 1;
  const pairings = pairingsData[wn] || [];
  for (let gi = 0; gi < pairings.length; gi++) {
    const group = pairings[gi];
    if (group.players && group.players.includes(playerId)) {
      const scorerId = groupScorersData[gi] || group.players[0];
      return { groupIndex: gi, players: group.players, scorerId, isScorer: playerId === scorerId, teeTime: group.teeTime };
    }
  }
  return null;
}

function renderGroupScorecardGrid(container, groupInfo, selectedPlayerId) {
  const pars = courseSetupData.pars || [4,4,4,4,4,4,4,4,4];
  const isScorer = groupInfo.isScorer;
  const isLocked = roundStatus === 'closed' && !isEditor;
  const courseName = courseSetupData.name || state.thisWeek.course || 'Course';
  const nine = courseSetupData.nine || 'front';
  const totalPar = pars.reduce((s, p) => s + (p || 4), 0);

  // Build header row: Player | H1 | H2 | ... | H9 | TOT | +/-
  let headerRow = '<tr><th style="text-align:left;min-width:80px">Player</th>';
  for (let i = 0; i < 9; i++) {
    headerRow += `<th>H${i + 1}</th>`;
  }
  headerRow += '<th>TOT</th><th>+/‚àí</th></tr>';

  // Par row
  let parRow = '<tr><td class="gs-player-name" style="font-size:0.68rem;color:var(--gray);font-weight:400">Par</td>';
  for (let i = 0; i < 9; i++) {
    parRow += `<td class="gs-par-header" style="font-size:0.7rem;color:var(--gray);background:rgba(255,61,167,0.04)">${pars[i] || 4}</td>`;
  }
  parRow += `<td style="font-size:0.75rem;font-weight:700;color:var(--gray);border-left:2px solid rgba(255,61,167,0.2)">${totalPar}</td>`;
  parRow += '<td></td></tr>';

  // Player rows
  let playerRows = '';
  groupInfo.players.forEach(pid => {
    const player = getActivePlayers().find(p => p.id === pid);
    if (!player) return;
    const scores = liveScoresData[pid] || [];
    const firstName = player.name.split(' ')[0];
    const isGroupScorer = pid === groupInfo.scorerId;
    // Scorer can edit all rows; non-scorers can edit only their own row
    const canEdit = (isScorer || pid === selectedPlayerId) && !isLocked;

    let total = 0, holesPlayed = 0;
    playerRows += `<tr>`;
    const gsBadge = player.isGuest ? ' <span class="guest-badge">G</span>' : '';
    playerRows += `<td class="gs-player-name ${isGroupScorer ? 'gs-scorer' : ''}" title="${escHtml(player.name)}">${escHtml(firstName)}${gsBadge}${isGroupScorer ? ' ‚úé' : ''}</td>`;

    for (let i = 0; i < 9; i++) {
      const val = (scores[i] !== null && scores[i] !== undefined) ? scores[i] : '';
      const par = pars[i] || 4;
      let cellClass = '';
      if (val !== '' && val !== null) {
        if (val < par) cellClass = 'gs-birdie';
        else if (val > par) cellClass = 'gs-bogey';
        total += Number(val);
        holesPlayed++;
      }

      if (canEdit) {
        playerRows += `<td><input type="number" class="gs-score-input ${cellClass}"
          id="gs-${pid}-hole-${i}" value="${val}" min="1" max="15"
          data-player="${pid}" data-hole="${i}"
          oninput="updateGroupScoreCardStyle('${pid}',${i})"
          onkeydown="groupScorecardKeyNav(event,'${pid}',${i})"
          ></td>`;
      } else {
        playerRows += `<td><span class="gs-score-display ${cellClass}">${val !== '' ? val : '‚Äì'}</span></td>`;
      }
    }

    // Total
    const diff = holesPlayed > 0 ? total - pars.slice(0, 9).reduce((s, p, idx) => {
      const sc = (scores[idx] !== null && scores[idx] !== undefined) ? 1 : 0;
      return s + (sc ? (p || 4) : 0);
    }, 0) : 0;
    const diffStr = holesPlayed > 0 ? (diff > 0 ? '+' + diff : diff === 0 ? 'E' : String(diff)) : '';
    const diffColor = diff < 0 ? 'color:var(--pink-hot)' : diff === 0 ? 'color:var(--white)' : 'color:var(--red-bad)';
    playerRows += `<td class="gs-total">${holesPlayed > 0 ? total : '‚Äì'}</td>`;
    playerRows += `<td class="gs-vs-par" style="${diffColor}">${diffStr}</td>`;
    playerRows += '</tr>';
  });

  // Build scorer picker ‚Äî any group member can choose who scores
  const allActive = getActivePlayers();
  let scorerPickerHtml = '<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap">';
  scorerPickerHtml += '<span style="font-size:0.78rem;color:var(--gray)">Group scorer:</span>';
  scorerPickerHtml += `<select class="group-scorer-select" onchange="changeGroupScorer(${groupInfo.groupIndex}, this.value)" style="font-size:0.82rem">`;
  groupInfo.players.forEach(pid => {
    const pl = allActive.find(p => p.id === pid);
    if (pl) {
      const sel = pid === groupInfo.scorerId ? 'selected' : '';
      scorerPickerHtml += `<option value="${pid}" ${sel}>${escHtml(pl.name)}</option>`;
    }
  });
  scorerPickerHtml += '</select>';
  if (!isScorer) {
    scorerPickerHtml += `<button class="btn btn-outline" style="font-size:0.72rem;padding:5px 12px" onclick="changeGroupScorer(${groupInfo.groupIndex},'${selectedPlayerId}')">I'll Score</button>`;
  }
  scorerPickerHtml += '</div>';

  const roleHint = isScorer
    ? 'You are scoring for everyone in this group'
    : 'Your group scorer enters scores for all ‚Äî you can also enter your own below';

  container.innerHTML = `
    <div class="group-scoring-header">
      <span class="group-scoring-badge">GROUP SCORING</span>
      Group ${groupInfo.groupIndex + 1} ‚Äî ${escHtml(courseName)} (${nine === 'front' ? 'Front' : 'Back'} 9)
    </div>
    ${scorerPickerHtml}
    <div style="font-size:0.72rem;color:var(--gray);margin-bottom:10px;font-style:italic">${roleHint}</div>
    <div class="group-scorecard-wrap">
      <table class="group-scorecard">
        <thead>${headerRow}</thead>
        <tbody>
          ${parRow}
          ${playerRows}
        </tbody>
      </table>
    </div>
  `;
}

function updateGroupScoreCardStyle(playerId, holeIdx) {
  const input = document.getElementById('gs-' + playerId + '-hole-' + holeIdx);
  if (!input) return;
  const pars = courseSetupData.pars || [4,4,4,4,4,4,4,4,4];
  const par = pars[holeIdx] || 4;
  const val = parseInt(input.value);
  input.classList.remove('gs-birdie', 'gs-bogey');
  if (!isNaN(val)) {
    if (val < par) input.classList.add('gs-birdie');
    else if (val > par) input.classList.add('gs-bogey');
  }
  // Auto-save this player's scores after any change
  autoSaveGroupPlayer(playerId);
}

function groupScorecardKeyNav(event, playerId, holeIdx) {
  if (event.key === 'Enter') {
    event.preventDefault();
    if (holeIdx < 8) {
      const next = document.getElementById('gs-' + playerId + '-hole-' + (holeIdx + 1));
      if (next) next.focus();
    } else {
      // Last hole ‚Äî move to first hole of next player in the group
      const selectedPlayer = document.getElementById('live-player-select')?.value;
      if (!selectedPlayer) return;
      const groupInfo = getPlayerGroupInfo(selectedPlayer);
      if (!groupInfo) return;
      const idx = groupInfo.players.indexOf(playerId);
      if (idx < groupInfo.players.length - 1) {
        const nextPlayer = groupInfo.players[idx + 1];
        const nextInput = document.getElementById('gs-' + nextPlayer + '-hole-0');
        if (nextInput) nextInput.focus();
      } else {
        // Last player, last hole ‚Äî save all
        saveGroupScores();
      }
    }
  } else if (event.key === 'ArrowDown') {
    event.preventDefault();
    const selectedPlayer = document.getElementById('live-player-select')?.value;
    if (!selectedPlayer) return;
    const groupInfo = getPlayerGroupInfo(selectedPlayer);
    if (!groupInfo) return;
    const idx = groupInfo.players.indexOf(playerId);
    if (idx < groupInfo.players.length - 1) {
      const nextInput = document.getElementById('gs-' + groupInfo.players[idx + 1] + '-hole-' + holeIdx);
      if (nextInput) nextInput.focus();
    }
  } else if (event.key === 'ArrowUp') {
    event.preventDefault();
    const selectedPlayer = document.getElementById('live-player-select')?.value;
    if (!selectedPlayer) return;
    const groupInfo = getPlayerGroupInfo(selectedPlayer);
    if (!groupInfo) return;
    const idx = groupInfo.players.indexOf(playerId);
    if (idx > 0) {
      const prevInput = document.getElementById('gs-' + groupInfo.players[idx - 1] + '-hole-' + holeIdx);
      if (prevInput) prevInput.focus();
    }
  }
}

function autoSaveGroupPlayer(playerId) {
  // Debounce auto-save per player (500ms)
  if (groupSaveTimers[playerId]) clearTimeout(groupSaveTimers[playerId]);
  groupSaveTimers[playerId] = setTimeout(() => {
    saveGroupPlayerScores(playerId);
  }, 500);
}

async function saveGroupPlayerScores(playerId) {
  if (roundStatus !== 'open' && !isEditor) return;
  const wn = state.thisWeek.weekNum || 1;
  const scores = [];
  for (let i = 0; i < 9; i++) {
    const input = document.getElementById('gs-' + playerId + '-hole-' + i);
    if (input) {
      const val = input.value;
      scores.push(val !== '' && val !== undefined ? parseInt(val) : null);
    } else {
      // Use existing data for non-editable cells
      const existing = liveScoresData[playerId] || [];
      scores.push(existing[i] !== undefined ? existing[i] : null);
    }
  }
  try {
    await db.ref('liveScores/' + wn + '/' + playerId).set(scores);
  } catch (e) {
    console.warn('Auto-save failed for', playerId, e);
  }
}

async function saveGroupScores() {
  if (roundStatus !== 'open' && !isEditor) return toast('Scoring is not open.');
  const selectedPlayer = document.getElementById('live-player-select')?.value;
  if (!selectedPlayer) return toast('No player selected.');
  const groupInfo = getPlayerGroupInfo(selectedPlayer);
  if (!groupInfo) return toast('No group found.');

  const wn = state.thisWeek.weekNum || 1;
  let savedCount = 0;
  for (const pid of groupInfo.players) {
    // Only save players whose inputs exist (editable)
    const firstInput = document.getElementById('gs-' + pid + '-hole-0');
    if (!firstInput) continue;
    const scores = [];
    for (let i = 0; i < 9; i++) {
      const input = document.getElementById('gs-' + pid + '-hole-' + i);
      if (input) {
        const val = input.value;
        scores.push(val !== '' && val !== undefined ? parseInt(val) : null);
      } else {
        const existing = liveScoresData[pid] || [];
        scores.push(existing[i] !== undefined ? existing[i] : null);
      }
    }
    try {
      await db.ref('liveScores/' + wn + '/' + pid).set(scores);
      savedCount++;
    } catch (e) {
      console.warn('Failed to save scores for', pid, e);
    }
  }
  toast('Scores saved for ' + savedCount + ' player' + (savedCount !== 1 ? 's' : '') + '!');
}

/* ‚îÄ‚îÄ‚îÄ Skins Calculation ‚îÄ‚îÄ‚îÄ */
function calculateSkins() {
  const pars = courseSetupData.pars || [4,4,4,4,4,4,4,4,4];
  const wn = state.thisWeek.weekNum || 1;
  const rsvps = rsvpData[wn] || {};

  // Get all players with complete or partial scores
  const activePlayers = getActivePlayers().filter(p => {
    const scores = liveScoresData[p.id];
    return scores && scores.some(s => s !== null && s !== undefined);
  });

  const numPlayers = activePlayers.length;
  if (numPlayers === 0) return { skinResults: [], numPlayers: 0 };

  const skinResults = [];

  for (let hole = 0; hole < 9; hole++) {
    const par = pars[hole] || 4;
    const holePot = numPlayers * 1; // $1 per player per hole from skins pot

    // Gather scores for this hole
    const holeScores = [];
    activePlayers.forEach(p => {
      const scores = liveScoresData[p.id] || [];
      if (scores[hole] !== null && scores[hole] !== undefined) {
        holeScores.push({ player: p, score: scores[hole] });
      }
    });

    if (holeScores.length === 0) {
      skinResults.push({ hole, par, result: 'no-scores', winners: [], amount: 0, holePot, isBirdie: false });
      continue;
    }

    // Check for birdies (par - 1 or better)
    const birdies = holeScores.filter(h => h.score <= par - 1);

    if (birdies.length > 0) {
      // Birdies ALWAYS win ‚Äî split among them
      const amount = holePot / birdies.length;
      skinResults.push({
        hole, par, result: 'birdie-win',
        winners: birdies.map(b => ({ player: b.player, score: b.score, amount })),
        holePot, isBirdie: true
      });
    } else {
      // No birdies ‚Äî lowest unique score wins
      const minScore = Math.min(...holeScores.map(h => h.score));
      const minPlayers = holeScores.filter(h => h.score === minScore);

      if (minPlayers.length === 1) {
        skinResults.push({
          hole, par, result: 'solo-win',
          winners: [{ player: minPlayers[0].player, score: minPlayers[0].score, amount: holePot }],
          holePot, isBirdie: false
        });
      } else {
        // Push ‚Äî tied low, no winner
        skinResults.push({ hole, par, result: 'push', winners: [], amount: 0, holePot, isBirdie: false });
      }
    }
  }

  return { skinResults, numPlayers };
}

/* ‚îÄ‚îÄ‚îÄ Low Gross Calculation ‚îÄ‚îÄ‚îÄ */
function calculateLowGross() {
  const activePlayers = getActivePlayers().filter(p => {
    const scores = liveScoresData[p.id];
    return scores && scores.filter(s => s !== null && s !== undefined).length === 9;
  });

  if (activePlayers.length === 0) return [];

  const totals = activePlayers.map(p => {
    const scores = liveScoresData[p.id];
    const total = scores.reduce((sum, s) => sum + (s || 0), 0);
    return { player: p, total };
  });

  const minTotal = Math.min(...totals.map(t => t.total));
  return totals.filter(t => t.total === minTotal);
}

/* ‚îÄ‚îÄ‚îÄ Payouts ‚îÄ‚îÄ‚îÄ */
function renderPayouts() {
  const container = document.getElementById('payout-content');
  const payoutDiv = document.getElementById('payout-results');
  if (!container || !payoutDiv) return;
  if (roundStatus !== 'closed') { payoutDiv.style.display = 'none'; return; }
  payoutDiv.style.display = 'block';

  const { skinResults, numPlayers } = calculateSkins();
  if (numPlayers === 0) {
    container.innerHTML = '<div class="empty-state">No scores available for payout calculation.</div>';
    return;
  }

  const ENTRY_FEE = 13;
  const SKINS_PER = 9, CTP_PER = 2, LD_PER = 1, LG_PER = 1;
  const skinsPot = numPlayers * SKINS_PER;
  const ctpPot = numPlayers * CTP_PER;
  const ldPot = numPlayers * LD_PER;
  const lgPot = numPlayers * LG_PER;

  // Track earnings per player
  const earnings = {};
  const getEarnings = (pid) => { if (!earnings[pid]) earnings[pid] = 0; return earnings[pid]; };
  const addEarnings = (pid, amt) => { if (!earnings[pid]) earnings[pid] = 0; earnings[pid] += amt; };

  let html = `<div style="margin-bottom:14px;font-size:0.85rem;color:var(--gray)">${numPlayers} players &middot; $${ENTRY_FEE}/player &middot; $${numPlayers * ENTRY_FEE} total pot</div>`;

  // === SKINS ===
  html += '<div class="payout-section">';
  html += `<div class="payout-section-title">üèåÔ∏è Skins <span style="font-size:0.75rem;color:var(--gray);font-weight:400">($${skinsPot} pot)</span></div>`;

  skinResults.forEach(sr => {
    const holeName = `Hole ${sr.hole + 1}`;
    if (sr.result === 'birdie-win') {
      const names = sr.winners.map(w => {
        addEarnings(w.player.id, w.amount);
        return escHtml(w.player.name);
      }).join(', ');
      html += `<div class="payout-row">
        <span><strong>${holeName}</strong>: <span class="payout-winner">${names}</span> <span class="payout-birdie-tag">BIRDIE</span> (${sr.winners[0].score})</span>
        <span class="payout-amount">$${sr.winners[0].amount.toFixed(2)}${sr.winners.length > 1 ? ' each' : ''}</span>
      </div>`;
    } else if (sr.result === 'solo-win') {
      const w = sr.winners[0];
      addEarnings(w.player.id, w.amount);
      html += `<div class="payout-row">
        <span><strong>${holeName}</strong>: <span class="payout-winner">${escHtml(w.player.name)}</span> (${w.score})</span>
        <span class="payout-amount">$${w.amount.toFixed(2)}</span>
      </div>`;
    } else {
      html += `<div class="payout-row"><span><strong>${holeName}</strong>: <span class="payout-push">Push</span></span><span class="payout-push">‚Äî</span></div>`;
    }
  });
  html += '</div>';

  // === CTP ===
  const ctpHoles = courseSetupData.ctpHoles || [];
  if (ctpHoles.length > 0) {
    const perCtpHole = ctpPot / ctpHoles.length;
    html += '<div class="payout-section">';
    html += `<div class="payout-section-title">‚õ≥ Closest to Pin <span style="font-size:0.75rem;color:var(--gray);font-weight:400">($${ctpPot} pot)</span></div>`;
    ctpHoles.forEach(h => {
      const winnerId = contestsData.ctp && contestsData.ctp[h];
      const winner = winnerId ? getActivePlayers().find(p => p.id === winnerId) : null;
      if (winner) {
        addEarnings(winner.id, perCtpHole);
        html += `<div class="payout-row"><span><strong>Hole ${h+1}</strong>: <span class="payout-winner">${escHtml(winner.name)}</span></span><span class="payout-amount">$${perCtpHole.toFixed(2)}</span></div>`;
      } else {
        html += `<div class="payout-row"><span><strong>Hole ${h+1}</strong>: <span class="payout-push">Not selected</span></span><span class="payout-push">‚Äî</span></div>`;
      }
    });
    html += '</div>';
  }

  // === LONG DRIVE ===
  const longDriveHole = courseSetupData.longDriveHole;
  if (longDriveHole !== null && longDriveHole !== undefined) {
    html += '<div class="payout-section">';
    html += `<div class="payout-section-title">üí™ Long Drive <span style="font-size:0.75rem;color:var(--gray);font-weight:400">($${ldPot} pot)</span></div>`;
    const winnerId = contestsData.longDrive;
    const winner = winnerId ? getActivePlayers().find(p => p.id === winnerId) : null;
    if (winner) {
      addEarnings(winner.id, ldPot);
      html += `<div class="payout-row"><span><strong>Hole ${longDriveHole+1}</strong>: <span class="payout-winner">${escHtml(winner.name)}</span></span><span class="payout-amount">$${ldPot.toFixed(2)}</span></div>`;
    } else {
      html += `<div class="payout-row"><span><strong>Hole ${longDriveHole+1}</strong>: <span class="payout-push">Not selected</span></span><span class="payout-push">‚Äî</span></div>`;
    }
    html += '</div>';
  }

  // === LOW GROSS ===
  const lowGrossWinners = calculateLowGross();
  html += '<div class="payout-section">';
  html += `<div class="payout-section-title">üèÜ Low Gross <span style="font-size:0.75rem;color:var(--gray);font-weight:400">($${lgPot} pot)</span></div>`;
  if (lowGrossWinners.length > 0) {
    const perWinner = lgPot / lowGrossWinners.length;
    lowGrossWinners.forEach(w => {
      addEarnings(w.player.id, perWinner);
      html += `<div class="payout-row"><span><span class="payout-winner">${escHtml(w.player.name)}</span> (${w.total})</span><span class="payout-amount">$${perWinner.toFixed(2)}</span></div>`;
    });
  } else {
    html += `<div class="payout-row"><span class="payout-push">Not yet determined (need all 9 holes)</span><span class="payout-push">‚Äî</span></div>`;
  }
  html += '</div>';

  // === TOTAL EARNINGS ===
  html += '<div class="payout-section" style="margin-top:18px;padding-top:14px;border-top:2px solid rgba(255,61,167,0.2)">';
  html += '<div class="payout-section-title">üí∞ Total Earnings</div>';

  const earningsArr = Object.entries(earnings)
    .map(([pid, amt]) => {
      const p = getActivePlayers().find(pl => pl.id === pid);
      return p ? { player: p, earnings: amt, net: amt - ENTRY_FEE } : null;
    })
    .filter(Boolean)
    .sort((a, b) => b.earnings - a.earnings);

  // Also include players with 0 earnings
  const activePlayersEarnings = getActivePlayers().filter(p => {
    const scores = liveScoresData[p.id];
    return scores && scores.some(s => s !== null && s !== undefined);
  });
  activePlayersEarnings.forEach(p => {
    if (!earningsArr.find(e => e.player.id === p.id)) {
      earningsArr.push({ player: p, earnings: 0, net: -ENTRY_FEE });
    }
  });
  earningsArr.sort((a, b) => b.net - a.net);

  earningsArr.forEach(e => {
    const netClass = e.net > 0 ? 'earnings-positive' : e.net < 0 ? 'earnings-negative' : 'earnings-even';
    const netStr = e.net > 0 ? '+$' + e.net.toFixed(2) : e.net === 0 ? '$0.00' : '-$' + Math.abs(e.net).toFixed(2);
    html += `<div class="earnings-row">
      <span>${escHtml(e.player.name)}: <strong>$${e.earnings.toFixed(2)}</strong></span>
      <span class="${netClass}">Net: ${netStr}</span>
    </div>`;
  });
  html += '</div>';

  container.innerHTML = html;
}

/* ‚îÄ‚îÄ‚îÄ Contest Winner Selection (Admin) ‚îÄ‚îÄ‚îÄ */
function renderContestSelection() {
  const container = document.getElementById('contest-selection-content');
  if (!container || !isEditor) return;

  const wn = state.thisWeek.weekNum || 1;
  const rsvps = rsvpData[wn] || {};
  const activePlayers = getActivePlayers().filter(p => {
    const scores = liveScoresData[p.id];
    return scores && scores.some(s => s !== null && s !== undefined);
  });

  if (activePlayers.length === 0) {
    container.innerHTML = '<div class="empty-state">No players with scores yet.</div>';
    return;
  }

  let html = '';

  // CTP selection
  const ctpHoles = courseSetupData.ctpHoles || [];
  if (ctpHoles.length > 0) {
    html += '<div style="margin-bottom:16px"><label style="margin-bottom:8px;display:block">‚õ≥ Closest to Pin Winners</label>';
    html += '<div class="contest-select-row">';
    ctpHoles.forEach(h => {
      const curWinner = contestsData.ctp && contestsData.ctp[h] ? contestsData.ctp[h] : '';
      html += `<div class="form-group">
        <label>Hole ${h+1}</label>
        <select id="ctp-winner-${h}" onchange="saveContestWinner('ctp',${h})">
          <option value="">‚Äî Select ‚Äî</option>
          ${activePlayers.map(p => `<option value="${p.id}" ${p.id === curWinner ? 'selected' : ''}>${escHtml(p.name)}</option>`).join('')}
        </select>
      </div>`;
    });
    html += '</div></div>';
  }

  // Long drive selection
  const longDriveHole = courseSetupData.longDriveHole;
  if (longDriveHole !== null && longDriveHole !== undefined) {
    const curWinner = contestsData.longDrive || '';
    html += '<div style="margin-bottom:16px"><label style="margin-bottom:8px;display:block">üí™ Long Drive Winner</label>';
    html += '<div class="contest-select-row">';
    html += `<div class="form-group">
      <label>Hole ${longDriveHole+1}</label>
      <select id="ld-winner" onchange="saveContestWinner('longDrive')">
        <option value="">‚Äî Select ‚Äî</option>
        ${activePlayers.map(p => `<option value="${p.id}" ${p.id === curWinner ? 'selected' : ''}>${escHtml(p.name)}</option>`).join('')}
      </select>
    </div>`;
    html += '</div></div>';
  }

  if (!html) html = '<div class="empty-state">No contests configured for this week.</div>';
  container.innerHTML = html;
}

async function saveContestWinner(type, holeIdx) {
  if (!isEditor) return;
  const wn = state.thisWeek.weekNum || 1;

  if (type === 'ctp') {
    const val = document.getElementById('ctp-winner-' + holeIdx)?.value || null;
    await db.ref('contests/' + wn + '/ctp/' + holeIdx).set(val);
    toast('CTP winner saved');
  } else if (type === 'longDrive') {
    const val = document.getElementById('ld-winner')?.value || null;
    await db.ref('contests/' + wn + '/longDrive').set(val);
    toast('Long drive winner saved');
  }
}

/* ‚îÄ‚îÄ‚îÄ Save Hole Scores to Week Totals (for standings compatibility) ‚îÄ‚îÄ‚îÄ */
function saveHoleScoresToWeekTotals() {
  const wn = state.thisWeek.weekNum || 1;
  const pars = courseSetupData.pars || [4,4,4,4,4,4,4,4,4];
  const totalPar = pars.reduce((s, p) => s + p, 0);
  const scores = {};

  getActivePlayers().forEach(p => {
    const holeScores = liveScoresData[p.id];
    if (holeScores && holeScores.filter(s => s !== null && s !== undefined).length > 0) {
      const total = holeScores.reduce((sum, s) => sum + (s || 0), 0);
      scores[p.id] = total;
    }
  });

  if (Object.keys(scores).length > 0) {
    const weekResult = {
      par: totalPar,
      course: state.thisWeek.course || '',
      scores
    };
    state.weeks[wn] = weekResult;
    saveState();
    // Sync to Firebase so all devices can see the results
    db.ref('weekResults/' + wn).set(weekResult).catch(e => {
      console.error('Error saving week results to Firebase:', e);
      pendingSyncs[wn] = weekResult;
    });
  }
}

/* ‚îÄ‚îÄ‚îÄ Flush pending week result syncs to Firebase ‚îÄ‚îÄ‚îÄ */
async function flushPendingSyncs() {
  const weeks = Object.keys(pendingSyncs);
  if (!weeks.length) return;
  for (const wn of weeks) {
    try {
      await db.ref('weekResults/' + wn).set(pendingSyncs[wn]);
      delete pendingSyncs[wn];
      console.log('Synced pending week ' + wn + ' to Firebase');
    } catch (e) {
      console.warn('Retry sync failed for week ' + wn + ':', e);
    }
  }
}

/* ‚îÄ‚îÄ‚îÄ Listen to Week Results from Firebase (cross-device sync) ‚îÄ‚îÄ‚îÄ */
function listenToWeekResults() {
  const ref = db.ref('weekResults');
  if (weekResultsListener) weekResultsListener.off();
  weekResultsListener = ref;
  let firstLoad = true;
  ref.on('value', (snap) => {
    const results = snap.val() || {};
    let changed = false;

    // On first load: push any local-only week data up to Firebase
    if (firstLoad) {
      firstLoad = false;
      const localWeeks = Object.keys(state.weeks).filter(w => {
        const wd = state.weeks[w];
        return wd && wd.scores && Object.keys(wd.scores).length > 0;
      });
      const updates = {};
      localWeeks.forEach(wn => {
        const fbData = results[wn];
        const localData = state.weeks[wn];
        const fbCount = fbData ? Object.keys(fbData.scores || {}).length : 0;
        const localCount = Object.keys(localData.scores || {}).length;
        // Push to Firebase if local has scores that Firebase doesn't
        if (localCount > fbCount) {
          updates['weekResults/' + wn] = localData;
        }
      });
      if (Object.keys(updates).length > 0) {
        console.log('Syncing local week results to Firebase:', Object.keys(updates));
        db.ref().update(updates)
          .then(() => console.log('Week results synced to Firebase successfully'))
          .catch(e => {
            console.error('Sync to Firebase failed:', e);
            // Queue for retry on next visibility change
            Object.entries(updates).forEach(([path, data]) => {
              const wn = path.replace('weekResults/', '');
              pendingSyncs[wn] = data;
            });
          });
      }
    }

    // Merge Firebase week results into local state
    Object.entries(results).forEach(([wn, data]) => {
      if (data && data.scores) {
        const existing = state.weeks[wn];
        const fbScoreCount = Object.keys(data.scores).length;
        const localScoreCount = existing ? Object.keys(existing.scores || {}).length : 0;
        // Use Firebase data if it has more scores or if local doesn't have this week
        if (!existing || fbScoreCount >= localScoreCount) {
          state.weeks[wn] = data;
          changed = true;
        }
      }
    });
    if (changed) {
      saveState();
      renderStandings();
      renderHistory(null);
      renderWinnerBanner();
    }
  });
}

/* ‚îÄ‚îÄ‚îÄ Winner Banner ‚îÄ‚îÄ‚îÄ */
function renderWinnerBanner() {
  const banner = document.getElementById('winner-banner');
  const nameEl = document.getElementById('winner-name');
  const detailsEl = document.getElementById('winner-details');
  if (!banner || !nameEl || !detailsEl) return;

  // Find the most recent completed week with scores
  const completedWeeks = Object.keys(state.weeks)
    .filter(w => {
      const wd = state.weeks[w];
      return wd && wd.scores && Object.keys(wd.scores).length > 0;
    })
    .sort((a, b) => +b - +a); // newest first

  if (completedWeeks.length === 0) {
    banner.classList.remove('visible');
    return;
  }

  const latestWeek = completedWeeks[0];
  const wd = state.weeks[latestWeek];
  const scores = wd.scores || {};
  const par = wd.par || 36;
  const course = wd.course || '';

  // Find lowest score (winner)
  let bestScore = Infinity;
  let winnerId = null;
  Object.entries(scores).forEach(([pid, score]) => {
    if (score < bestScore) { bestScore = score; winnerId = pid; }
  });

  if (!winnerId) { banner.classList.remove('visible'); return; }

  const winner = getActivePlayers().find(p => p.id === winnerId) || state.players.find(p => p.id === winnerId);
  if (!winner) { banner.classList.remove('visible'); return; }

  const diff = bestScore - par;
  const diffStr = diff > 0 ? '+' + diff : diff === 0 ? 'E' : '' + diff;

  nameEl.textContent = winner.name;
  let detailParts = [`Week ${latestWeek}`];
  if (course) detailParts.push(course);
  detailParts.push(`Score: <span class="winner-score">${bestScore}</span> (${diffStr})`);
  detailsEl.innerHTML = detailParts.join(' ¬∑ ');

  banner.classList.add('visible');
}

/* ‚îÄ‚îÄ‚îÄ Season Champion Banner ‚îÄ‚îÄ‚îÄ */
function renderSeasonChampBanner() {
  const banner = document.getElementById('season-champ-banner');
  const nameEl = document.getElementById('champ-name');
  const detailsEl = document.getElementById('champ-details');
  if (!banner || !nameEl || !detailsEl) return;

  // Get the most recent past season
  const seasonKeys = Object.keys(PAST_SEASONS).sort();
  if (seasonKeys.length === 0) { banner.style.display = 'none'; return; }
  const latestKey = seasonKeys[seasonKeys.length - 1];
  const season = PAST_SEASONS[latestKey];
  if (!season || !season.weeks || season.weeks.length === 0) { banner.style.display = 'none'; return; }

  // Last week winner
  const lastWeek = season.weeks[season.weeks.length - 1];
  let lastWkWinner = null, lastWkBest = Infinity;
  Object.entries(lastWeek.scores).forEach(([name, score]) => {
    if (score < lastWkBest) { lastWkBest = score; lastWkWinner = name; }
  });

  // Season avg champion (lowest avg, min 5 rounds)
  const allPlayers = {};
  season.weeks.forEach(wk => {
    Object.entries(wk.scores).forEach(([name, score]) => {
      if (!allPlayers[name]) allPlayers[name] = { rounds: 0, total: 0 };
      allPlayers[name].rounds++;
      allPlayers[name].total += score;
    });
  });
  const qualified = Object.entries(allPlayers)
    .filter(([, s]) => s.rounds >= 10)
    .map(([name, s]) => ({ name, avg: (s.total / s.rounds).toFixed(1), rounds: s.rounds }))
    .sort((a, b) => parseFloat(a.avg) - parseFloat(b.avg));

  const seasonChamp = qualified[0];

  // Update the banner label to show the season year
  const labelEl = banner.querySelector('.champ-label');
  if (labelEl) labelEl.textContent = latestKey + ' Season Champion';

  if (seasonChamp) {
    nameEl.textContent = seasonChamp.name;
    let parts = [`Avg: <span>${seasonChamp.avg}</span>`];
    parts.push(`${seasonChamp.rounds} rounds`);
    if (lastWkWinner) parts.push(`Final Week Winner: <span>${lastWkWinner}</span> (${lastWkBest})`);
    detailsEl.innerHTML = parts.join(' ¬∑ ');
  } else if (lastWkWinner) {
    nameEl.textContent = lastWkWinner;
    detailsEl.innerHTML = `Final Week: <span>${lastWkBest}</span> at ${lastWeek.course}`;
  } else {
    banner.style.display = 'none';
    return;
  }
  banner.style.display = 'block';
}

/* ‚îÄ‚îÄ‚îÄ Render All ‚îÄ‚îÄ‚îÄ */
function renderAll() {
  renderPlayers();
  populateWeekSelect();
  renderScoreEntry();
  renderStandings();
  renderHistory(null);
  renderThisWeek();
  renderSchedule();
  applyMode();
  renderLiveScoring();
  renderWinnerBanner();
  renderSeasonChampBanner();
}

/* ‚îÄ‚îÄ‚îÄ Past Seasons Data ‚îÄ‚îÄ‚îÄ */
const PAST_SEASONS = {
  '2024': {
    weeks: [
      { date:'4/16/2024', course:'Broken Tee', par:36, scores:{
        'Chris Hamp':42,'Gamal Kader':45,'Jami Andregg':51,'Ken Walton':47,'Matthew Walton':49,'Gregory Walton':50,'Dave Stokes':49,'James Fouther':53,'Jim Ortega':47,'Robert Perkowski':46,'Tim Marchbank':46,'Zach Spratt':56,'Walter Jackson':45,'Mike Mensendick':46,'Ken Carbello':48,'Mike Bryant':52,'Dallas Walton':47,'Roland Jones':50,'Reggie Gamlin':42,'Logan J':42,'Rob Sanchez':52,'Daniel Nunez':43,'Preston Bryant':49,'Les Perry':45,'William Perkowski':51,'Ryan Marchbank':49,'Rob Hoffschneider':46,'Kim F':43,'Phillip Jackson':51,'Lonnie Dixon':47,'Victoria Braucher':53
      }},
      { date:'4/23/2024', course:'Aurora Hills', par:36, scores:{
        'Chris Hamp':39,'Gamal Kader':41,'Jami Andregg':48,'Ken Walton':43,'Matthew Walton':50,'James Fouther':48,'Jim Ortega':42,'Robert Perkowski':44
      }},
      { date:'5/7/2024', course:'Overland', par:36, scores:{
        'Chris Hamp':43,'Gamal Kader':42,'Jami Andregg':50,'Ken Walton':53,'Matthew Walton':50,'Gregory Walton':50,'Dave Stokes':50,'James Fouther':52,'Jim Ortega':46,'Robert Perkowski':51,'Tim Marchbank':44,'Mike Mensendick':46,'Ken Carbello':50,'Mike Bryant':51,'Roland Jones':53
      }},
      { date:'5/14/2024', course:'Broken Tee', par:36, scores:{
        'Chris Hamp':42,'Gamal Kader':45,'Jami Andregg':53,'Ken Walton':49,'Gregory Walton':52,'Dave Stokes':53,'Dwayne Crussell':44,'James Fouther':50,'Jim Ortega':50,'Robert Perkowski':52,'Zach Spratt':53,'Walter Jackson':44
      }},
      { date:'5/28/2024', course:'Kennedy', par:36, scores:{
        'Chris Hamp':41,'Gamal Kader':43,'Jami Andregg':52,'Ken Walton':49,'Matthew Walton':43,'Gregory Walton':49,'Darin Wayne':49,'Dave Stokes':53,'James Fouther':54,'Jim Ortega':52,'Robert Perkowski':52,'Tim Marchbank':44,'Walter Jackson':41,'Mike Mensendick':48,'Ken Carbello':50,'Mike Bryant':51,'Roland Jones':53
      }},
      { date:'6/4/2024', course:'Foothills', par:36, scores:{
        'Chris Hamp':46,'Gamal Kader':49,'Jami Andregg':49,'Ken Walton':44,'Matthew Walton':52,'Gregory Walton':47,'Dave Stokes':47,'James Fouther':55,'Jim Ortega':49,'Robert Perkowski':49,'Tim Marchbank':49,'Walter Jackson':49,'Mike Mensendick':44,'Reggie Gamlin':46,'Logan J':42,'Rob Sanchez':52,'Daniel Nunez':47,'Les Perry':49,'William Perkowski':52,'Rob Hoffschneider':46
      }},
      { date:'6/11/2024', course:'Overland', par:36, scores:{
        'Chris Hamp':38,'Gamal Kader':47,'Jami Andregg':49,'Ken Walton':44,'Matthew Walton':52,'Gregory Walton':45,'Darin Wayne':52,'Dave Stokes':50,'James Fouther':52,'Jim Ortega':48,'Robert Perkowski':41,'Tim Marchbank':47,'Walter Jackson':41,'Mike Mensendick':49,'Roland Jones':50,'Reggie Gamlin':42,'Daniel Nunez':44,'Les Perry':49,'William Perkowski':46,'Kim F':43
      }},
      { date:'6/18/2024', course:'Murphy Creek', par:36, scores:{
        'Chris Hamp':42,'Gamal Kader':50,'Jami Andregg':53,'Ken Walton':47,'Matthew Walton':52,'Gregory Walton':52,'Darin Wayne':49,'James Fouther':57,'Jim Ortega':47,'Robert Perkowski':48,'Tim Marchbank':49,'Walter Jackson':54,'Daniel Nunez':42,'Preston Bryant':49
      }},
      { date:'6/25/2024', course:'Meadows', par:36, scores:{
        'Chris Hamp':53,'Jim Ortega':48,'Robert Perkowski':48,'Tim Marchbank':49,'Ken Walton':51,'Matthew Walton':52,'Gregory Walton':57,'Dave Stokes':45,'James Fouther':53,'Dwayne Crussell':55
      }},
      { date:'7/9/2024', course:'Overland', par:36, scores:{
        'Chris Hamp':44,'Gamal Kader':45,'Jami Andregg':51,'Ken Walton':51,'Matthew Walton':43,'James Fouther':52,'Jim Ortega':46,'Robert Perkowski':45,'Tim Marchbank':45,'Zach Spratt':56,'Walter Jackson':40,'Ken Carbello':50,'Dallas Walton':47,'Daniel Nunez':44,'William Perkowski':51,'Ryan Marchbank':49,'Ken Walton':43
      }},
      { date:'7/16/2024', course:'Indian Tree', par:36, scores:{
        'Chris Hamp':40,'Gamal Kader':42,'Jami Andregg':50,'Ken Walton':51,'Matthew Walton':51,'Dwayne Crussell':55,'James Fouther':53,'Jim Ortega':46,'Tim Marchbank':51,'Zach Spratt':59,'Walter Jackson':43,'Mike Mensendick':45,'Ken Carbello':50,'Mike Bryant':51,'Roland Jones':53,'Reggie Gamlin':37,'Daniel Nunez':41,'Les Perry':41,'William Perkowski':46,'Ryan Marchbank':44,'Phillip Jackson':51,'Lonnie Dixon':47
      }},
      { date:'7/23/2024', course:'Kennedy', par:36, scores:{
        'Chris Hamp':43,'Jami Andregg':56,'Ken Walton':39,'Matthew Walton':55,'Dave Stokes':48,'James Fouther':55,'Jim Ortega':44,'Robert Perkowski':46,'Tim Marchbank':49,'Walter Jackson':49,'Reggie Gamlin':44,'Roland Jones':49,'Daniel Nunez':47,'William Perkowski':52,'Les Perry':41
      }},
      { date:'7/30/2024', course:'Riverdale', par:36, scores:{
        'Chris Hamp':41,'Gamal Kader':43,'Jami Andregg':53,'Ken Walton':46,'Matthew Walton':51,'Gregory Walton':48,'Dave Stokes':48,'Dwayne Crussell':59,'James Fouther':49,'Jim Ortega':44,'Robert Perkowski':39,'Tim Marchbank':42,'Zach Spratt':53,'Walter Jackson':42,'Ken Carbello':43,'Roland Jones':50,'Daniel Nunez':40
      }},
      { date:'8/6/2024', course:'Willis Case', par:36, scores:{
        'Chris Hamp':46,'Gamal Kader':46,'Jami Andregg':41,'Ken Walton':42,'Matthew Walton':46,'Gregory Walton':48,'Dave Stokes':43,'James Fouther':51,'Jim Ortega':45,'Robert Perkowski':47,'Tim Marchbank':43,'Walter Jackson':43,'Mike Mensendick':45,'Les Perry':41,'Reggie Gamlin':37,'Daniel Nunez':42,'William Perkowski':96
      }},
      { date:'8/13/2024', course:'Murphy Creek', par:36, scores:{
        'Chris Hamp':41,'Jami Andregg':53,'Ken Walton':50,'Matthew Walton':45,'Gregory Walton':49,'Dave Stokes':52,'James Fouther':57,'Robert Perkowski':45,'Tim Marchbank':41,'Walter Jackson':45,'Ken Carbello':45,'Ryan Marchbank':49,'Roland Jones':48,'Reggie Gamlin':44,'Victoria Braucher':53
      }},
      { date:'8/20/2024', course:'Common Ground', par:36, scores:{
        'Chris Hamp':41,'Gamal Kader':45,'Jami Andregg':59,'Ken Walton':45,'Matthew Walton':46,'Gregory Walton':53,'Dave Stokes':53,'James Fouther':60,'Jim Ortega':53,'Robert Perkowski':50,'Tim Marchbank':48,'Walter Jackson':45,'Mike Bryant':56,'William Perkowski':53
      }},
      { date:'8/27/2024', course:'City Park', par:70, scores:{
        'Chris Hamp':85,'Gamal Kader':87,'Jami Andregg':98,'Ken Walton':96,'Gregory Walton':95,'Dave Stokes':86,'James Fouther':98,'Robert Perkowski':87,'Walter Jackson':91,'Ken Carbello':45,'Ryan Marchbank':49,'Roland Jones':88,'Reggie Gamlin':89,'William Perkowski':96
      }},
      { date:'9/3/2024', course:'Westwoods', par:36, scores:{
        'Chris Hamp':43,'Matthew Walton':46,'James Fouther':50,'Jim Ortega':47,'Tim Marchbank':48,'Walter Jackson':43,'Ken Carbello':50,'Ryan Marchbank':47,'Lonnie Dixon':47
      }}
    ]
  },
  '2025': {
    weeks: [
      { date:'4/15/2025', course:'Kennedy', par:36, scores:{
        'Chris Hamp':38,'Dallas Walton':50,'Walter Jackson':51,'Jami Andregg':50,'Matthew Walton':47,'Ken Walton':44,'Robert Perkowski':45,'Gamal Kader':47,'Lonnie Dixon':49,'Ken Carbello':45,'Gregory Walton':45
      }},
      { date:'4/22/2025', course:'City Park', par:35, scores:{
        'Gamal Kader':40,'Ken Carbello':47,'Lonnie Dixon':42,'Robert Perkowski':44,'Walter Jackson':48,'Dallas Walton':51,'Jami Andregg':46,'Matthew Walton':46,'Ken Walton':42,'Jim Ortega':44,'Ryan Marchbank':39,'James Fouther':46,'Tim Marchbank':44,'William Perkowski':51,'Chris Hamp':43,'Gregory Walton':41
      }},
      { date:'4/29/2025', course:'Willis Case', par:36, scores:{
        'Jami Andregg':54,'Robert Perkowski':49,'Gamal Kader':48,'Ken Carbello':57,'Tim Marchbank':43,'Jim Ortega':50,'William Perkowski':50,'James Fouther':55,'Chris Hamp':45,'Ken Walton':48,'Robert Newell':23,'Ryan Marchbank':26
      }},
      { date:'5/13/2025', course:'Overland', par:36, scores:{
        'Matthew Walton':51,'Ken Walton':45,'Roland Jones':50,'Chris Hamp':45,'Jami Andregg':52,'Dallas Walton':55,'Ryan Marchbank':46,'Dwayne Crussell':51,'Lonnie Dixon':43,'Jim Ortega':47,'Gamal Kader':41,'Walter Jackson':45
      }},
      { date:'5/20/2025', course:'City Park', par:35, scores:{
        'Tim Marchbank':44,'Gamal Kader':48,'Lonnie Dixon':44,'Ken Walton':45,'Jim Ortega':42,'Matthew Walton':41,'Dallas Walton':45,'Jami Andregg':52,'Chris Hamp':40,'Roland Jones':47,'Dave Stokes':47,'Walter Jackson':44,'Robert Perkowski':48
      }},
      { date:'5/27/2025', course:'Overland', par:36, scores:{
        'Tim Marchbank':41,'Matthew Walton':45,'Lonnie Dixon':44,'James Fouther':49,'Rob Hoffschneider':42,'Jami Andregg':48,'Dallas Walton':45,'Chris Hamp':41,'Ken Walton':49,'Robert Perkowski':52,'Gamal Kader':45,'Ken Carbello':45,'Reggie Gamlin':43,'Jim Ortega':57,'Walter Jackson':48
      }},
      { date:'6/10/2025', course:'Willis Case', par:36, scores:{
        'Chris Hamp':43,'Dallas Walton':54,'Walter Jackson':42,'Phillip Jackson':55,'Jami Andregg':44,'Ken Walton':45,'Reggie Gamlin':48,'Dwayne Crussell':54,'Robert Perkowski':51,'Gamal Kader':47
      }},
      { date:'6/26/2025', course:'Westwoods', par:36, scores:{
        'Tim Marchbank':42,'Robert Perkowski':53,'Phillip Jackson':53,'Walter Jackson':49,'Gamal Kader':42,'Ken Walton':47,'Jerry Montoya':50,'William Perkowski':49,'Chris Hamp':49,'Lonnie Dixon':47,'James Fouther':51,'Jim Ortega':52,'Matthew Walton':53,'Jami Andregg':56,'Dallas Walton':54,'William Wittman':44,'Ben Pemble':54,'Evan Battey':66
      }},
      { date:'7/1/2025', course:'Kennedy', par:36, scores:{
        'Tim Marchbank':50,'Ryan Marchbank':54,'Micheal Bryant':50,'Lonnie Dixon':46,'Dave Stokes':51,'Carlos Bossy':49,'Denny Sharkey':44,'Ken Walton':46,'Walter Jackson':46,'Ben Pemble':54,'James Fouther':51,'Matthew Walton':52,'Chris Hamp':47,'Jami Andregg':54,'Gamal Kader':46,'Jim Ortega':50
      }},
      { date:'7/8/2025', course:'Walnut Creek', par:36, scores:{
        'Tim Marchbank':46,'Walter Jackson':41,'Robert Perkowski':47,'Lonnie Dixon':45,'Ben Pemble':58,'Gamal Kader':44,'Dallas Walton':47,'Denny Sharkey':43,'Ken Walton':46,'Chris Hamp':43,'Jim Ortega':46,'Carlos Bossy':44,'William Perkowski':50
      }},
      { date:'7/15/2025', course:'Kennedy', par:36, scores:{
        'Dallas Walton':53,'Ben Pemble':54,'Victoria':55,'Jami Andregg':52,'Chris Hamp':46,'Denny Sharkey':48,'Reggie Gamlin':48,'Walter Jackson':49,'Tim Marchbank':48,'Ken Walton':52,'Lonnie Dixon':46
      }},
      { date:'7/22/2025', course:'Westwoods', par:36, scores:{
        'Tim Marchbank':48,'Jim Ortega':48,'Matthew Walton':54,'Dallas Walton':50,'Ben Pemble':53,'Chris Hamp':51,'Lonnie Dixon':48,'Jami Andregg':50,'James Fouther':50,'Walter Jackson':48,'Ken Walton':50
      }},
      { date:'7/29/2025', course:'Foothills', par:36, scores:{
        'Matthew Walton':50,'Ken Walton':46,'Lonnie Dixon':52,'Phillip Jackson':59,'Walter Jackson':58,'Dallas Walton':47,'Ben Pemble':56,'Jim Ortega':49
      }},
      { date:'8/5/2025', course:'Willis Case', par:36, scores:{
        'William Wittman':44,'Ryan Marchbank':44,'Dallas Walton':50,'Matthew Walton':48,'Tim Marchbank':43,'Dave Stokes':53,'Ken Carbello':45,'Robert Perkowski':49,'Carlos Bossy':48,'Jim Ortega':49,'Lonnie Dixon':42
      }},
      { date:'8/12/2025', course:'Willis Case', par:36, scores:{
        'Gamal Kader':45,'Ken Carbello':48,'Denny Sharkey':47,'Lonnie Dixon':53,'James Fouther':52,'Gregory Walton':49,'Robert Perkowski':51,'Jami Andregg':49,'Brett':53,'Chris Hamp':44,'Tim Marchbank':45
      }},
      { date:'8/18/2025', course:'Indian Tree', par:36, scores:{
        'Ben Pemble':54,'Dallas Walton':42,'Matthew Walton':47,'Ryan Marchbank':46,'James Fouther':48,'Gregory Walton':42,'Ken Walton':46,'Lonnie Dixon':43,'Chris Hamp':40,'Jami Andregg':49,'Reggie Gamlin':40,'Robert Perkowski':45,'Denny Sharkey':43,'Gamal Kader':45,'Ken Carbello':40
      }},
      { date:'8/27/2025', course:'Overland', par:36, scores:{
        'Ryan Marchbank':46,'Lonnie Dixon':46,'Matthew Walton':55,'Jami Andregg':50,'Reggie Gamlin':43,'Ben Pemble':51,'Ryan Sims':48,'Chris Hamp':43,'Dave Stokes':48,'Ken Walton':40,'Gregory Walton':52,'Robert Perkowski':52,'Denny Sharkey':51
      }}
    ]
  }
};

let curPastSeason = '2025';
let curPastWeek = null;

function renderPastSeasons() {
  const pillsEl = document.getElementById('season-pills');
  const contentEl = document.getElementById('past-season-content');
  const seasons = Object.keys(PAST_SEASONS).sort();

  pillsEl.innerHTML = seasons.map(s => `
    <button class="week-pill ${s === curPastSeason ? 'active' : ''}" onclick="selectPastSeason('${s}')">${s} Season</button>
  `).join('');

  const season = PAST_SEASONS[curPastSeason];
  if (!season) { contentEl.innerHTML = '<div class="empty-state">No data for this season.</div>'; return; }

  const weeks = season.weeks;
  if (curPastWeek === null || curPastWeek >= weeks.length) curPastWeek = weeks.length - 1;

  // Week sub-pills
  let weekPills = '<div class="week-pills" style="margin-top:14px">' + weeks.map((w, i) => `
    <button class="week-pill ${i === curPastWeek ? 'active' : ''}" onclick="selectPastWeek(${i})">${w.date.split('/').slice(0,2).join('/')}</button>
  `).join('') + '</div>';

  const w = weeks[curPastWeek];
  const entries = Object.entries(w.scores).map(([name, score]) => ({ name, score, vsPar: score - w.par }))
    .sort((a, b) => a.score - b.score);

  // Season summary stats
  const allPlayers = {};
  weeks.forEach(wk => {
    Object.entries(wk.scores).forEach(([name, score]) => {
      if (!allPlayers[name]) allPlayers[name] = { rounds: 0, total: 0, best: Infinity };
      allPlayers[name].rounds++;
      allPlayers[name].total += score;
      if (score < allPlayers[name].best) allPlayers[name].best = score;
    });
  });
  const playerStats = Object.entries(allPlayers).map(([name, s]) => ({
    name, ...s, avg: (s.total / s.rounds).toFixed(1)
  })).sort((a, b) => parseFloat(a.avg) - parseFloat(b.avg));

  contentEl.innerHTML = `
    <div class="standings-meta" style="margin-top:16px">
      <div class="meta-stat"><div class="val">${Object.keys(allPlayers).length}</div><div class="lbl">Players</div></div>
      <div class="meta-stat"><div class="val">${weeks.length}</div><div class="lbl">Weeks</div></div>
      <div class="meta-stat"><div class="val">${playerStats[0]?.name || '‚Äî'}</div><div class="lbl">Lowest Avg (${playerStats[0]?.avg || '‚Äî'})</div></div>
    </div>
    ${weekPills}
    <div style="margin:16px 0 12px;display:flex;gap:20px;flex-wrap:wrap;align-items:center">
      <span style="font-family:'Outfit',sans-serif;font-size:1.15rem;color:var(--pink-hot);font-weight:700">
        ${escHtml(w.date)} ‚Äî ${escHtml(w.course)}
      </span>
      <span style="font-size:0.78rem;color:var(--gray)">Par ${w.par} &middot; ${entries.length} players</span>
    </div>
    <div class="score-table-wrap">
      <table>
        <thead><tr><th>#</th><th>Player</th><th>Score</th><th>vs Par</th></tr></thead>
        <tbody>
          ${entries.map((e, i) => {
            const rc = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other';
            const vpc = e.vsPar < 0 ? 'score-under' : e.vsPar === 0 ? 'score-even' : 'score-over';
            return `<tr ${i === 0 ? 'class="leader"' : ''}>
              <td><span class="rank-badge ${rc}">${i + 1}</span></td>
              <td><strong>${escHtml(e.name)}</strong></td>
              <td style="font-weight:700;font-size:1rem">${e.score}</td>
              <td><span class="score-pill ${vpc}">${e.vsPar > 0 ? '+' : ''}${e.vsPar}</span></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
    <div class="card" style="margin-top:22px">
      <div class="card-title">${curPastSeason} Season Standings (by Avg Score)</div>
      <div class="score-table-wrap">
        <table>
          <thead><tr><th>#</th><th>Player</th><th>Rounds</th><th>Avg</th><th>Best</th></tr></thead>
          <tbody>
            ${playerStats.map((p, i) => {
              const rc = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other';
              return `<tr ${i === 0 ? 'class="leader"' : ''}>
                <td><span class="rank-badge ${rc}">${i + 1}</span></td>
                <td><strong>${escHtml(p.name)}</strong></td>
                <td>${p.rounds}</td>
                <td style="color:var(--pink-hot);font-weight:700">${p.avg}</td>
                <td>${p.best}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function selectPastSeason(s) {
  curPastSeason = s;
  curPastWeek = null;
  renderPastSeasons();
}
function selectPastWeek(i) {
  curPastWeek = i;
  renderPastSeasons();
}

/* ‚îÄ‚îÄ‚îÄ One-time migration: remap old player IDs to current ones ‚îÄ‚îÄ‚îÄ */
async function migratePlayerIds() {
  try {
    const migrated = localStorage.getItem('fog-id-migration-done');
    if (migrated) return;

    // Old phone IDs ‚Üí current Firebase player IDs
    const idMap = {
      '1771279458546jgcd': '1771259947963k1u3',  // Chris Hamp
      '1771279458546a4p3': '1771259947963ue1a',  // Jami Andregg
      '1771279458546xesk': '1771259947963i9zt'   // Matthew Walton
    };
    const staleIds = ['1771273328812540j'];  // stray ID from third device
    const oldIds = Object.keys(idMap);
    const updates = {};

    // Remap liveScores/1
    const liveSnap = await db.ref('liveScores/1').once('value');
    const liveData = liveSnap.val() || {};
    for (const oldId of oldIds) {
      if (liveData[oldId] !== undefined) {
        updates['liveScores/1/' + idMap[oldId]] = liveData[oldId];
        updates['liveScores/1/' + oldId] = null;  // delete old
      }
    }

    // Remap weekResults/1/scores
    const weekSnap = await db.ref('weekResults/1/scores').once('value');
    const weekScores = weekSnap.val() || {};
    for (const oldId of oldIds) {
      if (weekScores[oldId] !== undefined) {
        updates['weekResults/1/scores/' + idMap[oldId]] = weekScores[oldId];
        updates['weekResults/1/scores/' + oldId] = null;
      }
    }

    // Clean up old + stale IDs from rsvps/1
    for (const oldId of [...oldIds, ...staleIds]) {
      updates['rsvps/1/' + oldId] = null;
    }

    // Clean up old + stale IDs from payments/1
    for (const oldId of [...oldIds, ...staleIds]) {
      updates['payments/1/' + oldId] = null;
    }

    // Fix pairings/1 ‚Äî replace old IDs in player arrays
    const pairSnap = await db.ref('pairings/1').once('value');
    const pairData = pairSnap.val();
    if (pairData && Array.isArray(pairData)) {
      const fixedPairings = pairData.map(group => {
        if (!group || !group.players) return group;
        return {
          ...group,
          players: group.players
            .map(pid => idMap[pid] || pid)
            .filter(pid => !staleIds.includes(pid))
            // Deduplicate (in case both old and new ID were in the array)
            .filter((pid, i, arr) => arr.indexOf(pid) === i)
        };
      });
      updates['pairings/1'] = fixedPairings;
    }

    if (Object.keys(updates).length > 0) {
      await db.ref().update(updates);
      console.log('Player ID migration complete:', updates);
    }

    localStorage.setItem('fog-id-migration-done', '1');
  } catch (e) {
    console.error('Player ID migration error:', e);
  }
}

/* ‚îÄ‚îÄ‚îÄ Pre-load roster if empty ‚îÄ‚îÄ‚îÄ */
const DEFAULT_ROSTER = [
  'Ben Pemble','Brooks O\'Hearn','Chris Hamp','Dallas Walton','Daniel Nunez',
  'Dave Stokes','Dwayne Crussell','Evan Battey','Gamal Kader','Gregory Walton',
  'Jami Andregg','James Fouther','Jerry Montoya','Jim Ortega','Ken Carbello',
  'Ken Walton','Kim F','Les Perry','Logan J','Lonnie Dixon',
  'Matthew Walton','Micheal Bryant','Mike Bryant','Mike Mensendick',
  'Phillip Jackson','Preston Bryant','Reggie Gamlin','Rob Hoffschneider',
  'Rob Sanchez','Robert Newell','Robert Perkowski','Roland Jones',
  'Roy Thomas','Ryan B','Ryan Marchbank','Tim Marchbank','Trey Turner',
  'Victoria Braucher','Walter Jackson','William Perkowski','William Wittman',
  'Zach Spratt','Denny Sharkey','Carlos Bossy','Brett',
  'Ryan Sims','Megan King','RJ Anchrum','Mamadou Kader','Mike Montoya'
];

function generatePlayerId(name) {
  // Deterministic ID from player name ‚Äî same name always produces same ID
  const hash = name.toLowerCase().split('').reduce((h, c) => ((h << 5) - h) + c.charCodeAt(0) | 0, 0);
  return 'p_' + Math.abs(hash).toString(36) + name.length.toString(36);
}

function seedRoster() {
  const seen = new Set();
  state.players = [];
  DEFAULT_ROSTER.forEach(name => {
    const lower = name.toLowerCase();
    if (!seen.has(lower)) {
      seen.add(lower);
      state.players.push({ id: generatePlayerId(name), name, handicap: 0 });
    }
  });
}

async function preloadDataIfEmpty() {
  try {
    await loadState();

    // Firebase is always the source of truth for thisWeek and the player roster
    try {
      const twSnap = await db.ref('thisWeek').once('value');
      const fbThisWeek = twSnap.val();
      if (fbThisWeek && fbThisWeek.weekNum) {
        state.thisWeek = fbThisWeek;
      }
    } catch(e) {
      console.warn('Firebase thisWeek sync error:', e);
    }

    try {
      const playersSnap = await db.ref('players').once('value');
      const fbPlayers = playersSnap.val();
      if (fbPlayers && Array.isArray(fbPlayers) && fbPlayers.length > 0) {
        // Firebase has players ‚Äî use them on every device
        state.players = fbPlayers;
      } else {
        // Firebase is empty ‚Äî seed roster and push to Firebase
        seedRoster();
        await db.ref('players').set(state.players);
      }
    } catch(e) {
      console.warn('Firebase players sync error:', e);
      // Offline fallback ‚Äî seed locally if needed
      if (state.players.length === 0) seedRoster();
    }
    await saveState();
    try { renderAll(); } catch(e) { console.error('renderAll error:', e); }
  } catch(e) {
    console.error('Error during loadState/seed:', e);
  }

  // Run one-time ID migration before listeners start
  await migratePlayerIds();

  // ALWAYS start Firebase listeners ‚Äî even if loadState or renderAll had issues
  try {
    listenToThisWeek();
    listenToRSVPs();
    listenToGuests();
    listenToPayments();
    listenToLiveScores();
    listenToRoundStatus();
    listenToCourseSetup();
    listenToContests();
    listenToSchedule();
    listenToPairings();
    listenToAllPairings();
    listenToScoringMode();
    listenToGroupScorers();
    listenToMasterCourses();
    listenToWeekResults();
    listenToAnnouncement();
    loadEmailSentFlags();
    initFCM();
    initCapacitorNative();
  } catch(e) {
    console.error('Error setting up Firebase listeners:', e);
  }

  // Load RSVP override state
  try {
    const wnOverride = state.thisWeek.weekNum || 1;
    db.ref('rsvpOverride/' + wnOverride).on('value', (snap) => {
      rsvpOverrideLocked = snap.val() === true;
      updateDeadlineDisplay();
      renderThisWeek();
    });
  } catch(e) { console.error('RSVP override listener error:', e); }

  // Start countdown timer and auto-email checks
  countdownInterval = setInterval(() => {
    try {
      updateDeadlineDisplay();
      emailCheckCounter++;
      if (emailCheckCounter % 30 === 0 && isEditor) {
        checkAutoEmailTriggers();
      }
    } catch(e) { console.error('Timer error:', e); }
  }, 1000);
  try { updateDeadlineDisplay(); } catch(e) { /* ignore */ }

  // Check payment cutoff and auto-pairings after data loads (give listeners time)
  setTimeout(() => {
    try {
      enforcePaymentCutoff();
      autoGeneratePairingsIfNeeded();
    } catch(e) { console.error('Auto-pairings error:', e); }
  }, 3000);

  // Retry any failed syncs when app regains focus
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState !== 'visible') return;
    flushPendingSyncs();
  });
}

/* ‚îÄ‚îÄ‚îÄ Auto-generate pairings after RSVP deadline ‚îÄ‚îÄ‚îÄ */
async function autoGeneratePairingsIfNeeded() {
  if (!isRSVPLocked()) return; // deadline hasn't passed yet
  const wn = state.thisWeek.weekNum || 1;
  // Check if pairings already exist
  const existing = pairingsData[wn];
  if (existing && existing.length > 0) return; // already generated
  // Check if we have confirmed players
  const rsvps = rsvpData[wn] || {};
  const confirmedCount = Object.values(rsvps).filter(v => v === 'yes').length;
  if (confirmedCount === 0) return;
  // Auto-generate
  await generatePairings();
}

// Override the original load
preloadDataIfEmpty().catch(e => console.error('Fatal init error:', e));
</script>

<!-- WhatsApp Floating Button -->
<a href="https://chat.whatsapp.com/F69LUEKZSOSEcHPk6jAje7" target="_blank" rel="noopener noreferrer" class="whatsapp-float" title="FOG WhatsApp Group">
  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
</a>
<span class="whatsapp-label">FOG Group Chat</span>

</body>
</html>
